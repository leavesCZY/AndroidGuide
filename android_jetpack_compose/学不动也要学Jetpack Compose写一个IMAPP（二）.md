> å…¬ä¼—å·ï¼š[å­—èŠ‚æ•°ç»„](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image)
>
> å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

å†ç»ä¸¤å¹´çš„æ‰“ç£¨ï¼Œåœ¨ 2021 å¹´ä¸ƒæœˆåº•çš„æ—¶å€™ï¼ŒGoogle ç»ˆäºå‘å¸ƒäº† Jetpack Compose çš„æ­£å¼ç‰ˆæœ¬ã€‚æˆ‘å¯¹ Jetpack Compose çš„å¾ˆå¤šç‰¹æ€§éƒ½å¾ˆæ„Ÿå…´è¶£ï¼Œä¹Ÿè§‰å¾—å…¶å¾ˆå¯èƒ½ä¼šæˆä¸ºä»¥å Android åŸç”Ÿåº”ç”¨å¼€å‘æ—¶çš„é¦–é€‰æŠ€æœ¯æ–¹æ¡ˆï¼Œæ‰€ä»¥åœ¨æ­£å¼ç‰ˆå‘å¸ƒä¹‹å‰å°±å¼€å§‹äº†ä¸€æ¬¡å®æˆ˜æ¼”ç»ƒï¼ŒèŠ±äº†ä¸¤ä¸ªæœˆæ—¶é—´æ–­æ–­ç»­ç»­å†™äº†ä¸€ä¸ªå®Œå…¨ç”¨ Jetpack Compose å®ç°çš„ IM APPï¼Œå®ç°äº†åŸºæœ¬çš„èŠå¤©åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿå†™äº†ä¸€ç¯‡æ–‡ç« å¯¹å…¶è¿›è¡Œä»‹ç»ï¼š[å­¦ä¸åŠ¨ä¹Ÿè¦å­¦ï¼ŒJetpack Compose å†™ä¸€ä¸ª IM APP](https://juejin.cn/post/6991429231821684773) 

åœ¨æ–‡ç« ä¸­ï¼Œæˆ‘ä»¥ [compose_chat](https://github.com/leavesCZY/compose_chat) ä¸ºä¾‹ï¼Œè¯¦ç»†åœ°ä»‹ç»äº† Jetpack Compose çš„å¾ˆå¤šé‡è¦æ¦‚å¿µå’ŒåŸºç¡€ç‰¹æ€§ï¼ŒåŒ…æ‹¬ï¼š

- å‘½ä»¤å¼ä¸å£°æ˜å¼
- å¯ç»„åˆå‡½æ•°
- çŠ¶æ€
- çŠ¶æ€æå‡
- çº¯å‡½æ•°
- å‰¯ä½œç”¨
- å¸ƒå±€
- åŠ¨ç”» & æ‰‹åŠ¿æ“ä½œ
- ä¸»é¢˜

å½“æ—¶ä¸»è¦ä»‹ç»çš„æ˜¯ Jetpack Compose è¿™ç§æ–°å…´çš„å£°æ˜å¼å¼€å‘å’Œä¼ ç»Ÿ View ä½“ç³»çš„å‘½ä»¤å¼å¼€å‘ä¹‹é—´çš„å·¨å¤§å·®å¼‚æ€§ï¼Œä»¥åŠè¿™ç§å·®å¼‚æ€§éšä¹‹å¸¦æ¥çš„å„ç§å¼€å‘ç†å¿µçš„æ”¹å˜ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè¯¥æ–‡ç« å¯¹äºæ‰“ç®—å­¦ä¹  Jetpack Compose çš„åŒå­¦æ˜¯ä¸€ä»½æŒºå¥½çš„å…¥é—¨æŒ‡å—ï¼Œcompose_chat ä¹Ÿæœ‰åŠ©äºåŒå­¦ä»¬å¿«é€ŸæŒæ¡å¼€å‘å¥—è·¯

åˆ°ç°åœ¨åˆè¿‡äº†æœ‰å‡ ä¸ªæœˆæ—¶é—´ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œæˆ‘å¯¹ compose_chat è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¹¶ä¸”ä¹Ÿæ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œæœ€å¤§çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹å°±æ˜¯å½“å‰å·²ç»æ”¯æŒ **ç¾¤èŠ** åŠŸèƒ½äº†ï¼Œcompose_chat ä¸­é¢„ç•™äº†ä¸‰ä¸ªèŠå¤©ç¾¤ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»ä½“éªŒä¸‹

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbeccad79d94d0dbff85bc02d7ccf04~tplv-k3u1fbpfcp-zoom-1.image)

ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä¸»è¦è®²è§£çš„æ˜¯æ¦‚å¿µï¼Œå¯¹äºå…·ä½“çš„ä»£ç ä»‹ç»å¾—æ¯”è¾ƒå°‘ï¼Œæ­¤ç¯‡æ–‡ç« å°±å†æ¥è¡¥å……å…·ä½“çš„ä»£ç ç»†èŠ‚ï¼Œä»¥åŠä¸€äº›å¯ä»¥å’Œ Jetpack Compose æ— ç¼ç»“åˆä½¿ç”¨çš„ Jetpack åº“å’Œä¸‰æ–¹å¼€æºåº“ã€‚ç”±äºç°åœ¨å…³äº Jetpack Compose çš„å­¦ä¹ èµ„æ–™è¿˜æ¯”è¾ƒå°‘ï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿè®¸æˆ‘ä¹Ÿç†è§£é”™äº†ï¼Œå¦‚æœ‰é”™è¯¯å¸Œæœ›è¯»è€…èƒ½æŒ‡å‡ºæ¥ï¼Œä¹Ÿå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

# ä¸€ã€MutableState

Jetpack Compose é€šè¿‡åµŒå¥—å¤šä¸ªå¯ç»„åˆå‡½æ•°æ¥æè¿°æ•´ä¸ªå±å¹•çŠ¶æ€å¹¶ä»¥æ­¤æ¥ç»˜åˆ¶å±å¹•è§†å›¾ï¼Œè€Œæ›´æ–°è§†å›¾çš„å”¯ä¸€é€”å¾„å°±æ˜¯**ç”Ÿæˆæ–°çš„å…¥å‚å‚æ•°å¹¶å†æ¬¡è°ƒç”¨å¯ç»„åˆå‡½æ•°**ï¼Œæ–°çš„å…¥å‚å‚æ•°å³æˆ‘ä»¬å¸Œæœ›æ›´æ–°åçš„è§†å›¾çŠ¶æ€ Stateï¼Œæ¯å½“ State æ›´æ–°æ—¶å°±ä¼šè§¦å‘å¯ç»„åˆå‡½æ•°è¿›è¡Œé‡ç»„ï¼Œä»è€Œå®ç° UI åˆ·æ–°

ä¸ºäº†è®©ç³»ç»Ÿèƒ½å¤Ÿå¯Ÿè§‰åˆ° State è¢«æ›´æ–°äº†ï¼ŒCompose æä¾›äº† `MutableState<T>` è¿™ç§å¯è§‚å¯Ÿç±»å‹ï¼Œå½“å…¶ value å‘ç”Ÿäº†å˜åŒ–ï¼Œç³»ç»Ÿå°±ä¼šé‡ç»„æ‰€æœ‰ä¾èµ–äºè¯¥å€¼çš„å¯ç»„åˆå‡½æ•°

```kotlin
@Stable
interface MutableState<T> : State<T> {
    override var value: T
    operator fun component1(): T
    operator fun component2(): (T) -> Unit
}
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `mutableStateOf`æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª MutableState

```kotlin
var nickname = mutableStateOf("")
```

`MutableState<T>` å¹¶ä¸æ˜¯ç”¨äºå­˜å‚¨çŠ¶æ€çš„å”¯ä¸€ä¸€ç§æ–¹å¼ï¼Œåƒ LiveDataã€Flowã€RxJava ç­‰å¯è§‚å¯Ÿç±»å‹éƒ½æ˜¯å—æ”¯æŒçš„ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿåœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘é‡ç»„ï¼Œå°±éœ€è¦å°†è¿™äº›ç±»å‹è½¬åŒ–ä¸º `State<T>` ç±»å‹ã€‚Jetpack Compose æä¾›äº†ç›¸åº”çš„è½¬æ¢æ‰©å±•å‡½æ•°ï¼Œä¾‹å¦‚ LiveData å¯¹åº”çš„å°±æ˜¯ `observeAsState()` æ–¹æ³•ï¼ŒFlow å¯¹åº”çš„æ˜¯ `collectAsState()` æ–¹æ³•ï¼Œå®ƒä»¬éƒ½ä¼šåœ¨å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å°±è‡ªåŠ¨è°ƒç”¨ `state.value`

```kotlin
@Composable
fun <T> LiveData<T>.observeAsState(): State<T?> = observeAsState(value)

@Composable
fun <T> StateFlow<T>.collectAsState(
    context: CoroutineContext = EmptyCoroutineContext
): State<T> = collectAsState(value, context)
```

# äºŒã€remember

å¯ç»„åˆå‡½æ•°çš„**æ‰§è¡Œé¡ºåºã€æ‰§è¡Œçº¿ç¨‹ã€ç”šè‡³æ‰§è¡Œæ¬¡æ•°**éƒ½å…·æœ‰å¾ˆå¤§çš„ä¸ç¡®å®šæ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰§è¡ŒåŠ¨ç”»æ—¶ä¸€ä¸ªå¯ç»„åˆå‡½æ•°å¯èƒ½ä¼šåœ¨ä¸€ç§’å†…è¢«æ‰§è¡Œ N å¤šæ¬¡ï¼Œè¿™å°±ä¼šå¯¼è‡´æˆ‘ä»¬å£°æ˜åœ¨å‡½æ•°å†…çš„å¯¹è±¡åœ¨ä¸æ–­åœ°åœ¨è¢«é‡æ–°åˆå§‹åŒ–ï¼Œèµ‹äºˆçš„å€¼ä¹Ÿä¼šä¸¢å¤±

ä¸ºäº†åœ¨ç»„åˆæœŸé—´èƒ½å¤Ÿè®°ä½æŸä¸ªå¯¹è±¡å€¼ï¼Œæ­¤æ—¶å°±éœ€è¦ä½¿ç”¨åˆ° `remember` æ–¹æ³•äº†ã€‚ç³»ç»Ÿä¼šåœ¨åˆå§‹ç»„åˆæœŸé—´å°†ç”± remember æŒ‡å‘çš„å€¼å­˜å‚¨åœ¨ç»„åˆä¸­ï¼Œå¹¶åœ¨é‡ç»„æœŸé—´è¿”å›è¯¥å€¼ï¼Œä»è€Œä¿è¯å€¼ä¸ä¼šä¸¢å¤±ã€‚remember æ—¢å¯ç”¨äºå­˜å‚¨å¯å˜å¯¹è±¡ï¼Œåˆå¯ç”¨äºå­˜å‚¨ä¸å¯å˜å¯¹è±¡

```kotlin
var nickname by remember() {
    mutableStateOf("")
}
```

ä»¥ compose_chat ä¸ºä¾‹ï¼Œä¸ªäººèµ„æ–™ä¿®æ”¹é¡µé¢ HomeDrawerScreen æ˜¯é€šè¿‡ OutlinedTextField æ¥è¾“å…¥å†…å®¹çš„ï¼Œæ­¤æ—¶å°±éœ€è¦åŒæ—¶ä½¿ç”¨åˆ° MutableState å’Œ remember

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d86190406c0547c58795e75e71e23be9~tplv-k3u1fbpfcp-zoom-1.image)

å½“ç”¨æˆ·è¾“å…¥äº†æ–°å†…å®¹æ—¶ï¼Œå°±ä¼šåœ¨ `onValueChange` å›è°ƒé‡Œæ”¹å˜ nicknameï¼Œä»è€Œè§¦å‘ DrawerFrontLayer é‡ç»„ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿåœ¨é‡ç»„æœŸé—´ä¿è¯ nickname çš„å€¼ä¸ä¼šä¸¢å¤±ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ° remember äº†

```kotlin
@Composable
private fun DrawerFrontLayer(
    backdropScaffoldState: BackdropScaffoldState,
    homeScreenDrawerState: HomeScreenDrawerState
) {
    Column() {
        var nickname by remember {
            mutableStateOf(
                homeScreenDrawerState.userProfile.nickname
            )
        }
        CommonOutlinedTextField(
            value = nickname,
            onValueChange = {
                if (it.length > 16) {
                    return@CommonOutlinedTextField
                }
                nickname = it
            },
            label = "nickname"
        )
    }
}
```

**remember èƒ½å¤Ÿä¿è¯å€¼ä¸ä¼šä¸¢å¤±ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›è¯¥å€¼èƒ½å¤Ÿä¸»åŠ¨æ›´æ–°è‡ªèº«**

ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·è¾“å…¥äº†æ–°å†…å®¹åï¼Œnickname å°±è¢«æ”¹å˜äº†ï¼Œè§†å›¾ä¸Šå°±ä¼šä¸€ç›´æ˜¾ç¤ºç€ä¿®æ”¹åçš„å€¼ã€‚ä½†æ­¤æ—¶ç”¨æˆ·å¹¶æ²¡æœ‰ä¿å­˜è®¾ç½®ï¼Œæ‰€ä»¥å°±ä¼šä¸€ç›´æ˜¾ç¤ºç€éçœŸå®æ˜µç§°ï¼Œå°±åƒä¸‹å›¾æ‰€ç¤º

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0570ab625b4bba83b25611d4cbd579~tplv-k3u1fbpfcp-zoom-1.image)

è€Œæˆ‘å¸Œæœ›è¾¾åˆ°çš„æ•ˆæœæ˜¯ï¼Œå½“è¯¥æµ®å±‚è¢«å…³é—­åï¼Œnickname å°±èƒ½å¤Ÿè¢«é‡ç½®ä¸ºç”¨æˆ·çš„çœŸå®æ˜µç§°ï¼Œè€Œé**è„æ•°æ®**ã€‚æ­¤æ—¶å°±å¯ä»¥é€šè¿‡ä¸º remember æ–¹æ³•æ·»åŠ  key å‚æ•°æ¥è¾¾åˆ°è¯¥æ•ˆæœäº†ï¼Œremember æ–¹æ³•æ”¯æŒä¼ å…¥å¤šä¸ª key å‚æ•°ï¼Œå½“æŸä¸ª key å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šé‡ç½®è‡ªèº«é‡æ–°åˆå§‹åŒ–

ä¾‹å¦‚ï¼Œä»¥ä¸‹çš„ nickname å°±ä»¥æµ®å±‚çš„æ˜¾ç¤ºçŠ¶æ€ `backdropScaffoldState.isRevealed` ä½œä¸ºäº† key ä¹‹ä¸€ï¼Œå½“æµ®å±‚è¢«å…³é—­æ—¶ï¼Œkey ä» true å˜æˆäº† falseï¼Œå°±ä¼šè§¦å‘ nickname é‡æ–°åˆå§‹åŒ–ï¼Œä»è€Œä¸¢å¼ƒä¹‹å‰è¾“å…¥çš„å€¼

```kotlin
@Composable
private fun DrawerFrontLayer(
    backdropScaffoldState: BackdropScaffoldState,
    homeScreenDrawerState: HomeScreenDrawerState
) {
    Column() {
        var nickname by remember(
            key1 = backdropScaffoldState.isRevealed,
            key2 = homeScreenDrawerState
        ) {
            mutableStateOf(
                homeScreenDrawerState.userProfile.nickname
            )
        }
        CommonOutlinedTextField(
            value = nickname,
            onValueChange = {
                if (it.length > 16) {
                    return@CommonOutlinedTextField
                }
                nickname = it
            },
            label = "nickname"
        )
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3eed7eed8174de9b273d823264267f5~tplv-k3u1fbpfcp-zoom-1.image)

# ä¸‰ã€CompositionLocal

é€šå¸¸æƒ…å†µä¸‹ï¼Œæ•°æ®æ˜¯ä»¥ä¼ é€’å‚æ•°çš„å½¢å¼åœ¨æ•´ä¸ªè§†å›¾æ ‘çš„å¯ç»„åˆå‡½æ•°ä¹‹é—´è¿›è¡Œæµè½¬çš„

ä¾‹å¦‚ï¼Œä¸ºäº†è®¾å®š TextLabel æ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹å’Œæ–‡æœ¬é¢œè‰²ï¼Œå°±éœ€è¦ ChatApp ä¸»åŠ¨å‘å…¶ä¼ é€’æ˜ç¡®çš„å‚æ•°å€¼ã€‚è¿™ç§æ•°æ®ä¼ é€’å½¢å¼ä¹Ÿç¬¦åˆ Jetpack Compose çš„ç¼–ç åŸåˆ™ï¼š**ä¸€ä¸ªåˆæ ¼çš„å¯ç»„åˆå‡½æ•°å°±åº”è¯¥å±äºçº¯å‡½æ•°ï¼Œå¹‚ç­‰ä¸”æ²¡æœ‰å‰¯ä½œç”¨**

```kotlin
@Composable
fun ChatApp() {
    val colors = lightColors()
    TextLabel(labelText = "compose_chat", color = colors.primary)
}

@Composable
fun TextLabel(labelText: String, color: Color) {
    Text(
        text = labelText,
        color = color
    )
}
```

ä½†è¿™ç§æ–¹å¼åœ¨åº”å¯¹æŸäº›æƒ…å†µæ—¶å°±ä¼šæ˜¾å¾—å¾ˆéº»çƒ¦

ä¾‹å¦‚ï¼Œä¸€ä¸ªåº”ç”¨çš„ä¸»é¢˜éƒ½æ˜¯æœ‰ç€æ˜ç¡®çš„è§„èŒƒçš„ï¼ŒåŒ…æ‹¬æ–‡æœ¬å¤§å°ã€æ–‡æœ¬é¢œè‰²ã€é˜´å½±æ•ˆæœã€åœ†è§’å¼§åº¦ç­‰ï¼Œè¿™ç±»å±æ€§å€¼å…¨å±€ç»Ÿä¸€ä¸”å‘ç”Ÿå˜åŒ–çš„æ¦‚ç‡å¾ˆä½ï¼Œå¦‚æœè°ƒç”¨æ¯ä¸ªå¯ç»„åˆå‡½æ•°éƒ½éœ€è¦æ˜¾å¼ä¼ é€’è¿™äº›å±æ€§å€¼çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—å‡½æ•°çš„è°ƒç”¨æˆæœ¬éå¸¸é«˜

Jetpack Compose æä¾›äº† CompositionLocal æ¥åº”å¯¹è¿™ç§æƒ…å†µï¼Œé€šè¿‡ç»„åˆæ¥éšå¼å‘ä¸‹ä¼ é€’æ•°æ®ã€‚CompositionLocal å…ƒç´ åœ¨è§†å›¾æ ‘çš„æŸä¸ªèŠ‚ç‚¹ä»¥å€¼çš„å½¢å¼å‘å†…æä¾›ï¼Œä¾›æ‰€æœ‰å†…åµŒçš„å¯ç»„åˆå‡½æ•°éšå¼ä½¿ç”¨ï¼Œè€Œæ— éœ€åœ¨å¯ç»„åˆå‡½æ•°ä¸­å°† CompositionLocal æ˜¾å¼å£°æ˜ä¸ºå‚æ•°ï¼Œä¸”æ¯ä¸ªå¯ç»„åˆå‡½æ•°éƒ½ä¼šä½¿ç”¨ç¦»è‡ªå·±æœ€è¿‘çš„ CompositionLocal å…ƒç´ 

ä»¥å®˜æ–¹æä¾›çš„ä»£ç ä¸ºä¾‹ã€‚LocalContentAlpha ç”¨äºå®šä¹‰å†…åµŒå†…å®¹çš„ Alpha å€¼ï¼ŒColumn å°±é€šè¿‡ CompositionLocal åˆ’åˆ†ä¸ºäº†ä¸‰ç§ä¸åŒçš„ Alpha å±‚æ¬¡ï¼šé»˜è®¤é€æ˜åº¦ã€mediumã€disabled

```kotlin
@Composable
fun CompositionLocalExample() {
    MaterialTheme {
        Column {
            Text("Uses MaterialTheme's provided alpha")
            CompositionLocalProvider(LocalContentAlpha provides ContentAlpha.medium) {
                Text("Medium value provided for LocalContentAlpha")
                Text("This Text also uses the medium value")
                CompositionLocalProvider(LocalContentAlpha provides ContentAlpha.disabled) {
                    Text("This Text uses the disabled alpha now")
                }
            }
        }
    }
}
```

æœ€ç»ˆçš„æ–‡æœ¬å†…å®¹å°±ä¼šåŒ…å«ä¸‰ç§ä¸åŒçš„é€æ˜åº¦

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/70d0c0cb17d147be9da344931a7404c6~tplv-k3u1fbpfcp-zoom-1.image)

Jetpack Compose çš„ä¸»é¢˜ä¹Ÿæ˜¯é€šè¿‡ CompositionLocal æ¥å®ç°çš„ã€‚ä»¥ compose_chat ä¸ºä¾‹ï¼Œå…¶ä¸»é¢˜ç”± ChatTheme æ¥å®šä¹‰ï¼ŒåŒ…å«ä¸‰ç§åŸºæœ¬çš„ä¸»é¢˜å±æ€§ï¼Œå³ï¼šé¢œè‰² colorsã€æ’ç‰ˆ typographyã€å½¢çŠ¶ shapesï¼Œè¿™äº›å±æ€§ä¼šè‡ªåŠ¨åæ˜ åœ¨æ‰€æœ‰ç”¨æ¥æ„å»ºåº”ç”¨çš„ç»„ä»¶ä¸­ï¼Œå¯ç»„åˆå‡½æ•°ä¹Ÿå¯ä»¥ä¸»åŠ¨è¯»å–ä¸Šå±‚è§†å›¾èµ‹äºˆçš„å±æ€§

è€Œæ•´ä¸ªåº”ç”¨éƒ½åŒ…è£¹åœ¨ ChatTheme å†…éƒ¨ä¸­ï¼Œå†…éƒ¨çš„å¯ç»„åˆå‡½æ•°å¯ä»¥é€šè¿‡ `MaterialTheme.shapes.large` çš„æ–¹å¼æ¥ç›´æ¥è·å– ChatTheme ä¸­å®šä¹‰çš„å±æ€§å€¼ï¼Œé¿å…äº†æ˜¾å¼çš„å‚æ•°ä¼ é€’

```kotlin
@Composable
fun ChatTheme(
    appTheme: AppTheme,
    content: @Composable () -> Unit
) {
    val colors = ...
    val typography = ... 
    val shapes = ...
    MaterialTheme(
        colors = colors,
        typography = typography,
        shapes = shapes,
        content = content
    )
}

ChatTheme {
    Text(
        text = "compose_chat",
        modifier = Modifier.clip(shape = MaterialTheme.shapes.large),
        color = MaterialTheme.colors.secondary,
        style = MaterialTheme.typography.body1,
    )
}
```

é€šè¿‡æŸ¥çœ‹ MaterialTheme æ–¹æ³•çš„æºç å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬ä¼ é€’çš„ colors éƒ½ä¼šè¢«ä¿å­˜åœ¨ LocalColors ä¸­ï¼Œè€Œ MaterialTheme.colors å¼•ç”¨çš„æ­£æ˜¯ LocalColorsã€‚é€šè¿‡å°†ä»£è¡¨æ•´ä¸ªåº”ç”¨çš„æœ€é«˜å±‚çº§å¯ç»„åˆå‡½æ•°åŒ…è£¹åœ¨ MaterialTheme ä¸­ï¼Œæ‰€æœ‰å†…åµŒçš„å¯ç»„åˆå‡½æ•°å°±éƒ½éšå¼åŒ…å«äº†ä¸€æ•´å¥—ç»Ÿä¸€çš„ä¸»é¢˜ï¼Œå³é¿å…äº†æ˜¾å¼çš„å‚æ•°ä¼ é€’ï¼Œä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ¥è°ƒæ•´æ•´ä¸ªåº”ç”¨çš„ä¸»é¢˜é…ç½®

```kotlin
@Composable
fun MaterialTheme(
    colors: Colors = MaterialTheme.colors,
    typography: Typography = MaterialTheme.typography,
    shapes: Shapes = MaterialTheme.shapes,
    content: @Composable () -> Unit
) {
    val rememberedColors = remember {
        // Explicitly creating a new object here so we don't mutate the initial [colors]
        // provided, and overwrite the values set in it.
        colors.copy()
    }.apply { updateColorsFrom(colors) }
    val rippleIndication = rememberRipple()
    val selectionColors = rememberTextSelectionColors(rememberedColors)
    CompositionLocalProvider(
        LocalColors provides rememberedColors,
        LocalContentAlpha provides ContentAlpha.high,
        LocalIndication provides rippleIndication,
        LocalRippleTheme provides MaterialRippleTheme,
        LocalShapes provides shapes,
        LocalTextSelectionColors provides selectionColors,
        LocalTypography provides typography
    ) {
        ProvideTextStyle(value = typography.body1) {
            PlatformMaterialTheme(content)
        }
    }
}

internal val LocalColors = staticCompositionLocalOf { lightColors() }

object MaterialTheme {

    val colors: Colors
        @Composable
        @ReadOnlyComposable
        get() = LocalColors.current

    val typography: Typography
        @Composable
        @ReadOnlyComposable
        get() = LocalTypography.current

    val shapes: Shapes
        @Composable
        @ReadOnlyComposable
        get() = LocalShapes.current
}
```

åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»¿ç…§ MaterialTheme çš„åšæ³•ï¼Œä¸ºè‡ªå®šä¹‰çš„å¯ç»„åˆå‡½æ•°æä¾›è·å–æŸäº›ç³»ç»Ÿèµ„æºçš„å…¥å£ï¼Œä¾‹å¦‚å¯ä»¥ç”¨æ¥è·å–ç³»ç»Ÿé”®ç›˜ï¼Œå³ä»¥ä¸‹çš„ LocalInputMethodManager

```kotlin
val LocalInputMethodManager = staticCompositionLocalOf<InputMethodManager> {
    error("CompositionLocal InputMethodManager not present")
}

@Composable
fun ProvideInputMethodManager(content: @Composable () -> Unit) {
    val context = LocalContext.current
    val inputMethodManager = remember {
        context.getSystemService(
            Context.INPUT_METHOD_SERVICE
        ) as InputMethodManager
    }
    CompositionLocalProvider(LocalInputMethodManager provides inputMethodManager) {
        content()
    }
}

@Composable
fun ChatScreen() {
    ProvideInputMethodManager {
        val inputMethodManager = LocalInputMethodManager.current
        //TODO
    }
}
```

# å››ã€ViewModel

åœ¨ Jetpack Compose ä¸­ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡å¤„ç†é€»è¾‘åº”è¯¥éƒ½æ˜¯æ”¾åœ¨ ViewModel ä¸­çš„ï¼Œå¯ç»„åˆå‡½æ•°ä¸åº”è¯¥åŒ…å«ä»»ä½•ä¸šåŠ¡å¤„ç†é€»è¾‘ï¼Œè€Œåº”è¯¥åªæ ¹æ®å…¥å‚å‚æ•°çš„å˜åŒ–æ¥è¿›è¡Œè§†å›¾æ›´æ–°

ä¸ºäº†èƒ½å¤Ÿåœ¨å¯ç»„åˆå‡½æ•°ä¸­**åˆ›å»º**æˆ–è€…æ˜¯**æ‹¿åˆ°å·²æœ‰çš„** ViewModel å®ä¾‹ï¼Œä¸€ä¸ªå¿…è¦çš„å‰æå°±æ˜¯å½“å‰å¯ç»„åˆå‡½æ•°è¦æ‹¥æœ‰ ViewModelStoreOwner å®ä¾‹ï¼Œä¸¤è€…çš„å…³ç³»å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š[ä»æºç çœ‹ Jetpackï¼ˆ6ï¼‰-ViewModel æºç è¯¦è§£](https://juejin.cn/post/6873356946896846856) 

ç®€å•æ¥è¯´å°±æ˜¯ ViewModel éœ€è¦ä¾é  ViewModelStoreOwner æ¥åˆ›å»ºå’Œå­˜å‚¨ï¼Œæ‰€æœ‰ ViewModel å®ä¾‹éƒ½éœ€è¦ä¿å­˜åœ¨ ViewModelStoreOwner ä¸­ï¼Œè¯¦æƒ…å¯ä»¥å»çœ‹æˆ‘çš„æºç è§£è¯»æ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°

Compose åŒ…ä¸­æä¾›äº†ä¸€ä¸ªå…³äº ViewModel çš„æ‰©å±•å‡½æ•° `viewModel`ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨å¯ç»„åˆå‡½æ•°ä¸­æ¥è·å– ViewModel å®ä¾‹ï¼Œå°±åƒä»¥ä¸‹è¿™æ ·

```kotlin
class LoginViewModel() : ViewModel()

@Composable
fun LoginScreen(navController: NavHostController) {
    val loginViewModel = viewModel<LoginViewModel>()
}
```

ä»æºç å¯ä»¥çœ‹å‡º `viewModel`æ–¹æ³•ä¹Ÿæ˜¯ä¾é  CompositionLocal æ¥è·å– ViewModelStoreOwner å®ä¾‹çš„ã€‚Compose åœ¨ Activity åˆ›å»ºæ—¶å°±è‡ªåŠ¨ä¸º LocalViewModelStoreOwner èµ‹å€¼äº†ï¼Œé»˜è®¤å€¼å°±æ˜¯å’Œ Activity ç›¸å…³è”çš„ ViewModelStoreOwner

```kotlin
@Composable
public inline fun <reified VM : ViewModel> viewModel(
    viewModelStoreOwner: ViewModelStoreOwner = checkNotNull(LocalViewModelStoreOwner.current) {
        "No ViewModelStoreOwner was provided via LocalViewModelStoreOwner"
    },
    key: String? = null,
    factory: ViewModelProvider.Factory? = null
): VM = viewModel(VM::class.java, viewModelStoreOwner, key, factory)

@Composable
public fun <VM : ViewModel> viewModel(
    modelClass: Class<VM>,
    viewModelStoreOwner: ViewModelStoreOwner = checkNotNull(LocalViewModelStoreOwner.current) {
        "No ViewModelStoreOwner was provided via LocalViewModelStoreOwner"
    },
    key: String? = null,
    factory: ViewModelProvider.Factory? = null
): VM = viewModelStoreOwner.get(modelClass, key, factory)
```

æ­¤å¤–ï¼Œå¦‚æœæˆ‘ä»¬è¦è·å–çš„æ˜¯åŒ…å«æ„é€ å‚æ•°çš„ ViewModel å®ä¾‹çš„è¯ï¼Œé‚£å°±éœ€è¦ä¸»åŠ¨ä¼ å…¥ `ViewModelProvider.Factory` å‚æ•°äº†ï¼Œå°±åƒä»¥ä¸‹è¿™æ ·

```kotlin
class ChatViewModel(private val chat: Chat) : ViewModel()

@Composable
fun ChatScreen(chat: Chat) {
    val chatViewModel = viewModel<ChatViewModel>(factory = object :
        ViewModelProvider.NewInstanceFactory() {
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            return ChatViewModel(chat = chat) as T
        }
    })
}
```

æ­¤æ–¹æ³•å®Œå…¨å¯è¡Œï¼Œä½†ä¹Ÿå­˜åœ¨æ¨¡æ¿ä»£ç ï¼Œå› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ NewInstanceFactoryï¼Œä¸”éƒ½éœ€è¦è¿›è¡Œç±»å‹å¼ºè½¬ï¼ŒåŒºåˆ«åªåœ¨äºå®ä¾‹åŒ– ViewModel çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `viewModel` æ–¹æ³•çš„åŸºç¡€ä¸Šå†å°è£…ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼Œç®€åŒ–ä»£ç 

```kotlin
@Composable
inline fun <reified VM : ViewModel> viewModelInstance(crossinline create: () -> VM): VM =
    viewModel(factory = object : ViewModelProvider.NewInstanceFactory() {
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            return create() as T
        }
    })
```

æœ€ç»ˆä»…éœ€è¦å£°æ˜å®ä¾‹åŒ– ViewModel çš„è¿‡ç¨‹å³å¯ï¼ŒèŠ‚çœäº†å¾ˆå¤šä»£ç é‡

```kotlin
@Composable
fun ChatScreen(
    navController: NavHostController,
    listState: LazyListState,
    chat: Chat
) {
    val chatViewModel1 = viewModelInstance {
        ChatViewModel(chat = chat)
    }
}
```

# äº”ã€OnBackPressedDispatcher

OnBackPressedDispatcher æ˜¯ `androidx.activity:activity` åŒ…ä¸­æä¾›çš„ä¸€å¥—ç”¨äºå®ç°æ‹¦æˆªè¿”å›é”®äº‹ä»¶çš„æœºåˆ¶ï¼Œåœ¨ Jetpack Compose ä¸­ä¹Ÿæœ‰ç€åº”ç”¨

ä»¥ compose_chat ä¸ºä¾‹ï¼Œåœ¨ä¸»ç•Œé¢ HomeScreen ä¸­æä¾›äº†ä¸€ä¸ªç”¨äº**æ·»åŠ å¥½å‹å’Œå…¥ç¾¤**çš„æ‚¬æµ®å¼¹çª— HomeScreenSheetContentï¼Œå½“æ‚¬æµ®å¼¹çª—å¤„äºå¯è§çŠ¶æ€æ—¶ï¼Œç”±äº HomeScreen å’Œ HomeScreenSheetContent æ˜¯ä¸€ä½“çš„ï¼Œå½“ç‚¹å‡»è¿”å›é”®æ—¶ï¼Œæ•´ä¸ª Activity å°±ä¼šç›´æ¥é€€å‡º

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e335193a241344d6b2a11721fec7bedb~tplv-k3u1fbpfcp-zoom-1.image)

è€Œæˆ‘æƒ³è¦çš„æ•ˆæœæ˜¯ï¼šå½“æ‚¬æµ®å¼¹çª—å¤„äºå¯è§çŠ¶æ€æ—¶ï¼Œç‚¹å‡»è¿”å›é”®åªä¼šè®©æ‚¬æµ®å¼¹çª—éšè—ï¼Œåœ¨ä¸å¯è§çŠ¶æ€ä¸‹ç‚¹å‡»è¿”å›é”®æ‰å…è®¸ç›´æ¥é€€å‡º Activity

æ­¤æ—¶å°±éœ€è¦ä¾é  OnBackPressedDispatcher æ¥ä¸»åŠ¨æ‹¦æˆªè¿”å›äº‹ä»¶äº†ï¼ŒCompose åŒ…ä¸­å¯¹åº”çš„å°±æ˜¯ BackHandler æ–¹æ³•

å½“ HomeScreenSheetContent å¤„äºå¯è§çŠ¶æ€ï¼Œå³ `modalBottomSheetState.isVisible` ä¸º true æ—¶å°±ä¼šå¯¹è¿”å›äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼Œåœ¨ `onBack` å›è°ƒé‡Œå°† HomeScreenSheetContent ä¸€æ­¥æ­¥ç½®ä¸ºäº† Hidden çŠ¶æ€ï¼Œå½“ HomeScreenSheetContent è¢«éšè—åä¹Ÿä¼šåŒæ—¶å–æ¶ˆæ‹¦æˆª

```kotlin
@Composable
fun HomeScreenSheetContent(
    homeScreenSheetContentState: HomeScreenSheetContentState,
) {
    val coroutineScope = rememberCoroutineScope()
    
    fun expandSheetContent(targetValue: ModalBottomSheetValue) {
        coroutineScope.launch {
            homeScreenSheetContentState.modalBottomSheetState.animateTo(targetValue = targetValue)
        }
    }

    BackHandler(enabled = homeScreenSheetContentState.modalBottomSheetState.isVisible, onBack = {
        when (homeScreenSheetContentState.modalBottomSheetState.currentValue) {
            ModalBottomSheetValue.Hidden -> {

            }
            ModalBottomSheetValue.Expanded -> {
                expandSheetContent(targetValue = ModalBottomSheetValue.HalfExpanded)
            }
            ModalBottomSheetValue.HalfExpanded -> {
                expandSheetContent(targetValue = ModalBottomSheetValue.Hidden)
            }
        }
    })
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8ab7ba234104373b3787efb1d2d348d~tplv-k3u1fbpfcp-zoom-1.image)

ä»æºç å¯ä»¥çœ‹å‡ºæ¥ BackHandler æ–¹æ³•å…¶å®å°±æ˜¯å¯¹ OnBackPressedDispatcherOwner æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒé€šçŸ¥ï¼Œåœ¨ enabled ä¸º true çš„æ—¶å€™å°±è´Ÿè´£è°ƒç”¨æˆ‘ä»¬ä¼ å…¥çš„ `onBack` æ–¹æ³•

```kotlin
@Composable
public fun BackHandler(enabled: Boolean = true, onBack: () -> Unit) {
    // Safely update the current `onBack` lambda when a new one is provided
    val currentOnBack by rememberUpdatedState(onBack)
    // Remember in Composition a back callback that calls the `onBack` lambda
    val backCallback = remember {
        object : OnBackPressedCallback(enabled) {
            override fun handleOnBackPressed() {
                currentOnBack()
            }
        }
    }
    // On every successful composition, update the callback with the `enabled` value
    SideEffect {
        backCallback.isEnabled = enabled
    }
    val backDispatcher = checkNotNull(LocalOnBackPressedDispatcherOwner.current) {
        "No OnBackPressedDispatcherOwner was provided via LocalOnBackPressedDispatcherOwner"
    }.onBackPressedDispatcher
    val lifecycleOwner = LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner, backDispatcher) {
        // Add callback to the backDispatcher
        backDispatcher.addCallback(lifecycleOwner, backCallback)
        // When the effect leaves the Composition, remove the callback
        onDispose {
            backCallback.remove()
        }
    }
}
```

# å…­ã€Effect API

åœ¨å¾ˆå¤šè®²è§£å…³äºç¨‹åºè®¾è®¡æœ€ä½³å®è·µçš„æ–‡ç« æˆ–è€…ä¹¦ç±é‡Œï¼Œéƒ½ä¼šæ¨èä¸€ä¸ªç¼–ç åŸåˆ™ï¼š**å°½å¯èƒ½ä½¿ç”¨ valã€ä¸å¯å˜å¯¹è±¡åŠçº¯å‡½æ•°æ¥è®¾è®¡ç¨‹åº**ã€‚è¿™ä¸ªåŸåˆ™åœ¨ Jetpack Compose ä¸­ä¹ŸåŒæ ·éœ€è¦éµå®ˆï¼Œå› ä¸ºä¸€ä¸ªåˆæ ¼çš„å¯ç»„åˆå‡½æ•°å°±åº”è¯¥å±äº**çº¯å‡½æ•°**ï¼Œå¹‚ç­‰ä¸”æ²¡æœ‰å‰¯ä½œç”¨

ä½•è°“çº¯å‡½æ•°ï¼Ÿå‡å¦‚ä¸€ä¸ªå‡½æ•°ä½¿ç”¨ç›¸åŒçš„å…¥å‚å‚æ•°é‡å¤æ‰§è¡Œæ—¶ï¼Œæ€»æ˜¯èƒ½è·å¾—ç›¸åŒçš„è¿è¡Œç»“æœï¼Œä¸”è¿è¡Œç»“æœä¸ä¼šå½±å“ä»»ä½•å¤–éƒ¨çŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹å¤–éƒ¨é€ æˆæ”¹å˜ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ç§°ä¸ºçº¯å‡½æ•°

çº¯å‡½æ•°ä¸å…·å¤‡å‰¯ä½œç”¨ï¼Œå…·æœ‰å¼•ç”¨é€æ˜æ€§ã€‚å‰¯ä½œç”¨å°±æ˜¯æŒ‡ä¿®æ”¹äº†æŸå¤„çš„æŸäº›ä¸œè¥¿ï¼Œæ¯”å¦‚ï¼š

- å¼•ç”¨æˆ–ä¿®æ”¹äº†å¤–éƒ¨å˜é‡çš„å€¼
- æ‰§è¡Œäº† IO æ“ä½œï¼Œæ¯”å¦‚è¯»å†™äº† SharedPreferences
- æ‰§è¡Œäº† UI æ“ä½œï¼Œæ¯”å¦‚ä¿®æ”¹äº†ä¸€ä¸ªæŒ‰é’®çš„å¯æ“ä½œçŠ¶æ€

ä»¥ä¸‹ä¾‹å­å°±ä¸å±äºçº¯å‡½æ•°ï¼Œç”±äºå—åˆ°å¤–éƒ¨å˜é‡çš„å½±å“ï¼Œä½¿ç”¨ç›¸åŒå…¥å‚å‚æ•°å¤šæ¬¡æ‰§è¡Œ count å‡½æ•°çš„ç»“æœå¹¶ä¸å…¨éƒ¨ç›¸åŒï¼Œä¸”æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šå½±å“åˆ°å¤–éƒ¨ç¯å¢ƒï¼ˆä½¿ç”¨åˆ°äº† println å‡½æ•°ï¼‰ï¼Œè¿™äº›éƒ½å±äºå‰¯ä½œç”¨

```kotlin
var count = 1

fun count(x: Int): Int {
    count += x
    println(count)
    return count
}
```

ä½¿ç”¨ Jetpack Compose æ—¶éœ€è¦æ³¨æ„ï¼š

- å¯ç»„åˆå‡½æ•°å¯ä»¥æŒ‰ä»»ä½•é¡ºåºæ‰§è¡Œ
- å¯ç»„åˆå‡½æ•°å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
- é‡ç»„ä¼šè·³è¿‡å°½å¯èƒ½å¤šçš„å¯ç»„åˆå‡½æ•°å’Œ lambda
- é‡ç»„æ˜¯ä¹è§‚çš„æ“ä½œï¼Œå¯èƒ½ä¼šè¢«å–æ¶ˆ
- å¯ç»„åˆå‡½æ•°å¯èƒ½ä¼šåƒåŠ¨ç”»çš„æ¯ä¸€å¸§ä¸€æ ·éå¸¸é¢‘ç¹åœ°è¿è¡Œ

ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ç»„åˆå‡½æ•°æ— æ³•åšåˆ°å®Œå…¨æ— å‰¯ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨åˆ‡æ¢åº”ç”¨ä¸»é¢˜çš„æ—¶å€™å¸Œæœ›ç³»ç»ŸçŠ¶æ€æ ä¹Ÿèƒ½è·Ÿç€ä¸€èµ·æ”¹å˜èƒŒæ™¯è‰²ï¼Œæ­¤æ—¶å°±è¯´å¯ç»„åˆå‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼ŒJetpack Compose æä¾›äº† Effect APIï¼Œä»¥ä¾¿ä»¥å¯é¢„æµ‹çš„æ–¹å¼æ‰§è¡Œè¿™äº›é™„å¸¦æ•ˆåº”ï¼Œé¿å…é™„å¸¦æ•ˆåº”ä»¥ä¸å®‰å…¨çš„å½¢å¼è¢«è¿‡åº¦æ‰§è¡Œ

ä¸‹é¢å°±æ¥ä»‹ç»ä¸€äº›æ¯”è¾ƒå¸¸è§çš„ Effect API

## LaunchedEffect

LaunchedEffect ç”¨äºåœ¨å¯ç»„åˆå‡½æ•°ä¸­å®‰å…¨åœ°è°ƒç”¨åç¨‹ã€‚å½“ LaunchedEffect è¿›å…¥ç»„åˆæ—¶ï¼Œå®ƒä¼šé€šè¿‡ CoroutineScope.launch å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶å°†å¼€å‘è€…å£°æ˜çš„ä»£ç å—ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥åç¨‹è¿›è¡Œæ‰§è¡Œã€‚å½“ LaunchedEffect é€€å‡ºç»„åˆæ—¶ï¼Œå¯åŠ¨çš„åç¨‹ä¹Ÿä¼šè¢«å–æ¶ˆï¼Œä»è€Œä¿è¯äº†å®‰å…¨æ€§ã€‚åŒæ—¶ LaunchedEffect ä¹Ÿæ”¯æŒå’Œå¤šä¸ª key è¿›è¡Œç»‘å®šï¼Œå½“ key å‘ç”Ÿå˜åŒ–æ—¶å°±ä¼šå–æ¶ˆç°æœ‰åç¨‹å¹¶é‡æ–°å¯åŠ¨

compose_chat åœ¨å¤šä¸ªåœ°æ–¹ä¸­éƒ½ä½¿ç”¨åˆ°äº† LaunchedEffectï¼Œä¾‹å¦‚åœ¨ HomeActivity ä¸­å°±é€šè¿‡ LaunchedEffect å¯åŠ¨äº†ä¸€ä¸ªåç¨‹ç”¨æ¥ç›‘æµ‹å½“å‰è´¦å·çš„çŠ¶æ€ serverConnectStateï¼Œå½“è´¦å·è¢«æŒ¤ä¸‹çº¿æ—¶å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»é™†é¡µé¢

```kotlin
class HomeActivity : ComponentActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        WindowCompat.setDecorFitsSystemWindows(window, false)
        setContent {
            val appViewModel = viewModel<AppViewModel>()
            val navController = rememberAnimatedNavController()
            LaunchedEffect(key1 = Unit) {
                withContext(Dispatchers.Main) {
                    appViewModel.serverConnectState.collect {
                        when (it) {
                            ServerState.KickedOffline -> {
                                showToast("æœ¬è´¦å·å·²åœ¨å…¶å®ƒå®¢æˆ·ç«¯ç™»é™†ï¼Œè¯·é‡æ–°ç™»é™†")
                                AccountCache.onUserLogout()
                                navController.navToLogin()
                            }
                            ServerState.Logout -> {
                                navController.navToLogin()
                            }
                            else -> {
                                showToast("Connect State Changed : $it")
                            }
                        }
                    }
                }
            }
        }
    }
    
}
```

## rememberCoroutineScope

ç”±äº LaunchedEffect æ˜¯å¯ç»„åˆå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æ³•åœ¨å¯ç»„åˆå‡½æ•°ä¹‹å¤–æ¥ä½¿ç”¨å®ƒã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨å¯ç»„åˆå‡½æ•°ä¹‹å¤–å®‰å…¨åœ°ä½¿ç”¨åç¨‹ï¼Œæ­¤æ—¶å°±éœ€è¦ç”¨åˆ° `rememberCoroutineScope` æ–¹æ³•äº†ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª CoroutineScopeï¼Œè¯¥ä½œç”¨åŸŸå­˜åœ¨ç”Ÿå‘½å‘¨æœŸçš„é™åˆ¶ï¼Œå½“å¯ç»„åˆå‡½æ•°é€€å‡ºç»„åˆæ—¶å°±ä¼šå–æ¶ˆæ‰€æœ‰å¯åŠ¨çš„åç¨‹ï¼Œä¿è¯äº†å®‰å…¨æ€§

ä¾‹å¦‚ï¼Œcompose_chat åœ¨ç¾¤èµ„æ–™é¡µ GroupProfileScreen ä¸­å°±ä½¿ç”¨åˆ°äº† `rememberCoroutineScope` æ–¹æ³•ï¼Œ`quitGroup` å›è°ƒå±äºä¸€ä¸ªæ™®é€šçš„ lambda æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ LaunchedEffectï¼Œå› æ­¤å›è°ƒä¸­å°±é€šè¿‡ coroutineScope æ¥è°ƒç”¨ GroupProfileViewModel ä¸­çš„ suspend æ–¹æ³•

```kotlin
@Composable
fun GroupProfileScreen(
    navController: NavHostController,
    groupId: String
) {
    val groupProfileViewModel = viewModelInstance {
        GroupProfileViewModel(groupId = groupId)
    }
    val coroutineScope = rememberCoroutineScope()
    Scaffold(
        modifier = Modifier
            .fillMaxSize(),
    ) {
        Box {
            GroupProfileScreenTopBar(quitGroup = {
                coroutineScope.launch {
                    when (val result = groupProfileViewModel.quitGroup()) {
                        ActionResult.Success -> {
                            showToast("å·²é€€å‡ºç¾¤èŠ")
                            navController.navToHomeScreen()
                        }
                        is ActionResult.Failed -> {
                            showToast(result.reason)
                        }
                    }
                }
            })
        }
    }
}
```

## snapshotFlow

snapshotFlow ç”¨äºå°†ä»»æ„åŒ…å«è¿”å›å€¼çš„ä»£ç å—è½¬æ¢ä¸ºå†· flowï¼Œå½“åˆ¤æ–­åˆ°å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œflow å°±ä¼šå‘æ”¶é›†å™¨å‘å‡ºæ–°å€¼

ä¾‹å¦‚ï¼Œcompose_chat çš„ä¾§è¾¹æ  HomeScreenDrawer å°±é€šè¿‡ snapshotFlow æ¥è‡ªåŠ¨å…³é—­ä¿®æ”¹ç”¨æˆ·èµ„æ–™çš„æ‚¬æµ®çª— DrawerFrontLayer ã€‚å½“åˆ¤æ–­åˆ° HomeScreenDrawer è¢«å…³é—­äº†ä¸” DrawerFrontLayer å¤„äºæ˜¾ç¤ºçŠ¶æ€æ—¶ï¼Œå°±ä¼šä¸»åŠ¨éšè— DrawerFrontLayer

```kotlin
@Composable
fun HomeScreenDrawer(homeScreenDrawerState: HomeScreenDrawerState) {
    val drawerState = homeScreenDrawerState.drawerState
    val scaffoldState = rememberBackdropScaffoldState(initialValue = BackdropValue.Revealed)

    LaunchedEffect(key1 = Unit) {
        snapshotFlow {
            !drawerState.isOpen && scaffoldState.isConcealed
        }.collect {
            scaffoldState.reveal()
        }
    }
    
    BackdropScaffold(
        scaffoldState = scaffoldState,
        frontLayerContent = {
            DrawerFrontLayer(
                backdropScaffoldState = scaffoldState,
                homeScreenDrawerState = homeScreenDrawerState
            )
        }
    )
}
```

## rememberUpdatedState

## SideEffect

## DisposableEffect

- rememberUpdatedStateã€‚å¦‚æœå¸Œæœ›åœ¨æ•ˆåº”ä¸­æ•è·æŸä¸ªå€¼ï¼Œä¸”å³ä½¿è¯¥å€¼å‘ç”Ÿäº†å˜åŒ–ä¹Ÿä¸ä¼šå¯¼è‡´æ•ˆåº”é‡å¯ï¼Œå¯ä»¥ä½¿ç”¨ rememberUpdatedState æ¥å®ç°
- SideEffectã€‚å¦‚æœéœ€è¦ä¸é Compose ç®¡ç†çš„å¯¹è±¡å…±äº« Compose çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ SideEffect æ¥å®ç°ï¼Œå› ä¸ºæ¯æ¬¡æˆåŠŸé‡ç»„æ—¶éƒ½ä¼šè°ƒç”¨è¯¥å¯ç»„åˆé¡¹
- DisposableEffectã€‚å¦‚æœé™„å¸¦æ•ˆåº”éœ€è¦åœ¨ key å‘ç”Ÿå˜åŒ–æˆ–è€…æ˜¯å¯ç»„åˆé¡¹é€€å‡ºç»„åˆåè¿›è¡Œæ¸…ç†ï¼Œå¯ä»¥ä½¿ç”¨ DisposableEffect æ¥å®ç°

Compose æä¾›çš„ BackHandler æ–¹æ³•å°±åŒæ—¶ä½¿ç”¨åˆ°äº†ä»¥ä¸Šä¸‰è€…ï¼Œå…¶æ„ä¹‰åˆ†åˆ«æ˜¯ï¼š

- å¤–éƒ¨ä¼ å…¥çš„ onBack æ–¹æ³•ä»…éœ€è¦åœ¨æ‹¦æˆªäº†è¿”å›äº‹ä»¶æ—¶è¿›è¡Œè°ƒç”¨å³å¯ï¼Œæ•ˆåº”ä»…éœ€è¦æ‹¿åˆ°æœ€æ–°å€¼å³å¯ï¼Œå³ä½¿è¯¥å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿä¸å½±å“å½“å‰çš„æ•ˆåº”æ‰§è¡Œè¿‡ç¨‹ï¼Œå› æ­¤ å°±é€šè¿‡ rememberUpdatedState æ¥æ•è· onBack å›è°ƒï¼Œä»è€Œé¿å…å»é‡å¯æ•ˆåº”ã€‚è€Œå¦‚æœä¸ä½¿ç”¨ rememberUpdatedState çš„è¯ï¼Œå°±éœ€è¦å°† onBack å½“åšé™„å¸¦æ•ˆåº”çš„ keyï¼Œè¿™å°±ä¼šå¯¼è‡´ onBack ä¸€å‘ç”Ÿå˜åŒ–å°±éœ€è¦é‡å¯æ•ˆåº”
- å¤–éƒ¨åœ¨è°ƒç”¨ BackHandler æ–¹æ³•æ—¶ä¼ å…¥çš„  enabled å‚æ•°å¯èƒ½æ˜¯åŸºäºæŸä¸ªé€»è¾‘è¡¨è¾¾å¼æ¥ä¼ å…¥çš„ï¼Œéšæ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œè€Œ SideEffect åœ¨æ¯æ¬¡é‡ç»„æ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤ BackHandler å°±é€šè¿‡ SideEffect æ¥ä¿è¯ OnBackPressedCallback èƒ½å®æ—¶æŒ‡å‘å½“å‰æœ€æ–°çš„å¯ç”¨çŠ¶æ€
- DisposableEffect æä¾›äº† onDispose å›è°ƒï¼Œå½“ key å‘ç”Ÿå˜åŒ–æˆ–è€…æ˜¯å¯ç»„åˆé¡¹é€€å‡ºç»„åˆæ—¶å°±ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤å°±é€šè¿‡ DisposableEffect æ¥è‡ªåŠ¨ç§»é™¤å¯¹ OnBackPressed äº‹ä»¶çš„ç›‘å¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDisposableEffect å¿…é¡»æ·»åŠ  onDispose è¯­å¥ï¼Œä¸”å¿…é¡»æ”¾åœ¨æœ€åé¢ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°†æŠ¥é”™

```kotlin
@Composable
public fun BackHandler(enabled: Boolean = true, onBack: () -> Unit) {
    // Safely update the current `onBack` lambda when a new one is provided
    val currentOnBack by rememberUpdatedState(onBack)
    // Remember in Composition a back callback that calls the `onBack` lambda
    val backCallback = remember {
        object : OnBackPressedCallback(enabled) {
            override fun handleOnBackPressed() {
                currentOnBack()
            }
        }
    }
    // On every successful composition, update the callback with the `enabled` value
    SideEffect {
        backCallback.isEnabled = enabled
    }
    val backDispatcher = checkNotNull(LocalOnBackPressedDispatcherOwner.current) {
        "No OnBackPressedDispatcherOwner was provided via LocalOnBackPressedDispatcherOwner"
    }.onBackPressedDispatcher
    val lifecycleOwner = LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner, backDispatcher) {
        // Add callback to the backDispatcher
        backDispatcher.addCallback(lifecycleOwner, backCallback)
        // When the effect leaves the Composition, remove the callback
        onDispose {
            backCallback.remove()
        }
    }
}
```

# ä¸ƒã€Coroutines

Kotlin åç¨‹åœ¨ compose_chat ä¸­ç”¨å¾—ä¹Ÿæ¯”è¾ƒå¤šï¼Œæ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªç‚¹å°±æ˜¯ç”¨äºå‘é€æ¶ˆæ¯æ—¶

å½“ç”¨äºç‚¹å‡»å‘é€æ¶ˆæ¯åï¼Œå°±ä¼šæ„é€ å‡ºä¸€æ¡æ–‡æœ¬æ¶ˆæ¯ TextMessageï¼Œè€Œ TextMessage æ‰€å¤„çš„çŠ¶æ€å…ˆåæœ‰ä¸‰ç§å¯èƒ½ï¼šå‘é€ä¸­ã€å‘é€æˆåŠŸã€å‘é€å¤±è´¥ã€‚ä¸ºäº†é¿å…ä¸Šå±‚ä¸šåŠ¡é€»è¾‘éœ€è¦é€šè¿‡å¤šæ¬¡ Callback çš„æ–¹å¼æ¥å¼‚æ­¥æ‹¿åˆ°åº•å±‚ IM SDK çš„å¤„ç†ç»“æœï¼Œcompose_chat é€‰æ‹©é€šè¿‡ Channel æ¥åŒæ­¥åœ°å®Œæˆæ•´ä¸ªè¿‡ç¨‹

IM SDK çš„å…·ä½“æ¶ˆæ¯å‘é€é€»è¾‘å¯¹åº”çš„æ˜¯ MessageProviderï¼Œåœ¨æ­£å¼å‘é€æ¶ˆæ¯å‰ä¼šå…ˆå°† text æ„å»ºä¸ºä¸€æ¡ Sending çŠ¶æ€çš„ TextMessageï¼Œä¸Šå±‚è§†å›¾å°±å¯ä»¥å…ˆæ‹¿åˆ°è¯¥æ¶ˆæ¯ç”¨äº UI å±•ç¤ºã€‚ç„¶åå†æ¥æ­£å¼å‘ IM SDK å‘é€æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€ï¼ˆæˆåŠŸæˆ–è€…å¤±è´¥ï¼‰å†é€šè¿‡ Channel å›è°ƒå‡ºå»

```kotlin
class MessageProvider : IMessageProvider, Converters {

    override suspend fun send(chat: Chat, text: String, channel: Channel<Message>) {
        val id = chat.id
        val messageId = RandomUtils.generateMessageId()
            msgId = messageId, state = MessageState.Sending,
            timestamp = V2TIMManager.getInstance().serverTime, msg = text,
            sender = AppConst.personProfile.value,
        )
        channel.send(sendingMessage)
        val callback = object : V2TIMValueCallback<V2TIMMessage> {
            override fun onSuccess(t: V2TIMMessage) {
                coroutineScope.launch {
                    val msg = convertMessage(t) as? TextMessage
                    //å‘ channel å‘é€æœ€ç»ˆç»“æœ
                    if (msg == null) {
                        channel.send(sendingMessage.copy(state = MessageState.SendFailed))
                    } else {
                        channel.send(msg)
                    }
                    //å…³é—­ channelï¼Œä»£è¡¨å›è°ƒç»“æŸ
                    channel.close()
                }
            }

            override fun onError(code: Int, desc: String?) {
                coroutineScope.launch {
                    //å‘ channel å‘é€æœ€ç»ˆç»“æœ
                    channel.send(
                        sendingMessage.copy(state = MessageState.SendFailed).apply {
                            tag = "code: $code desc: $desc"
                        })
                    //å…³é—­ channelï¼Œä»£è¡¨å›è°ƒç»“æŸ
                    channel.close()
                }
            }
        }
        when (chat) {
            is Chat.C2C -> {
                V2TIMManager.getInstance().sendC2CTextMessage(text, id, callback)
            }
            is Chat.Group -> {
                V2TIMManager.getInstance()
                    .sendGroupTextMessage(text, id, V2TIMMessage.V2TIM_PRIORITY_HIGH, callback)
            }
        }
    }

}
```

ChatViewModel åˆ™ä»…éœ€è¦å‘ MessageProvider ä¼ é€’ text å³å¯ï¼Œåç»­ TextMessage çš„æ„å»ºè¿‡ç¨‹å’Œå‘é€é€»è¾‘éƒ½æ— éœ€å…³å¿ƒï¼Œä»…éœ€åŒæ­¥åœ°å‘ messageChannel å–å€¼è¿›è¡Œ UI çŠ¶æ€åˆ·æ–°å³å¯

```kotlin
class ChatViewModel(private val chat: Chat) : ViewModel() {

    fun sendMessage(text: String) {
        viewModelScope.launch {
            val messageChannel = Channel<Message>()
            launch {
                ComposeChat.messageProvider.send(
                    chat = chat,
                    text = text,
                    channel = messageChannel
                )
            }
            var sendingMessage: Message? = null
            for (message in messageChannel) {
                when (message.state) {
                    MessageState.Sending -> {
                        sendingMessage = message
                        attachNewMessage(newMessage = message, mushScrollToBottom = true)
                    }
                    MessageState.Completed, MessageState.SendFailed -> {
                        val sending = sendingMessage ?: return@launch
                        val sendingMessageIndex =
                            allMessage.indexOfFirst { it.msgId == sending.msgId }
                        if (sendingMessageIndex > -1) {
                            allMessage[sendingMessageIndex] = message
                            refreshViewState()
                        }
                        if (message.state == MessageState.SendFailed) {
                            (message.tag as? String)?.let {
                                showToast(it)
                            }
                        }
                    }
                }
            }
        }
    }

}
```

å…³äº Kotlin åç¨‹çš„å…¥é—¨æ•™ç¨‹å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š[ä¸€æ–‡å¿«é€Ÿå…¥é—¨ Kotlin åç¨‹](https://juejin.cn/post/6908271959381901325)

# å…«ã€Coil

å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼ŒåŠ è½½å›¾ç‰‡çš„åŠŸèƒ½å¿…ä¸å¯å°‘ï¼ŒGlide ä¹Ÿåº”è¯¥æ˜¯å¤§éƒ¨åˆ†å¼€å‘è€…æ¥è§¦çš„æœ€å¤šçš„å›¾ç‰‡åŠ è½½æ¡†æ¶äº†ï¼Œä½†å¯¹äº Jetpack Compose æ¥è¯´ Glide å°±ä¸é€‚ç”¨äº†ï¼ŒGlide ä¼¼ä¹æš‚æ—¶ä¹Ÿæ²¡æœ‰æ”¯æŒ Jetpack Compose çš„æ‰“ç®—ï¼š[Jetpack Compose Support Â· Issue #4459 Â· bumptech/glide (github.com)](https://github.com/bumptech/glide/issues/4459)

ä¸ºäº†åœ¨ Jetpack Compose ä¸­èƒ½å¤ŸåŠ è½½ç½‘ç»œå›¾ç‰‡ï¼Œå¹¶æ”¯æŒå¿…è¦çš„å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¦å¤–ä¸€ä¸ªå›¾ç‰‡åŠ è½½æ¡†æ¶ï¼š[Coil](https://github.com/coil-kt/coil)

Coil èƒ½å®ç° Glide çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ä¸”ä¹ŸåŒæ—¶æ”¯æŒ Jetpack Composeã€‚Coil ç›¸å¯¹ Glide æ¥è¯´è¿˜æ¯”è¾ƒâ€œæ–°â€ï¼Œ1.0 æ­£å¼ç‰ˆæ˜¯åœ¨ 2020 å¹´ 10 æœˆä»½å‘å¸ƒçš„ï¼Œå¦‚æœä½ çš„é¡¹ç›®ä¸­å·²ç»å¤§é¢ç§¯ä½¿ç”¨åˆ°äº† Jetpackã€Kotlin Coroutinesã€OkHttp çš„è¯ï¼Œé‚£ä¹ˆ Coil ä¼šæ›´åŠ å¥‘åˆä½ çš„é¡¹ç›®

å¯¹ Coil å’Œ Glide åšä¸‹ç®€å•çš„å¯¹æ¯”ï¼š

1. å®ç°è¯­è¨€
   - Glide å…¨ç›˜ä½¿ç”¨ Java è¯­è¨€æ¥å®ç°ï¼Œå¯¹äº Java å’Œ Kotlin è¯­è¨€çš„å‹å¥½ç¨‹åº¦å·®ä¸å¤š
   - Coil å…¨ç›˜ä½¿ç”¨ Kotlin è¯­è¨€æ¥å®ç°ï¼Œä¸º ImageView å£°æ˜äº†å¤šä¸ªç”¨äºåŠ è½½å›¾ç‰‡çš„æ‰©å±•å‡½æ•°ï¼Œå¯¹ Kotlin è¯­è¨€çš„å‹å¥½ç¨‹åº¦ä¼šæ›´é«˜å¾ˆå¤š
2. ç½‘ç»œè¯·æ±‚
   - Glide é»˜è®¤æ˜¯ä½¿ç”¨ HttpURLConnectionï¼Œä½†ä¹Ÿæä¾›äº†æ›´æ¢ç½‘ç»œè¯·æ±‚å®ç°é€”å¾„çš„å…¥å£
   - Coil é»˜è®¤æ˜¯ä½¿ç”¨ OkHttpï¼Œä½†ä¹Ÿæä¾›äº†æ›´æ¢ç½‘ç»œè¯·æ±‚å®ç°é€”å¾„çš„å…¥å£
3. ç”Ÿå‘½å‘¨æœŸç›‘å¬
   - Glide é€šè¿‡å‘ Activity æˆ–è€… Fragment æ³¨å…¥ä¸€ä¸ªæ—  UI ç•Œé¢çš„ Fragment æ¥å®ç°ç›‘å¬
   - Coil ç›´æ¥é€šè¿‡ Lifecycle æ¥å®ç°ç›‘å¬
4. å†…å­˜ç¼“å­˜
   - Glide çš„å†…å­˜ç¼“å­˜åˆ†ä¸º ActiveResources å’Œ MemoryCache ä¸¤çº§
   - Coil çš„å†…å­˜ç¼“å­˜åˆ†ä¸º WeakMemoryCache å’Œ StrongMemoryCache ä¸¤çº§ï¼Œæœ¬è´¨ä¸Šå’Œ Glide ä¸€æ ·
5. ç£ç›˜ç¼“å­˜
   - Glide åœ¨åŠ è½½åˆ°å›¾ç‰‡åé€šè¿‡ DiskLruCache æ¥è¿›è¡Œç£ç›˜ç¼“å­˜ï¼Œä¸”æä¾›äº†**æ˜¯å¦ç¼“å­˜ã€æ˜¯å¦ç¼“å­˜åŸå§‹å›¾ç‰‡ã€æ˜¯å¦ç¼“å­˜è½¬æ¢è¿‡åçš„å›¾ç‰‡**ç­‰å¤šä¸ªé€‰æ‹©
   - Coil é€šè¿‡ OkHttp çš„ç½‘ç»œè¯·æ±‚ç¼“å­˜æœºåˆ¶æ¥å®ç°ç£ç›˜ç¼“å­˜ï¼Œä¸”ç£ç›˜ç¼“å­˜åªå¯¹é€šè¿‡ç½‘ç»œè¯·æ±‚åŠ è½½åˆ°çš„åŸå§‹å›¾ç‰‡ç”Ÿæ•ˆï¼Œä¸ç¼“å­˜å…¶å®ƒæ¥æºçš„å›¾ç‰‡å’Œè½¬æ¢è¿‡åçš„å›¾ç‰‡
6. ç½‘ç»œç¼“å­˜
   - Glide ä¸å­˜åœ¨è¿™ä¸ªæ¦‚å¿µ
   - Coil ç›¸æ¯” Glide å¤šå‡ºäº†ä¸€å±‚ç½‘ç»œç¼“å­˜ï¼Œå¯ç”¨äºå®ç°**ä¸è¿›è¡Œç½‘ç»œåŠ è½½ï¼Œè€Œæ˜¯å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜**ï¼ˆå½“ç„¶ï¼Œå¦‚æœæœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨çš„è¯å°±ä¼šæŠ¥é”™ï¼‰
7. çº¿ç¨‹æ¡†æ¶
   - Glide ä½¿ç”¨åŸç”Ÿçš„ ThreadPoolExecutor æ¥å®Œæˆåå°ä»»åŠ¡ï¼Œé€šè¿‡ Handler æ¥å®ç°çº¿ç¨‹åˆ‡æ¢
   - Coil ä½¿ç”¨ Coroutines æ¥å®Œæˆåå°ä»»åŠ¡åŠçº¿ç¨‹åˆ‡æ¢

ä½¿ç”¨ Coil æ¥åŠ è½½å›¾ç‰‡ä¹Ÿååˆ†ç®€å•ï¼Œä»…éœ€è¦ä¼ å…¥å¿…è¦çš„ data å³å¯ï¼Œè¯¥ data çš„ç±»å‹å¯ä»¥æ˜¯ HttpUrlã€Uriã€File ç­‰å¤šç§ç±»å‹

```kotlin
@Composable
fun CoilImage(
    modifier: Modifier = Modifier,
    data: Any,
    contentScale: ContentScale = ContentScale.Crop,
    builder: ImageRequest.Builder.() -> Unit = {},
) {
    val imagePainter = rememberImagePainter(data = data, builder = builder)
    Image(
        modifier = modifier,
        painter = imagePainter,
        contentDescription = null,
        contentScale = contentScale,
    )
}
```

å…³äº Coil çš„è¯¦ç»†æºç ä»‹ç»å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼Œå½“æ—¶ Coil åˆšå‘å¸ƒ 1.0 æ­£å¼ç‰ˆæœ¬ä¸ä¹…æˆ‘å°±å†™äº†è¿™ç¯‡æ–‡ç« ï¼š[ä¸‰æ–¹åº“æºç ç¬”è®°ï¼ˆ13ï¼‰-å¯èƒ½æ˜¯å…¨ç½‘ç¬¬ä¸€ç¯‡ Coil çš„æºç åˆ†ææ–‡ç« ](https://juejin.cn/post/6897872882051842061)

# ä¹ã€ç»“å°¾

å…³äº Jetpack Compose å’Œ compose_chat çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ï¼Œå…ˆåçœ‹å®Œæˆ‘ä¸¤ç¯‡æ–‡ç« çš„è¯ï¼Œè¯»è€…åº”è¯¥éƒ½èƒ½å¿«é€Ÿä¸Šæ‰‹å¼€å‘äº† ğŸ¤£ğŸ¤£

æœ€åå†æ”¾ä¸€ä¸‹ compose_chat çš„ GitHub åœ°å€ï¼š[ğŸğŸğŸ ç”¨ Jetpack Compose å®ç°ä¸€ä¸ª IM APP](https://github.com/leavesCZY/compose_chat)

 Apk ä¸‹è½½å°é²œï¼š[ğŸğŸğŸ ç”¨ Jetpack Compose å®ç°ä¸€ä¸ª IM APP](https://github.com/leavesCZY/compose_chat/releases)

è…¾è®¯äº‘ IM SDK å…è´¹ç‰ˆæœ€å¤šåªèƒ½æ³¨å†Œä¸€ç™¾ä¸ªè´¦å·ï¼Œ1.0 ç‰ˆæœ¬çš„ compose_chat ç”¨æˆ·æ•°å·²ç»æ»¡äº†ï¼Œå› æ­¤ 2.0 ç‰ˆæœ¬æˆ‘æ›´æ¢äº†æ–°çš„ AppIdã€‚å¦‚æœå‘ç°æ— æ³•æ³¨å†Œï¼Œè¯»è€…å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ä¸ªæˆ‘é¢„å…ˆæ³¨å†Œå¥½çš„è´¦å·ï¼Œä½†å¤šè®¾å¤‡åŒæ—¶ç™»é™†çš„è¯ä¼šäº’ç›¸æŒ¤æ‰çº¿ ~~

- Google
- Android
- Jetpack
- Compose
- Flutter
- Kotlin
- Java
- Dart
- ViewModel
- LiveData