> å…¬ä¼—å·ï¼š[å­—èŠ‚æ•°ç»„](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image)
>
> å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

è¿‘ä¸¤å¹´æ¥å·¥ä¿¡éƒ¨å¯¹äºåº”ç”¨çš„éšç§åˆè§„å®‰å…¨é—®é¢˜æ„ˆåŠ é‡è§†ï¼Œå¯¹ Android å¹³å°çš„ç®¡æ§ç¨‹åº¦ä¹Ÿè¦æ¯” IOS å¹³å°ä¸¥æ ¼å¾ˆå¤šï¼Œå¾ˆå¤šä¸åˆè§„çš„åº”ç”¨ä¹Ÿå…ˆåè¢«ä¸‹æ¶è¦æ±‚æ•´æ”¹

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f01addaeea7c4865a77119108fd2c86c~tplv-k3u1fbpfcp-zoom-1.image)

è¦é¿å…å‡ºç°éšç§åˆè§„å®‰å…¨é—®é¢˜ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯è¦åšåˆ°ä»¥ä¸‹ä¸¤ç‚¹ï¼š

- åœ¨ç”¨æˆ·åŒæ„éšç§åè®®ä¹‹å‰ï¼Œä¸èƒ½æœ‰æ”¶é›†ç”¨æˆ·éšç§æ•°æ®çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œåœ¨ç”¨æˆ·åŒæ„ä¹‹å‰ä¸èƒ½å»è·å– Android IDã€Device IDã€MAC ç­‰éšç§æ•°æ®
- åœ¨ç”¨æˆ·åŒæ„éšç§åè®®ä¹‹åï¼Œæœé›†ç”¨æˆ·éšç§æ•°æ®çš„è¡Œä¸ºä¸èƒ½è¶…å‡ºå®ç°æœåŠ¡åœºæ™¯æ‰€å¿…éœ€çš„æœ€ä½é¢‘ç‡ã€‚ä¾‹å¦‚ï¼ŒæŸäº›åº”ç”¨ä¼šåœ¨æ¯æ¬¡ç½‘ç»œè¯·æ±‚æ—¶å°†å½“å‰è®¾å¤‡çš„ Android ID ä½œä¸º header ä¸€èµ·ä¸ŠæŠ¥ï¼Œå¦‚æœæ²¡æœ‰å¯¹ Android ID è¿›è¡Œç¼“å­˜å¤„ç†çš„è¯ï¼Œæœé›†è¯¥æ•°æ®çš„è¡Œä¸ºé¢‘ç‡å°±ä¼šéå¸¸é«˜ï¼Œæ­¤æ—¶ä¸€æ ·å­˜åœ¨éšç§åˆè§„é—®é¢˜

é’ˆå¯¹ä»¥ä¸Šä¸¤ç‚¹é—®é¢˜æœ‰ä¸åŒçš„åº”å¯¹æªæ–½

- å¯¹äºç¬¬ä¸€ç‚¹ã€‚éœ€è¦ç»Ÿè®¡å‡ºæ•´ä¸ªé¡¹ç›®ä¸­æ‰€æœ‰æ¶‰åŠåˆ°éšç§è¡Œä¸ºçš„ç›¸å…³ä»£ç ï¼Œæ ¹æ®ä¸šåŠ¡æµç¨‹æ¥åˆ¤æ–­è¯¥éšç§è¡Œä¸ºæ˜¯å¦åˆç†ã€ä»¥åŠæ˜¯å¦ä¼šåœ¨ç”¨æˆ·åŒæ„éšç§åè®®ä¹‹å‰è¢«è§¦å‘ã€‚è¿™å°±éœ€è¦å¯¹æ•´ä¸ªé¡¹ç›®è¿›è¡Œ **é™æ€æ‰«æ** äº†
- å¯¹äºç¬¬äºŒç‚¹ã€‚éœ€è¦åœ¨åº”ç”¨è¿è¡Œæ—¶åŠ¨æ€è®°å½•æ¯æ¬¡è§¦å‘éšç§è¡Œä¸ºçš„æ—¶é—´ç‚¹å’Œè°ƒç”¨é“¾ä¿¡æ¯ï¼Œæ ¹æ®è§¦å‘æ—¶é—´æ¥åˆ¤æ–­è¯¥éšç§è¡Œä¸ºæ˜¯å¦è¿‡é‡æ‰§è¡Œï¼Œæ ¹æ®è°ƒç”¨é“¾ä¿¡æ¯æ¥è¾…åŠ©åˆ¤æ–­å…·ä½“æ˜¯å“ªä¸€å—ä¸šåŠ¡åœ¨è·å–éšç§æ•°æ®ã€‚è¿™å°±éœ€è¦å¯¹åº”ç”¨è¿›è¡Œ **åŠ¨æ€è®°å½•** äº†

ä»¥ä¸Šåº”å¯¹æªæ–½å¦‚æœå•çº¯é å¼€å‘äººå‘˜æ¥è‚‰çœ¼è¯†åˆ«ä»£ç å’Œç¼–ç ç»Ÿè®¡çš„è¯ï¼Œå·¥ä½œé‡éå¸¸å¤§è€Œä¸”ä¹Ÿå¾ˆä¸ç°å®ï¼Œå› ä¸ºä¸€ä¸ªå¤§å‹é¡¹ç›®å¾€å¾€éƒ½ä¼šå¼•å…¥å¤šä¸ªä¾èµ–åº“å’Œç¬¬ä¸‰æ–¹ SDKï¼Œæˆ‘ä»¬å¯ä»¥è§„èŒƒè‡ªæœ‰ä»£ç ï¼Œä½†æ²¡æ³•ä¿®æ”¹å’Œæœ‰æ•ˆçº¦æŸå¤–éƒ¨ä¾èµ–ï¼Œä¹Ÿå¾ˆéš¾ç†æ¸…æ¥šä¾èµ–åº“çš„å†…éƒ¨é€»è¾‘å’Œè°ƒç”¨é“¾å…³ç³»ã€‚æ­¤å¤–ï¼Œå½“æ£€æµ‹åˆ°éšç§è¡Œä¸ºåï¼Œä¹Ÿè¦è¾“å‡ºç›¸å¯¹åº”çš„è®°å½•æŠ¥å‘Šï¼Œä»¥ä¾¿å¼€å‘äººå‘˜èƒ½å¤Ÿåœ¨å¼€å‘é˜¶æ®µæ’æŸ¥é—®é¢˜

æ­¤æ—¶å°±å¯ä»¥ä¾é  ASM + Transform æ¥åº”å¯¹è¿™ç§éä¸šåŠ¡ä¾µå…¥å¼çš„å¼€å‘åœºæ™¯äº†ï¼Œæœ¬æ–‡è¦ä»‹ç»çš„å°±æ˜¯å¦‚ä½•é€šè¿‡ ASM + Transform æ¥åŠ©åŠ›é€šè¿‡éšç§åˆè§„å®‰å…¨å®¡æ ¸

# é™æ€æ‰«æ

è¦è¿›è¡Œé™æ€æ‰«æï¼Œé¦–å…ˆå°±éœ€è¦å…ˆæ˜ç¡®å“ªäº›æ“ä½œæ˜¯å±äºéšç§è¡Œä¸ºï¼Œè¿™é‡Œä»¥è·å– Device ID å’Œ Build.BRAND ä¸ºä¾‹ã€‚åœ¨ Activity ä¸­é€šè¿‡ç‚¹å‡»æŒ‰é’®æ¥æ¨¡æ‹Ÿè·å–éšç§æ•°æ®çš„è¡Œä¸ºï¼Œåç»­å®ç° **åŠ¨æ€è®°å½•** æ—¶éœ€è¦è®°å½•çš„è°ƒç”¨é“¾æŒ‡çš„ä¹Ÿå°±æ˜¯ä»ç‚¹å‡»æŒ‰é’®åˆ°æ‰§è¡Œ `DeviceUtils.getDeviceId` æ–¹æ³•çš„æ•´ä¸ªè¿‡ç¨‹

```kotlin
package github.leavesc.asm.privacy_sentry

class PrivacySentryActivity : AppCompatActivity() {

    private val btnGetDeviceId by lazy {
        findViewById<Button>(R.id.btnGetDeviceId)
    }

    private val btnGetDeviceBrand by lazy {
        findViewById<Button>(R.id.btnGetDeviceBrand)
    }

    private val tvLog by lazy {
        findViewById<TextView>(R.id.tvLog)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_privacy_sentry)
        btnGetDeviceId.setOnClickListener {
            tvLog.append("\n" + "deviceId: " + DeviceUtils.getDeviceId(this))
        }
        btnGetDeviceBrand.setOnClickListener {
            tvLog.append("\n" + "brand: " + DeviceUtils.getBrand())
        }
    }

}

object DeviceUtils {

    fun getDeviceId(context: Context): String {
        return try {
            val telephonyManager =
                context.getSystemService(Service.TELEPHONY_SERVICE) as? TelephonyManager
            telephonyManager?.deviceId ?: ""
        } catch (e: Throwable) {
            e.printStackTrace()
            ""
        }
    }

    fun getBrand(): String {
        return Build.BRAND
    }

}
```

ä»¥ä¸Šä¸¤ä¸ªéšç§è¡Œä¸ºåœ¨å­—èŠ‚ç å±‚é¢ä¸Šå±äºä¸åŒçš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

- MethodInsnNodeã€‚å±äºè°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ï¼Œå¯¹åº” `TelephonyManager.getDeviceId()` 
- FieldInsnNodeã€‚å±äºè°ƒç”¨æˆå‘˜å˜é‡çš„æŒ‡ä»¤ï¼Œå¯¹åº” `Build.BRAND`

é™æ€æ‰«æè¦åšçš„ï¼Œå°±æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µéå†æ‰€æœ‰çš„ Class æ–‡ä»¶ï¼Œåªè¦åˆ¤æ–­åˆ°æ–‡ä»¶ä¸­åŒ…å«è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œå°±å°† **éšç§æ“ä½œæ‰€åœ¨çš„ç±»è·¯å¾„ã€è°ƒç”¨è€…çš„æ–¹æ³•ç­¾åä¿¡æ¯ã€éšç§æ“ä½œçš„ç­¾åä¿¡æ¯** è®°å½•åˆ°æ–‡æœ¬ä¸­

é¦–å…ˆï¼Œé€šè¿‡å¯¹æ¯”ç­¾åä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å±äºç›®æ ‡æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼ŒBuild.BRAND æ‰€åœ¨çš„ç±»è·¯å¾„æ˜¯ `"android.os.Build"`ï¼Œè¯¥å­—æ®µæ˜¯ String ç±»å‹ï¼Œä¹Ÿå³ `Ljava/lang/String;`ï¼Œå­—æ®µåä¹Ÿå³ `BRAND`ï¼Œé€šè¿‡æ¯”å¯¹è¿™ä¸‰ä¸ªå±æ€§æ¥è¯†åˆ«æ˜¯å¦æ˜¯ç›®æ ‡æŒ‡ä»¤

```kotlin
private fun AbstractInsnNode.isHookPoint(): Boolean {
    when (this) {
        is MethodInsnNode -> {
            if (owner == "android/telephony/TelephonyManager"
                && name == "getDeviceId"
                && desc == "()Ljava/lang/String;"
            ) {
                return true
            }
        }
        is FieldInsnNode -> {
            if (owner == "android/os/Build" 
                && name == "BRAND" 
                && desc == "Ljava/lang/String;") {
                return true
            }
        }
    }
    return false
}
```

æ‰¾åˆ°ç›®æ ‡æŒ‡ä»¤åï¼Œå°±å°† **éšç§æ“ä½œæ‰€åœ¨çš„ç±»è·¯å¾„ã€è°ƒç”¨è€…çš„æ–¹æ³•ç­¾åä¿¡æ¯ã€éšç§æ“ä½œçš„ç­¾åä¿¡æ¯** æ‹¼æ¥åœ¨ä¸€èµ·

```kotlin
private fun getLintLog(
    classNode: ClassNode,
    methodNode: MethodNode,
    hokeInstruction: AbstractInsnNode
): StringBuilder {
    val classPath = classNode.name
    val methodName = methodNode.name
    val methodDesc = methodNode.desc
    val owner: String
    val desc: String
    val name: String
    when (hokeInstruction) {
        is MethodInsnNode -> {
            owner = hokeInstruction.owner
            desc = hokeInstruction.desc
            name = hokeInstruction.name
        }
        is FieldInsnNode -> {
            owner = hokeInstruction.owner
            desc = hokeInstruction.desc
            name = hokeInstruction.name
        }
        else -> {
            throw RuntimeException("éæ³•æŒ‡ä»¤")
        }
    }
    val lintLog = StringBuilder()
    lintLog.append(classPath)
    lintLog.append("  ->  ")
    lintLog.append(methodName)
    lintLog.append("  ->  ")
    lintLog.append(methodDesc)
    lintLog.append("\n")
    lintLog.append(owner)
    lintLog.append("  ->  ")
    lintLog.append(name)
    lintLog.append("  ->  ")
    lintLog.append(desc)
    return lintLog
}
```

åœ¨ Transform é˜¶æ®µï¼Œæ¯å½“æ‹¿åˆ°ä¸€ä¸ª Class æ–‡ä»¶åï¼Œå°±æ‰«æå½“ä¸­æ˜¯å¦åŒ…å«æœ‰ç›®æ ‡æŒ‡ä»¤ï¼Œæœ‰çš„è¯å°±å°†ç›¸å…³ä¿¡æ¯å†™å…¥åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œå¹¶ä¿å­˜åˆ°æ¡Œé¢

```kotlin
class PrivacySentryTransform : BaseTransform() {

    private val allLintLog = StringBuffer()

    override fun modifyClass(byteArray: ByteArray): ByteArray {
        val classNode = ClassNode()
        val classReader = ClassReader(byteArray)
        classReader.accept(classNode, ClassReader.EXPAND_FRAMES)
        val methods = classNode.methods
        if (!methods.isNullOrEmpty()) {
            val tempLintLog = StringBuilder()
            for (methodNode in methods) {
                val instructions = methodNode.instructions
                val instructionIterator = instructions?.iterator()
                if (instructionIterator != null) {
                    while (instructionIterator.hasNext()) {
                        val instruction = instructionIterator.next()
                        //åˆ¤æ–­æ˜¯å¦æ˜¯ç›®æ ‡æŒ‡ä»¤
                        if (instruction.isHookPoint()) {
                            val lintLog = getLintLog(
                                classNode,
                                methodNode,
                                instruction
                            )
                            tempLintLog.append(lintLog)
                            tempLintLog.append("\n\n")
                        }
                    }
                }
            }
            if (tempLintLog.isNotBlank()) {
                allLintLog.append(tempLintLog)
            }
        }
        return byteArray
    }

    override fun onTransformEnd() {
        if (allLintLog.isNotEmpty()) {
            //å°†æ‰«æç»“æœä¿å­˜åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­
            FileUtils.write(generateLogFile(), allLintLog, Charset.defaultCharset())
        }
    }

    private fun generateLogFile(): File {
        val time = SimpleDateFormat(
            "yyyy_MM_dd_HH_mm_ss",
            Locale.CHINA
        ).format(Date(System.currentTimeMillis()))
        //å°†æ–‡ä»¶ä¿å­˜åˆ°æ¡Œé¢
        return File(
            FileSystemView.getFileSystemView().homeDirectory,
            "PrivacySentry_${time}.txt"
        )
    }
    
    Â·Â·Â·

}
```

å½“ Transform ç»“æŸåï¼Œå°±ä¼šåœ¨æ¡Œé¢ä¸Šç”Ÿæˆä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶äº†ï¼Œå½“ä¸­å°±è®°å½•äº† DeviceUtils ä¸­çš„ä¸¤ä¸ªéšç§æ“ä½œè¡Œä¸ºã€‚æ­¤å¤–ï¼Œç”±äºé¡¹ç›®ä¸­æˆ‘åŒæ—¶å¼•å…¥äº† `androidx.core:core:1.7.0`ï¼Œæ‰€ä»¥ä¹Ÿä¼šæŠŠ TelephonyManagerCompat ç»™æ‰«æå‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°è¯¥ç±»å½“ä¸­åŒ…å«çš„ `String getImei(TelephonyManager)` æ–¹æ³•ä¹Ÿä¼šå»è·å– Device ID

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aec2f676c0a241f19f0e21cf33aa85f5~tplv-k3u1fbpfcp-zoom-1.image)

éœ€è¦æ³¨æ„ï¼Œç”±äº PrivacySentryTransform æ”¯æŒå¢é‡ç¼–è¯‘ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šè¾“å‡ºæ—¥å¿—æ–‡ä»¶ï¼Œä¸”åªæœ‰å½“å…¨é‡ç¼–è¯‘æ—¶æ‰èƒ½å¤Ÿè¾“å‡ºå®Œæ•´çš„è®°å½•æŠ¥å‘Š

# åŠ¨æ€è®°å½•

åŠ¨æ€è®°å½•è¦åšçš„æ˜¯ï¼šåœ¨åº”ç”¨è¿è¡Œæ—¶è®°å½•æ¯æ¬¡è§¦å‘éšç§è¡Œä¸ºçš„æ—¶é—´ç‚¹å’Œè°ƒç”¨é“¾ä¿¡æ¯ï¼Œæ ¹æ®è§¦å‘æ—¶é—´æ¥åˆ¤æ–­è¯¥éšç§è¡Œä¸ºæ˜¯å¦è¿‡é‡æ‰§è¡Œï¼Œæ ¹æ®è°ƒç”¨é“¾ä¿¡æ¯æ¥è¾…åŠ©åˆ¤æ–­å…·ä½“æ˜¯å“ªä¸€å—ä¸šåŠ¡éœ€è¦æ¥è·å–éšç§æ•°æ®ã€‚è¿™å°±è¦æ±‚æˆ‘ä»¬é™¤äº†è¦è¯»å– Class æ–‡ä»¶å¤–ï¼Œè¿˜è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œæ’å…¥ä¸€äº›æ—¥å¿—ä¿¡æ¯å’Œé€»è¾‘ä»£ç 

ä»¥ `getBrand()` æ–¹æ³•ä¸ºä¾‹ï¼ŒåŠ¨æ€è®°å½•è¦åšåˆ°çš„å°±æ˜¯ï¼šåœ¨æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆæ—¥å¿—ä¿¡æ¯å¹¶å°†æ—¥å¿—å†™å…¥åˆ°åº”ç”¨å†…éƒ¨çš„æŸä¸ªæ–‡ä»¶ä¸­ï¼Œæ—¥å¿—ä¸­è¦åŒ…å«è°ƒç”¨çš„æ—¶é—´ç‚¹ã€ `Build.BRAND`çš„ç­¾åä¿¡æ¯ã€`getBrand()` æ–¹æ³•çš„è°ƒç”¨é“¾

```kotlin
object DeviceUtils {

    //æ’æ¡©å‰
    fun getBrand(): String {
        return Build.BRAND
    }

    //æ’æ¡©å
    fun getBrand(): String {
        val invokeTime = "xxx"
        val methodDesc = "xxx"
        val stackTrace = "xxx"
        writeToFile(invokeTime + methodDesc + stackTrace)
        return Build.BRAND
    }

}
```

`Build.BRAND` çš„ç­¾åä¿¡æ¯å¯ä»¥å¤ç”¨é™æ€æ‰«ææ—¶å¾—åˆ°çš„æ•°æ®ï¼Œæ–¹æ³•è°ƒç”¨çš„æ—¶é—´ç‚¹åˆ™å¯ä»¥åœ¨å°†ä¿¡æ¯å†™å…¥åˆ°æ–‡ä»¶æ—¶å†æ¥ç¡®å®šï¼Œç›¸å¯¹éº»çƒ¦ä¸€ç‚¹çš„æ˜¯è¦æ¥è·å– `getBrand()` æ–¹æ³•çš„è°ƒç”¨é“¾

åœ¨æœ¬æ–‡ç»™å‡ºçš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œ`getBrand()` æ–¹æ³•æ˜¯ç”± Activity ä¸­çš„ä¸€ä¸ª Button æ¥ç›´æ¥è§¦å‘æ‰§è¡Œçš„ï¼Œè¿™ä¸ªè°ƒç”¨é“¾å±‚çº§è¿˜æ¯”è¾ƒå°‘ï¼Œè€Œç°å®ä¸­è°ƒç”¨å…³ç³»å¾€å¾€æ²¡é‚£ä¹ˆç®€å•ï¼ŒA è°ƒç”¨äº† Bã€B è°ƒç”¨äº† Cã€C è°ƒç”¨äº† Dï¼ŒD å†æ¥è°ƒç”¨ DeviceUtilsï¼Œè¿™æ ·è¿é”åµŒå¥— N ä¸ªæ–‡ä»¶ä¹Ÿå¾ˆå¸¸è§ã€‚å› æ­¤ä¸º `getBrand()` æ–¹æ³•ç”Ÿæˆè°ƒç”¨é“¾ä¿¡æ¯æ˜¯å¾ˆæœ‰å¿…è¦çš„

æˆ‘ä»¬å¯ä»¥ä¾é  Throwable æ¥å®ç°è¯¥ç›®çš„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå½“åº”ç”¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸ä¿¡æ¯ä¸­å°±ä¼šåŒ…å«å…·ä½“çš„å¼‚å¸¸ç‚¹ï¼Œä»¥åŠå¯¼è‡´è¯¥å¼‚å¸¸çš„è¿é”è°ƒç”¨é“¾ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è¯¥æ€è·¯ï¼Œåœ¨ `getBrand()` æ–¹æ³•ä¸­ä¸»åŠ¨ç”Ÿæˆä¸€ä¸ª Throwable å¯¹è±¡å¹¶è·å–å…¶å †æ ˆä¿¡æ¯ï¼Œä»è€Œæ¥é—´æ¥è·å–æ–¹æ³•çš„è°ƒç”¨é“¾

å¤§è‡´æ•ˆæœå°±å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ Transform é˜¶æ®µï¼Œè‡ªåŠ¨ä¸º DeviceUtils ç”Ÿæˆä¸€ä¸ª `writeToFile()`æ–¹æ³•ï¼Œå¹¶åœ¨ Build.BRAND è¢«è°ƒç”¨å‰æ‰§è¡Œ `writeToFile()` æ–¹æ³•ï¼Œä»¥æ­¤æ¥å®ç°åŠ¨æ€è®°å½•

```kotlin
object DeviceUtils {

    //æ’æ¡©å‰
    fun getBrand(): String {
        return Build.BRAND
    }

}


object DeviceUtils {

    //æ’æ¡©å
    fun getBrand(): String {
        val methodDesc = "xxx"
        writeToFile(methodDesc, Throwable())
        return Build.BRAND
    }

    private fun writeToFile(log: String, throwable: Throwable) {
        val byteArrayOutputStream = ByteArrayOutputStream()
        throwable.printStackTrace(PrintStream(byteArrayOutputStream))
        val stackTrace = byteArrayOutputStream.toString()
        val realLog = log + stackTrace
        //å°† realLog å†™å…¥åˆ°æ–‡æœ¬ä¸­
        PrivacySentryRecord.writeToFile(realLog)
    }

}
```

æœ‰äº†å®ç°æ€è·¯åï¼Œåç»­çš„ç¼–ç å°±å¾ˆç®€å•äº†ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼š

- ä¸ºæ¯ä¸ªåŒ…å«éšç§è¡Œä¸ºçš„ç±»è‡ªåŠ¨ç”Ÿæˆ `writeToFile(log: String, throwable: Throwable)` æ–¹æ³•
- åœ¨æ¯ä¸ªä»£è¡¨éšç§è¡Œä¸ºçš„å­—èŠ‚ç æŒ‡ä»¤ä¹‹å‰æ’å…¥ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°±è´Ÿè´£å»è°ƒç”¨ `writeToFile`æ–¹æ³•

åœ¨é™æ€æ‰«æçš„åŸºç¡€ä¸Šï¼Œè¿‡ `generateWriteToFileMethod` æ–¹æ³•æ¥ç”Ÿæˆ `writeToFile` æ–¹æ³•ï¼Œæ¯å½“æ‰«æåˆ°ä¸€ä¸ªç›®æ ‡æŒ‡ä»¤åï¼Œå†é€šè¿‡ `insertRuntimeLog` æ–¹æ³•æ¥å‘å…¶æ’å…¥è°ƒç”¨ `writeToFile` æ–¹æ³•çš„æŒ‡ä»¤

```kotlin
class PrivacySentryTransform(private val config: PrivacySentryConfig) : BaseTransform() {

    companion object {

        private const val writeToFileMethodName = "writeToFile"

        private const val writeToFileMethodDesc = "(Ljava/lang/String;Ljava/lang/Throwable;)V"

    }

    private val allLintLog = StringBuffer()

    override fun modifyClass(byteArray: ByteArray): ByteArray {
        val classNode = ClassNode()
        val classReader = ClassReader(byteArray)
        classReader.accept(classNode, ClassReader.EXPAND_FRAMES)
        val methods = classNode.methods
        if (!methods.isNullOrEmpty()) {
            val taskList = mutableListOf<() -> Unit>()
            val tempLintLog = StringBuilder()
            for (methodNode in methods) {
                val instructions = methodNode.instructions
                val instructionIterator = instructions?.iterator()
                if (instructionIterator != null) {
                    while (instructionIterator.hasNext()) {
                        val instruction = instructionIterator.next()
                        if (instruction.isHookPoint()) {
                            val lintLog = getLintLog(
                                classNode,
                                methodNode,
                                instruction
                            )
                            tempLintLog.append(lintLog)
                            tempLintLog.append("\n\n")

                            if (mRuntimeRecord != null) {
                                taskList.add {
                                    //åœ¨ instruction æŒ‡ä»¤ä¹‹å‰ï¼Œæ’å…¥è°ƒç”¨ writeToFile çš„æŒ‡ä»¤
                                    insertRuntimeLog(
                                        classNode,
                                        methodNode,
                                        instruction
                                    )
                                }
                            }
                            Log.log(
                                "PrivacySentryTransform $lintLog"
                            )
                        }
                    }
                }
            }
            if (tempLintLog.isNotBlank()) {
                allLintLog.append(tempLintLog)
            }
            if (taskList.isNotEmpty() && mRuntimeRecord != null) {
                taskList.forEach {
                    it.invoke()
                }
                val classWriter = ClassWriter(ClassWriter.COMPUTE_MAXS)
                classNode.accept(classWriter)
                //ç”Ÿæˆ writeToFile æ–¹æ³•
                generateWriteToFileMethod(classWriter, mRuntimeRecord)
                return classWriter.toByteArray()
            }
        }
        return byteArray
    }
    
    Â·Â·Â·

}
```

æœ€ç»ˆï¼Œæ¯å½“ DeviceUtils ä¸­çš„ä¸¤ä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œåœ¨ `externalCacheDir`ç›®å½•ä¸‹å°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª PrivacySentry.txt æ–‡ä»¶ï¼Œå½“ä¸­å°±è®°å½•äº†éšç§æ–¹æ³•çš„å…·ä½“è°ƒç”¨æ—¶é—´å’Œè°ƒç”¨é“¾ã€‚æ ¹æ®è¯¥è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿå®šä½æ˜¯å“ªä¸€å—ä¸šåŠ¡æ‰§è¡Œäº†æ•æ„Ÿæ“ä½œ

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51f3920174ed49049874b9684361f262~tplv-k3u1fbpfcp-zoom-1.image)

# TODO

é™æ€æ‰«æ + åŠ¨æ€è®°å½• å·²ç»èƒ½å¤Ÿæ’æŸ¥å‡ºå¤§éƒ¨åˆ†çš„éšç§åˆè§„é—®é¢˜äº†ï¼Œä½†å¹¶ä¸æ˜¯å¾ˆä¿é™©ï¼Œå› ä¸ºéšç€é¡¹ç›®æ›´è¿­ï¼Œéšæ—¶å¯èƒ½æœ‰æ–°çš„éšç§å®‰å…¨é—®é¢˜è¢«å¼•å…¥è¿›æ¥ï¼Œè€Œå¦‚æœæ¯æ¬¡å‘ç‰ˆå‰éƒ½è¦é‡æ–°èµ°ä¸€éä¸Šè¿°æµç¨‹æ¥æ’æŸ¥æ˜¯å¦å­˜åœ¨é—®é¢˜çš„è¯ï¼Œä¹Ÿæ˜¯å¾ˆéº»çƒ¦

æœ€ä¿é™©çš„åšæ³•å°±æ˜¯é€šè¿‡ hook æ¥åŠ¨æ€ä»£ç†éšç§è¡Œä¸ºã€‚æˆ‘ä»¬çš„åº”ç”¨ä¸€èˆ¬éƒ½æ˜¯ä¼šé€šè¿‡ä¸€ä¸ªæ ‡è®°ä½æ¥è®°å½•ç”¨æˆ·æ˜¯å¦å·²ç»åŒæ„è¿‡éšç§åè®®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡è·å–æ•æ„Ÿæ•°æ®å‰å‡å…ˆåˆ¤æ–­è¯¥æ ‡è®°ä½ï¼Œå¦‚æœç”¨æˆ·è¿˜æœªåŒæ„éšç§åè®®çš„è¯å°±ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œå¦åˆ™æ‰å»çœŸæ­£æ‰§è¡Œæ“ä½œã€‚è¿™æ ·æ‰èƒ½ä¿è¯éšç§åˆè§„çš„ç»å¯¹å®‰å…¨

```kotlin
object DeviceUtils {

    //æ’æ¡©å‰
    fun getBrand(): String {
        return Build.BRAND
    }

    //æ’æ¡©å
    fun getBrand(): String {
        if (!UserCache.serviceAgree){
            return ""
        }
        return Build.BRAND
    }

}
```

# æºç 

æœ€åä¹Ÿç»™å‡ºå®Œæ•´çš„æºç ï¼š[ASM_Transform](https://github.com/leavesCZY/ASM_Transform)

ASM çš„æ›´å¤šå®è·µåœºæ™¯çœ‹è¿™é‡Œï¼š

- [ASM å­—èŠ‚ç æ’æ¡©ï¼šå®ç°åŒå‡»é˜²æŠ–](https://juejin.cn/post/7042328862872567838)
- [ASM å­—èŠ‚ç æ’æ¡©ï¼šè¿›è¡Œçº¿ç¨‹æ•´æ²»](https://juejin.cn/post/7044339202997092383)