> å…¬ä¼—å·ï¼š[å­—èŠ‚æ•°ç»„](https://upload-images.jianshu.io/upload_images/2552605-57915be42c4f6a82.jpg)
>
> å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

åœ¨ 2019 å¹´çš„æ—¶å€™ï¼Œæˆ‘å…ˆåå†™è¿‡ä¸¤ç¯‡æ–‡ç« æ¥ä»‹ç»æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å°è£…å®ç°ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ¡†æ¶çš„ï¼Œå¯ä»¥åˆ†åˆ«çœ‹åšæ˜¯ 1.0 å’Œ 2.0 ç‰ˆæœ¬ ğŸ˜‡ğŸ˜‡

- [ä¸€æ­¥æ­¥å°è£…å®ç°è‡ªå·±çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶ 1.0](https://juejin.im/post/5c56901de51d45016064b0db)
- [ä¸€æ­¥æ­¥å°è£…å®ç°è‡ªå·±çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶ 2.0](https://juejin.im/post/5cfdb1bee51d4550bf1ae832)

1.0 ç‰ˆæœ¬é‡‡ç”¨çš„æŠ€æœ¯æ ˆæ˜¯ **Java + Jetpack + RxJava + Retrofit**ï¼Œ2.0 ç‰ˆæœ¬é‡‡ç”¨çš„æŠ€æœ¯æ ˆæ˜¯ **Kotlin + Jetpack + RxJava + Retrofit**ã€‚2.0 ç‰ˆæœ¬ä¸»è¦çš„å˜åŒ–ç‚¹ä¹‹ä¸€å°±åœ¨äºæ›¿æ¢äº†å®ç°è¯­è¨€ï¼Œä¾èµ–äº Kotlin è¯­è¨€çš„ç®€æ´æ€§å’Œå¼ºå¤§çš„è¯­æ„è¡¨è¾¾èƒ½åŠ›ï¼Œä½¿å¾—æ•´ä¸ªç½‘ç»œè¯·æ±‚æ¡†æ¶æ›´åŠ çš„çŸ­å°ç²¾æ‚ã€‚å‘å±•åˆ°ç°åœ¨ï¼ŒRxJava å¯¹äº Android å¼€å‘è€…æ¥è¯´å…¶å­˜åœ¨æ„Ÿå’Œå­˜åœ¨æ„ä¹‰å·²ç»åœ¨é€æ­¥å‡å¼±ä¸­äº†ï¼Œå› ä¸ºæ­¤æ—¶ Kotlin åç¨‹å‡ºç°äº†ï¼š[kotlinx.coroutines](https://github.com/Kotlin/kotlinx.coroutines)

åœ¨æŠ€æœ¯é¢†åŸŸï¼Œæ–°çš„æŠ€æœ¯æ€»æ˜¯ä¸æ–­å‡ºç°ï¼Œå½“æ—¶çš„æ–‡ç« æ‰€ä»‹ç»çš„å†…å®¹åœ¨ç°åœ¨çœ‹æ¥ä¹Ÿæ˜¯æœ‰ç‚¹è·Ÿä¸ä¸Šæ—¶ä»£äº†ï¼Œè¿™ä¹Ÿä¿ƒä½¿æˆ‘æ¥å†™æ­¤ç¯‡æ–‡ç« ï¼Œå³ 3.0 ç‰ˆæœ¬

# ä¸€ã€ReactiveHttp

åç¨‹è¿™ä¸ªæ¦‚å¿µå·²ç»å‡ºç°å¾ˆå¤šå¹´äº†ï¼Œä½† Kotlin åç¨‹æ˜¯åœ¨ 2018 å¹´æ‰å‘å¸ƒäº† 1.0 ç‰ˆæœ¬ï¼Œè¢« Android å¼€å‘è€…æ‰€ç†ŸçŸ¥è¿˜è¦å†å¾€åä¸€æ®µæ—¶é—´ï¼Œåç¨‹çš„æ„ä¹‰ä¸æ˜¯æœ¬ç¯‡æ–‡ç« æ‰€åº”è¯¥æ¢è®¨çš„ï¼Œä½†å¦‚æœä½ å»äº†è§£ä¸‹åç¨‹èƒ½ç»™æˆ‘ä»¬å¸¦æ¥çš„å¼€å‘æ•ˆç›Šï¼Œæˆ‘ç›¸ä¿¡ä½ æ˜¯ä¼šå–œæ¬¢ä¸Šå®ƒçš„

é—²è¯è¯´å®Œï¼Œè¿™é‡Œå…ˆè´´ä¸Š 3.0 ç‰ˆæœ¬çš„ GitHub é“¾æ¥ï¼š[ReactiveHttp](https://github.com/leavesCZY/ReactiveHttp)

3.0 ç‰ˆæœ¬çš„æŠ€æœ¯æ ˆå·²æ›´æ–°ä¸ºäº† **Kotlin +  Jetpack + Coroutines +  Retrofit**ï¼Œå·²æ‰˜ç®¡åˆ° [jitpack.io](https://jitpack.io/#leavesC/ReactiveHttp)ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç›´æ¥è¿œç¨‹å¯¼å…¥ä¾èµ–

```groovy
allprojects {
    repositories {
        maven { url 'https://jitpack.io' }
    }
}

dependencies {
    implementation 'com.github.leavesC:ReactiveHttp:latest_version'
}
```

# äºŒã€èƒ½ç»™ä½ å¸¦æ¥ä»€ä¹ˆ

ReactiveHttp èƒ½å¤Ÿç»™ä½ å¸¦æ¥ä»€ä¹ˆï¼Ÿ

- æ›´ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆã€‚Kotlin + Jetpack + Retrofit ç°åœ¨åº”è¯¥æ˜¯å¤§å¤šæ•° Android å¼€å‘è€…é€‰ç”¨çš„æœ€åŸºç¡€ç»„ä»¶äº†ï¼ŒKotlin åç¨‹ä¼šç›¸å¯¹æ¯”è¾ƒå°‘äººæ¥è§¦ï¼Œä½†æˆ‘è§‰å¾—åç¨‹ä¹Ÿæ˜¯æœªæ¥çš„ä¸»æµæ–¹å‘ä¹‹ä¸€ï¼Œæ¯•ç«Ÿè¿ Retrofit ä¹ŸåŸç”Ÿæ”¯æŒ Kotlin åç¨‹äº†ï¼Œæœ¬åº“ä¼šæ›´åŠ ç¬¦åˆå¤§å¤šæ•°å¼€å‘è€…çš„ç°å®éœ€æ±‚
- æç®€çš„è®¾è®¡ç†å¿µã€‚ReactiveHttp ç›®å‰ä»…åŒ…å«åäºŒä¸ª Kotlin æ–‡ä»¶ï¼Œè®¾è®¡ä¸Šéµå¾ª**çº¦å®šå¤§äºé…ç½®**çš„ç†å¿µï¼Œå¤§å¤šæ•°é…ç½®é¡¹éƒ½å¯ä»¥é€šè¿‡æ–¹æ³•å¤å†™çš„å½¢å¼æ¥å®ç°è‡ªå®šä¹‰
- æç®€çš„ä½¿ç”¨æ–¹å¼ã€‚åªéœ€è¦æŒæœ‰ä¸€ä¸ª RemoteDataSource å¯¹è±¡ï¼Œå¼€å‘è€…å°±å¯ä»¥åœ¨ä»»æ„åœ°æ–¹å‘èµ·å¼‚æ­¥è¯·æ±‚å’ŒåŒæ­¥è¯·æ±‚äº†ã€‚æ­¤å¤–ï¼Œè¿›è¡Œç½‘ç»œè¯·æ±‚ Callback è‡ªç„¶æ˜¯å¿…ä¸å¯å°‘çš„ï¼ŒReactiveHttp æä¾›äº†å¤šä¸ªäº‹ä»¶å›è°ƒï¼š**onStartã€onSuccessã€onSuccessIOã€onFailedã€onFailToastã€onCancelledã€onFinally** ç­‰ï¼ŒæŒ‰éœ€å£°æ˜å³å¯ï¼Œç”šè‡³å¯ä»¥å®Œå…¨ä¸ç”¨å®ç°
- æ”¯æŒé€šç”¨æ€§çš„è‡ªåŠ¨åŒ–è¡Œä¸ºã€‚å¯¹äºç½‘ç»œè¯·æ±‚æ¥è¯´ï¼Œåƒ showLoadingã€dismissLoadingã€showToast ç­‰è¡Œä¸ºæ˜¯å…·æœ‰é€šç”¨æ€§çš„ï¼Œæˆ‘ä»¬è‚¯å®šä¸å¸Œæœ›æ¯ä¸ªç½‘ç»œè¯·æ±‚éƒ½è¦æ¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•è§¦å‘ä»¥ä¸Šæ“ä½œï¼Œè€Œæ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨å‘èµ·ç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨å®Œæˆã€‚ReactiveHttp å°±æä¾›äº†è‡ªåŠ¨å®Œæˆä»¥ä¸Šé€šç”¨æ€§ UI è¡Œä¸ºçš„åŠŸèƒ½ ï¼Œä¸”æ¯ä¸ªæ“ä½œå‡å’Œç”Ÿå‘½å‘¨æœŸç›¸ç»‘å®šï¼Œé¿å…äº†å¸¸è§çš„å†…å­˜æ³„æ¼å’Œ NPE é—®é¢˜ï¼Œå¹¶æä¾›äº†äº¤ç”±å¤–éƒ¨ä½¿ç”¨è€…æ¥è‡ªå®šä¹‰å„ç§å…¶å®ƒè¡Œä¸ºçš„å…¥å£
- æä½çš„æ¥å…¥æˆæœ¬ã€‚ReactiveHttp å¹¶ä¸å¼ºåˆ¶è¦æ±‚å¤–éƒ¨å¿…é¡»ç»§æ‰¿äºä»»ä½• `BaseViewModel` æˆ–è€…æ˜¯ `BaseActivity/BaseFragment`ï¼Œå¤–éƒ¨åªè¦é€šè¿‡å®ç° `IUIActionEventObserver`ã€`IViewModelActionEvent` ä¸¤ä¸ªæ¥å£å³å¯äº«å— ReactiveHttp å¸¦æ¥çš„å„ä¸ªç›Šå¤„ã€‚å½“ç„¶ï¼Œå¦‚æœä½ ä¸éœ€è¦ ReactiveHttp çš„è‡ªåŠ¨åŒ–è¡Œä¸ºçš„è¯ï¼Œä¹Ÿå¯ä»¥ä¸å®ç°ä»»ä½•æ¥å£
- æ”¯æŒå¤šä¸ªï¼ˆä¸¤ä¸ª/ä¸‰ä¸ªï¼‰æ¥å£åŒæ—¶å¹¶å‘è¯·æ±‚ï¼Œåœ¨ç½‘ç»œè¯·æ±‚æˆåŠŸæ—¶åŒæ­¥å›è°ƒï¼Œæ‰€ä»¥ç†è®ºä¸Šå¤šä¸ªæ¥å£çš„æ€»è€—æ—¶å°±å–å†³äºè€—æ—¶æœ€é•¿çš„é‚£ä¸ªæ¥å£ï¼Œä»è€Œç¼©çŸ­ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

ReactiveHttp ä¸èƒ½å¸¦ç»™ä½ ä»€ä¹ˆï¼Ÿ

- ReactiveHttp æœ¬èº«çš„åº”ç”¨é¢†åŸŸæ˜¯ä¸“æ³¨äºæ¥å£è¯·æ±‚çš„ï¼Œæ‰€ä»¥å¯¹äºæ¥å£çš„è¿”å›å€¼å½¢å¼å¸¦æœ‰å¼ºåˆ¶çº¦æŸï¼Œä¸”æ²¡æœ‰å°è£…æ–‡ä»¶ä¸‹è½½ã€æ–‡ä»¶ä¸Šä¼ ç­‰åŠŸèƒ½
- è‚¯å®šæœ‰ï¼Œä½†è¿˜æ²¡æƒ³åˆ°

ReactiveHttp ç›®å‰å·²ç»åœ¨æˆ‘å¸é¡¹ç›®ä¸Šç¨³å®šè¿è¡Œä¸€å¹´å¤šäº†ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿæ˜¯åœ¨é€æ­¥ä¼˜åŒ–ï¼Œä½¿å…¶èƒ½å¤Ÿæ›´åŠ é€‚ç”¨äºå¤–éƒ¨ä¸åŒç¯å¢ƒçš„éœ€æ±‚ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘è§‰å¾—ä¹Ÿæ˜¯å·²ç»è¶³å¤Ÿç¨³å®šäº†ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

# ä¸‰ã€æ¶æ„è¯´æ˜

ç°åœ¨åº”è¯¥æœ‰ç™¾åˆ†ä¹‹ä¹åä»¥ä¸Šçš„ Android å®¢æˆ·ç«¯çš„ç½‘ç»œè¯·æ±‚æ˜¯ç›´æ¥æˆ–é—´æ¥ä¾é  OkHttp æ¥å®Œæˆçš„å§ï¼Ÿæœ¬æ–‡æ‰€è¯´çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶å°±æ˜¯æŒ‡ **åœ¨ OkHttp ä¹‹ä¸Šæ‰€åšçš„ä¸€å±‚å°è£…**ã€‚åŸç”Ÿçš„ OkHttp åœ¨ä½¿ç”¨ä¸Šå¹¶ä¸æ–¹ä¾¿ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯æœ‰ç‚¹ç¹çã€‚Retrofit åœ¨æ˜“ç”¨æ€§ä¸Šæœ‰æ‰€æå‡ï¼Œä½†æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨çš„è¯ä¹Ÿå¹¶ä¸ç®—å¤šç®€æ´ã€‚æ‰€ä»¥æˆ‘ä»¬å¾€å¾€éƒ½æ˜¯ä¼šæ ¹æ®é¡¹ç›®æ¶æ„è‡ªå·±æ¥å¯¹ OkHttp æˆ–è€… Retrofit è¿›è¡Œå¤šä¸€å±‚å°è£…ï¼ŒReactiveHttp çš„å®ç°å‡ºå‘ç‚¹å³æ˜¯å¦‚æ­¤

æ­¤å¤–ï¼Œç°åœ¨å¤§å¤šæ•°é¡¹ç›®éƒ½å¼•ç”¨åˆ°äº† Jetpack è¿™ä¸€å¥—ç»„ä»¶æ¥å®ç° MVVM æ¶æ„çš„å§ï¼ŸReactiveHttp å°† Jetpack å’Œ Retrofit å…³è”äº†èµ·æ¥ï¼Œä½¿å¾—ç½‘ç»œè¯·æ±‚è¿‡ç¨‹æ›´åŠ ç¬¦åˆâ€œå“åº”å¼â€æ¦‚å¿µï¼Œå¹¶æä¾›äº†æ›´åŠ å¯é çš„ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ€§å’Œè‡ªåŠ¨åŒ–è¡Œä¸º

ä¸€èˆ¬çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶æ˜¯åªä¸“æ³¨äºå®Œæˆç½‘ç»œè¯·æ±‚å¹¶é€ä¼ å‡ºç»“æœï¼ŒReactiveHttp ä¸å¤ªä¸€æ ·ã€‚ReactiveHttp åœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿˜å®ç°äº†å°†ç½‘ç»œè¯·æ±‚å’Œ ViewModel ä»¥åŠ Activity/Fragment ç›¸ç»‘å®šçš„åŠŸèƒ½ï¼ŒReactiveHttp å¸Œæœ›åšåˆ°çš„æ˜¯èƒ½å¤Ÿå°½é‡å®Œæˆå¤§å¤šæ•°çš„é€šç”¨è¡Œä¸ºï¼Œä¸”æ¯ä¸ªå±‚æ¬¡å‡ä¸å¼ºä¾èµ–äºç‰¹å®šçˆ¶ç±»

Google å®˜æ–¹æ›¾æ¨å‡ºè¿‡ä¸€ä»½æœ€ä½³åº”ç”¨æ¶æ„æŒ‡å—ã€‚å½“ä¸­ï¼Œæ¯ä¸ªç»„ä»¶ä»…ä¾èµ–äºå…¶ä¸‹ä¸€çº§çš„ç»„ä»¶ã€‚ViewModel æ˜¯**å…³æ³¨ç‚¹åˆ†ç¦»åŸåˆ™**çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œæ˜¯ä½œä¸ºç”¨æˆ·æ•°æ®çš„**æ‰¿è½½ä½“**å’Œ**å¤„ç†è€…**è€Œå­˜åœ¨çš„ï¼ŒActivity/Fragment ä»…ä¾èµ–äº ViewModelï¼ŒViewModel å°±ç”¨äºå“åº”ç•Œé¢å±‚çš„è¾“å…¥å’Œé©±åŠ¨ç•Œé¢å±‚å˜åŒ–ï¼ŒRepository ç”¨äºä¸º ViewModel æä¾›ä¸€ä¸ªå•ä¸€çš„æ•°æ®æ¥æºåŠæ•°æ®å­˜å‚¨åŸŸï¼ŒRepository å¯ä»¥åŒæ—¶ä¾èµ–äºæŒä¹…æ€§æ•°æ®æ¨¡å‹å’Œè¿œç¨‹æœåŠ¡å™¨æ•°æ®æº

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5f8113165aa44d0b1510f23e00f9831~tplv-k3u1fbpfcp-zoom-1.image)

ReactiveHttp çš„è®¾è®¡æ€æƒ³ç±»ä¼¼äº Google æ¨èçš„æœ€ä½³åº”ç”¨æ¶æ„æŒ‡å—

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43823dab5f4a427689af2baee1caf1a4~tplv-k3u1fbpfcp-zoom-1.image)

- BaseRemoteDataSource ä½œä¸ºæ•°æ®æä¾›è€…å¤„äºæœ€ä¸‹å±‚ï¼Œåªç”¨äºå‘ä¸Šå±‚æä¾›æ•°æ®ï¼Œæä¾›äº†å¤šä¸ªåŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚æ–¹æ³•ï¼Œå’Œ BaseReactiveViewModel ä¹‹é—´ä¾é  IUIActionEvent æ¥å£æ¥è”ç³»
- BaseReactiveViewModel ä½œä¸ºç”¨æˆ·æ•°æ®çš„æ‰¿è½½ä½“å’Œå¤„ç†è€…ï¼ŒåŒ…å«äº†å¤šä¸ªå’Œç½‘ç»œè¯·æ±‚äº‹ä»¶ç›¸å…³çš„ LiveData ç”¨äºé©±åŠ¨ç•Œé¢å±‚çš„ UI å˜åŒ–ï¼Œå’Œ BaseReactiveActivity ä¹‹é—´ä¾é  IViewModelActionEvent æ¥å£æ¥è”ç³»
- BaseReactiveActivity åŒ…å«ä¸ç³»ç»Ÿå’Œç”¨æˆ·äº¤äº’çš„é€»è¾‘ï¼Œå…¶è´Ÿè´£å“åº” BaseReactiveViewModel ä¸­çš„æ•°æ®å˜åŒ–ï¼Œæä¾›äº†å’Œ BaseReactiveViewModel è¿›è¡Œç»‘å®šçš„æ–¹æ³•

ä¸Šæ–‡æœ‰è¯´åˆ°ï¼ŒReactiveHttp æä¾›äº†åœ¨ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­è‡ªåŠ¨å®Œæˆ showLoadingã€dismissLoadingã€showToast ç­‰è¡Œä¸ºçš„èƒ½åŠ›ã€‚é¦–å…ˆï¼ŒBaseRemoteDataSource åœ¨ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­ä¼šé€šè¿‡ IUIActionEvent æ¥å£æ¥é€šçŸ¥ BaseReactiveViewModel éœ€è¦è§¦å‘çš„è¡Œä¸ºï¼Œä»è€Œè¿é”è§¦å‘ ShowLoadingLiveDataã€DismissLoadingLiveDataã€ShowToastLiveData å€¼çš„å˜åŒ–ï¼ŒBaseReactiveActivity å°±é€šè¿‡ç›‘å¬ LiveData å€¼çš„å˜åŒ–æ¥å®Œæˆ UI å±‚æ“ä½œ

# å››ã€ä»¥å‰çš„åšæ³•

ä»¥ä¸‹æ­¥éª¤åº”è¯¥æ˜¯å¤§éƒ¨åˆ†åº”ç”¨ç›®å‰è¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶çš„æƒ¯å¸¸åšæ³•äº†

æœåŠ¡ç«¯è¿”å›ç»™ç§»åŠ¨ç«¯çš„æ•°æ®ä½¿ç”¨å…·æœ‰ç‰¹å®šæ ¼å¼çš„ Json æ¥è¿›è¡Œé€šä¿¡ï¼Œç”¨æ•´æ•° `status` æ¥æ ‡æ˜æœ¬æ¬¡è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œåœ¨å¤±è´¥æ—¶åˆ™ç›´æ¥ `showToast(msg)`ï¼Œ`data`åˆ™éœ€è¦ç”¨æ³›å‹æ¥å£°æ˜äº†ï¼Œæœ€ç»ˆå°±å¯¹åº”ç§»åŠ¨ç«¯çš„ä¸€ä¸ª**æ³›å‹ç±»**ï¼Œç±»ä¼¼äº HttpWrapMode

```kotlin
{
    "status":200,
    "msg":"success",
    "data":""
}

data class HttpWrapMode<T>(val status: Int, val msg: String, val data: T)
```

ç„¶ååœ¨ interface ä¸­å£°æ˜ Api æ¥å£ï¼Œè¿™ä¹Ÿæ˜¯ä½¿ç”¨ Retrofit çš„æƒ¯å¸¸ç”¨æ³•ã€‚æ ¹æ®é¡¹ç›®ä¸­çš„å®é™…æƒ…å†µï¼Œå¼€å‘è€…å¯èƒ½æ˜¯ä½¿ç”¨ Call æˆ–è€… Observable ä½œä¸ºæ¯ä¸ªæ¥å£è¿”å›å€¼çš„æœ€å¤–å±‚çš„æ•°æ®åŒ…è£…ç±»ï¼Œç„¶åå†ä½¿ç”¨ HttpWrapMode æ¥ä½œä¸ºå…·ä½“æ•°æ®ç±»çš„åŒ…è£…ç±»

```kotlin
interface ApiService {

    @POST("api1")
    fun api1(): Observable<HttpWrapMode<Int>>
    
    @GET("api2")
    fun api2(): Call<HttpWrapMode<String>>

}
```

ç„¶åé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ RxJavaï¼Œé‚£ä¹ˆå°±éœ€è¦åƒä»¥ä¸‹è¿™æ ·æ¥å®Œæˆç½‘ç»œè¯·æ±‚

```kotlin
    val retrofit = Retrofit.Builder()
        .baseUrl("https://xxx.com")
        .addConverterFactory(GsonConverterFactory.create())
        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
        .build()
    val service = retrofit.create(ApiService::class.java)
    val call: Observable<HttpWrapMode<Int>> = service.api1()
    call.subscribe(object : Consumer<HttpWrapMode<Int>> {
        override fun accept(mode: HttpWrapMode<Int>?) {
           
        }

    }, object : Consumer<Throwable> {
        override fun accept(t: Throwable?) {
            
        }
    })
```

# äº”ã€ReactiveHttp ç®€å•å…¥é—¨

ReactiveHttp åœ¨ä½¿ç”¨ä¸Šä¼šæ¯”ä¸Šé¢ç»™å‡ºçš„ä¾‹å­ç®€å•å¾ˆå¤šï¼Œä¸‹é¢å°±æ¥çœ‹ä¸‹é€šè¿‡ ReactiveHttp å¦‚ä½•å®Œæˆç½‘ç»œè¯·æ±‚

ReactiveHttp éœ€è¦çŸ¥é“ç½‘ç»œè¯·æ±‚çš„ç»“æœï¼Œä½†ä¸çŸ¥é“å¤–éƒ¨ä¼šä½¿ç”¨ä»€ä¹ˆå­—æ®µåæ¥æ ‡è¯† HttpWrapMode ä¸­çš„ä¸‰ä¸ªå€¼ï¼Œæ‰€ä»¥éœ€è¦å¤–éƒ¨å®ç° `IHttpWrapMode` æ¥å£æ¥è¿›è¡Œæ ‡æ˜ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·æ¥å®ç°ï¼š

```kotlin
data class HttpWrapMode<T>(val status: Int, val msg: String, val data: T) : IHttpWrapMode<T> {

    override val httpCode: Int
        get() = status

    override val httpMsg: String
        get() = msg

    override val httpData: T
        get() = data

    //ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ
    override val httpIsSuccess: Boolean
        get() = status == 200

}
```

ç”¨`suspend`æ¥ä¿®é¥°æ¥å£æ–¹æ³•ï¼Œä¸”ä¸éœ€è¦å…¶å®ƒçš„å¤–å±‚åŒ…è£…ç±»ã€‚`suspend`æ˜¯ kotlin åç¨‹å¼•å…¥çš„ï¼Œå½“ç”¨è¯¥å…³é”®å­—ä¿®é¥°æ¥å£æ–¹æ³•æ—¶ï¼ŒRetrofit å†…éƒ¨å°±ä¼šä½¿ç”¨åç¨‹çš„æ–¹å¼æ¥å®Œæˆè¯¥ç½‘ç»œè¯·æ±‚

```kotlin
interface ApiService {

    @GET("config/district")
    suspend fun getProvince(): HttpWrapMode<List<DistrictMode>>

}
```

ReactiveHttp æä¾›äº† RemoteExtendDataSource äº¤ç”±å¤–éƒ¨æ¥ç»§æ‰¿å®ç°ã€‚RemoteExtendDataSource åŒ…å«äº†æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚æ–¹æ³•ï¼Œå¤–éƒ¨ä»…éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥ä¼ å…¥ä¸¤ä¸ªå¿…è¦çš„å­—æ®µï¼Œå¹¶å®ç°ä¸€ä¸ªå¿…è¦çš„æ–¹æ³•å³å¯

- httpBaseUrlã€‚å³ç½‘ç»œè¯·æ±‚æ—¶çš„ BaseUrl
- apiServiceClassã€‚å³ ApiService çš„ Class å¯¹è±¡
- showToastã€‚å½“ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ï¼Œé€šè¿‡è¯¥æ–¹æ³•æ¥å‘ç”¨æˆ·æç¤ºå¤±è´¥åŸå› 

ä¾‹å¦‚ï¼Œä½ å¯ä»¥åƒä»¥ä¸‹è¿™æ ·æ¥å®ç°ä½ è‡ªå·±é¡¹ç›®ä¸“å±çš„ DataSourceï¼Œå½“ä¸­å°±åŒ…å«äº†å¼€å‘è€…æ•´ä¸ªé¡¹ç›®çš„å…¨å±€ç½‘ç»œè¯·æ±‚é…ç½®

```kotlin
class SelfRemoteDataSource(iActionEvent: IUIActionEvent?) : RemoteExtendDataSource<ApiService>(
    iActionEvent = iActionEvent,
    httpBaseUrl = HttpConfig.BASE_URL_MAP,
    apiServiceClass = ApiService::class.java
) {

    companion object {

        private val httpClient: OkHttpClient by lazy {
            createHttpClient()
        }

        private fun createHttpClient(): OkHttpClient {
            val builder = OkHttpClient.Builder()
                .readTimeout(1000L, TimeUnit.MILLISECONDS)
                .writeTimeout(1000L, TimeUnit.MILLISECONDS)
                .connectTimeout(1000L, TimeUnit.MILLISECONDS)
                .retryOnConnectionFailure(true)
                .addInterceptor(FilterInterceptor())
                .addInterceptor(MonitorInterceptor(MainApplication.context))
            return builder.build()
        }

    }

    /**
     * è‡ªå·±æ¥å®ç°åˆ›å»º Retrofit çš„é€»è¾‘
     * æ­¤å¤„æ— éœ€ç¼“å­˜ Retrofit å®ä¾‹ï¼ŒReactiveHttp å†…éƒ¨å·²åšå¥½ç¼“å­˜å¤„ç†
     * ä½†å¤–éƒ¨éœ€è¦è‡ªå·±åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹ OKHttpClient è¿›è¡Œç¼“å­˜
     * @param baseUrl
     */
    override fun createRetrofit(baseUrl: String): Retrofit {
        return Retrofit.Builder()
            .client(httpClient)
            .baseUrl(baseUrl)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    override fun showToast(msg: String) {
        Toast.makeText(MainApplication.context, msg, Toast.LENGTH_SHORT).show()
    }

}
```

ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¾é  SelfRemoteDataSource åœ¨ä»»æ„åœ°æ–¹å‘èµ·ç½‘ç»œè¯·æ±‚äº†ï¼ŒæŒ‰éœ€å£°æ˜ Callbackã€‚æ­¤å¤–ï¼Œç”±äºä½¿ç”¨åˆ°äº†æ‰©å±•å‡½æ•°ï¼Œæ‰€ä»¥ SelfRemoteDataSource ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ ApiService ä¸­çš„æ¥å£æ–¹æ³•ï¼Œæ— éœ€ç‰¹æ„å¼•ç”¨å’Œå¯¼åŒ…

```kotlin
	private val remoteDataSource = SelfRemoteDataSource(null)

    val provinceLiveData = MutableLiveData<List<DistrictMode>>()

    fun reqProvince() {
        //enqueueLoading æ–¹æ³•ä¼šåœ¨å‘èµ·ç½‘ç»œè¯·æ±‚çš„æ—¶å€™åŒæ—¶å¼¹å‡º loading æ¡†
        //enqueue æ–¹æ³•åˆ™ä¸ä¼šå¼¹å‡º loading æ¡†
        remoteDataSource.enqueueLoading({
            getProvince()
        }) {
            /**
             * åœ¨æ˜¾ç¤º Loading ä¹‹åä¸”å¼€å§‹ç½‘ç»œè¯·æ±‚ä¹‹å‰æ‰§è¡Œ
             */
            onStart {

            }
            /**
             * å½“ç½‘ç»œè¯·æ±‚æˆåŠŸæ—¶å›è°ƒ
             */
            onSuccess {
                provinceLiveData.value = it
            }
            /**
             * å½“å–æ¶ˆç½‘ç»œè¯·æ±‚æ—¶å°±ä¼šå›è°ƒæ­¤æ–¹æ³•
             */
            onCancelled {

            }
            /**
             * å½“ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œåœ¨ onFinally è¢«è°ƒç”¨ä¹‹å‰æ‰§è¡Œ
             */
            onFailed {
                val httpException = it
                val realException = httpException.realException
                val errorCode = httpException.errorCode
            }
            /**
             * ç”¨äºæ§åˆ¶æ˜¯å¦å½“ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ Toast å¤±è´¥åŸå› 
             * é»˜è®¤ä¸º trueï¼Œå³ä¼š Toast æç¤º
             */
            onFailToast {
                true
            }
            /**
             * åœ¨ç½‘ç»œè¯·æ±‚ç»“æŸä¹‹åï¼ˆä¸ç®¡è¯·æ±‚æˆåŠŸä¸å¦ï¼‰ä¸”éšè— Loading ä¹‹å‰æ‰§è¡Œ
             */
            onFinally {

            }
        }
    }
```

# å…­ã€ReactiveHttp è¿›é˜¶ä½¿ç”¨

ä¸Šè¿°åœ¨ä½¿ç”¨ SelfRemoteDataSource å‘èµ·ç½‘ç»œè¯·æ±‚æ—¶è™½ç„¶è°ƒç”¨çš„æ˜¯ `enqueueLoading` æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå¹¶ä¸ä¼šå¼¹å‡º loading æ¡†ï¼Œå› ä¸ºå®Œæˆ ShowLoadingã€DismissLoadingã€ShowToast ç­‰ UI è¡Œä¸ºæ˜¯éœ€è¦ RemoteDataSourceã€ViewModel å’Œ Activity è¿™ä¸‰è€…ä¸€èµ·è¿›è¡Œé…åˆçš„ï¼Œå³ SelfRemoteDataSource éœ€è¦å’Œå…¶å®ƒä¸¤è€…å…³è”ä¸Šï¼Œå°†éœ€è¦è§¦å‘çš„ UI è¡Œä¸ºåé¦ˆç»™ Activity

è¿™å¯ä»¥é€šè¿‡ç›´æ¥ç»§æ‰¿äº BaseReactiveActivity å’Œ BaseReactiveViewModel æ¥å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®ç°ç›¸åº”æ¥å£æ¥å®Œæˆå…³è”ã€‚å½“ç„¶ï¼Œå¦‚æœä½ ä¸éœ€è¦ ReactiveHttp çš„å„ä¸ªè‡ªåŠ¨åŒ–è¡Œä¸ºçš„è¯ï¼Œä¹Ÿå¯ä»¥ä¸åšä»¥ä¸‹ä»»ä½•æ”¹åŠ¨

æ€»çš„æ¥è¯´ï¼ŒReactiveHttp å…·æœ‰æä½çš„æ¥å…¥æˆæœ¬

## 1ã€BaseReactiveActivity

BaseReactiveActivity æ˜¯ ReactiveHttp æä¾›çš„ä¸€ä¸ªé»˜è®¤ BaseActivityï¼Œå…¶å®ç°äº† IUIActionEventObserver æ¥å£ï¼Œç”¨äºæä¾›ä¸€äº›é»˜è®¤å‚æ•°å’Œé»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ CoroutineScope å’Œ showLoading

ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®æ˜¯ä¸ä¼šå»ç»§æ‰¿å¤–éƒ¨ Activity çš„ï¼Œè€Œæ˜¯ä¼šæœ‰ä¸€ä¸ªè‡ªå·±å®ç°çš„å…¨å±€ç»Ÿä¸€çš„ BaseActivityï¼Œæ‰€ä»¥å¦‚æœä½ ä¸æƒ³ç»§æ‰¿ BaseReactiveActivity çš„è¯ï¼Œå¯ä»¥ä»¿ç…§ BaseReactiveActivity è‡ªå·±æ¥å®ç° IUIActionEventObserver æ¥å£ï¼Œå°±åƒä»¥ä¸‹è¿™æ ·

```kotlin
class BaseReactiveActivity : AppCompatActivity(), IUIActionEventObserver {

    protected inline fun <reified VM> getViewModel(
        factory: ViewModelProvider.Factory? = null,
        noinline initializer: (VM.(lifecycleOwner: LifecycleOwner) -> Unit)? = null
    ): Lazy<VM> where VM : ViewModel, VM : IViewModelActionEvent {
        return getViewModel(VM::class.java, factory, initializer)
    }

    override val lifecycleSupportedScope: CoroutineScope
        get() = lifecycleScope

    override val lContext: Context?
        get() = this

    override val lLifecycleOwner: LifecycleOwner
        get() = this

    private var loadDialog: ProgressDialog? = null

    override fun showLoading(job: Job?) {
        dismissLoading()
        loadDialog = ProgressDialog(lContext).apply {
            setCancelable(true)
            setCanceledOnTouchOutside(false)
            //ç”¨äºå®ç°å½“å¼¹çª—é”€æ¯çš„æ—¶å€™åŒæ—¶å–æ¶ˆç½‘ç»œè¯·æ±‚
//            setOnDismissListener {
//                job?.cancel()
//            }
            show()
        }
    }

    override fun dismissLoading() {
        loadDialog?.takeIf { it.isShowing }?.dismiss()
        loadDialog = null
    }

    override fun showToast(msg: String) {
        if (msg.isNotBlank()) {
            Toast.makeText(this, msg, Toast.LENGTH_SHORT).show()
        }
    }

    override fun finishView() {
        finish()
    }

    override fun onDestroy() {
        super.onDestroy()
        dismissLoading()
    }

}
```

## 2ã€BaseReactiveViewModel

ç±»ä¼¼åœ°ï¼ŒBaseReactiveViewModel æ˜¯ ReactiveHttp æä¾›çš„ä¸€ä¸ªé»˜è®¤çš„ BaseViewModelï¼Œå…¶å®ç°äº† IViewModelActionEvent æ¥å£ï¼Œç”¨äºæ¥æ”¶ RemoteDataSource å‘èµ·çš„ UI å±‚è¡Œä¸ºã€‚å¦‚æœä½ ä¸å¸Œæœ›ç»§æ‰¿äº BaseReactiveViewModel çš„è¯ï¼Œå¯ä»¥è‡ªå·±æ¥å®ç° IViewModelActionEvent æ¥å£ï¼Œå°±åƒä»¥ä¸‹è¿™æ ·

```kotlin
open class BaseReactiveViewModel : ViewModel(), IViewModelActionEvent {

    override val lifecycleSupportedScope: CoroutineScope
        get() = viewModelScope

    override val showLoadingEventLD = MutableLiveData<ShowLoadingEvent>()

    override val dismissLoadingEventLD = MutableLiveData<DismissLoadingEvent>()

    override val showToastEventLD = MutableLiveData<ShowToastEvent>()

    override val finishViewEventLD = MutableLiveData<FinishViewEvent>()

}
```

## 3ã€å…³è”ä¸Š

å®Œæˆä»¥ä¸Šä¸¤æ­¥åï¼Œå¼€å‘è€…å°±å¯ä»¥åƒå¦‚ä¸‹æ‰€ç¤ºè¿™æ ·å°† RemoteDataSourceã€ViewModel å’Œ Activity è¿™ä¸‰è€…ç»™å…³è”èµ·æ¥ã€‚WeatherActivity é€šè¿‡ `getViewModel` æ–¹æ³•æ¥å®Œæˆ WeatherViewModel çš„åˆå§‹åŒ–å’Œå†…éƒ¨å¤šä¸ª UILiveData çš„ç»‘å®šï¼Œå¹¶åœ¨ lambda è¡¨è¾¾å¼ä¸­å®Œæˆå¯¹ WeatherViewModel å†…éƒ¨å’Œå…·ä½“ä¸šåŠ¡ç›¸å…³çš„ DataLiveData çš„æ•°æ®ç›‘å¬ï¼Œè‡³æ­¤æ‰€æœ‰è‡ªåŠ¨åŒ–è¡Œä¸ºå°±éƒ½å·²ç»ç»‘å®šä¸Šäº†

```kotlin
class WeatherViewModel : BaseReactiveViewModel() {

    private val remoteDataSource by lazy {
        SelfRemoteDataSource(this)
    }

    val forecastsModeLiveData = MutableLiveData<ForecastsMode>()

    fun getWeather(city: String) {
        remoteDataSource.enqueue({
            getWeather(city)
        }) {
            onSuccess {
                if (it.isNotEmpty()) {
                    forecastsModeLiveData.value = it[0]
                }
            }
        }
    }

}

class WeatherActivity : BaseReactiveActivity() {

    private val weatherViewModel by getViewModel<WeatherViewModel> {
        forecastsModeLiveData.observe(this@WeatherActivity, {
            showWeather(it)
        })
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_weather)
        weatherViewModel.getWeather("adCode")
    }

    private fun showWeather(forecastsMode: ForecastsMode) {

    }

}
```

# ä¸ƒã€å…¶å®ƒ

## 1ã€RemoteDataSource

RemoteExtendDataSource æä¾›äº†è®¸å¤šä¸ªå¯ä»¥è¿›è¡Œå¤å†™çš„æ–¹æ³•ï¼Œæ—¢å¯ç”¨äºé…ç½® OkHttp çš„å„ä¸ªç½‘ç»œè¯·æ±‚å‚æ•°ï¼Œä¹Ÿç”¨äºäº¤ç”±å¤–éƒ¨è¿›è¡Œæµç¨‹æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·æ¥å®ç°è‡ªå·±é¡¹ç›®çš„ RemoteDataSource

```kotlin
class SelfRemoteDataSource(iActionEvent: IUIActionEvent?) : RemoteExtendDataSource<ApiService>(
    iActionEvent = iActionEvent,
    httpBaseUrl = HttpConfig.BASE_URL_MAP,
    apiServiceClass = ApiService::class.java
) {

    companion object {

        private val httpClient: OkHttpClient by lazy {
            createHttpClient()
        }

        private fun createHttpClient(): OkHttpClient {
            val builder = OkHttpClient.Builder()
                .readTimeout(1000L, TimeUnit.MILLISECONDS)
                .writeTimeout(1000L, TimeUnit.MILLISECONDS)
                .connectTimeout(1000L, TimeUnit.MILLISECONDS)
                .retryOnConnectionFailure(true)
                .addInterceptor(FilterInterceptor())
                .addInterceptor(MonitorInterceptor(MainApplication.context))
            return builder.build()
        }

    }

    /**
     * å…è®¸å­ç±»è‡ªå·±æ¥å®ç°åˆ›å»º Retrofit çš„é€»è¾‘
     * å¤–éƒ¨æ— éœ€ç¼“å­˜ Retrofit å®ä¾‹ï¼ŒReactiveHttp å†…éƒ¨å·²åšå¥½ç¼“å­˜å¤„ç†
     * ä½†å¤–éƒ¨éœ€è¦è‡ªå·±åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹ OKHttpClient è¿›è¡Œç¼“å­˜
     * @param baseUrl
     */
    override fun createRetrofit(baseUrl: String): Retrofit {
        return Retrofit.Builder()
            .client(httpClient)
            .baseUrl(baseUrl)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    /**
     * å¦‚æœå¤–éƒ¨æƒ³è¦å¯¹ Throwable è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œåˆ™å¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œç”¨äºæ”¹å˜ Exception ç±»å‹
     * ä¾‹å¦‚ï¼Œåœ¨ token å¤±æ•ˆæ—¶æ¥å£ä¸€èˆ¬æ˜¯ä¼šè¿”å›ç‰¹å®šä¸€ä¸ª httpCode ç”¨äºè¡¨æ˜ç§»åŠ¨ç«¯éœ€è¦å»æ›´æ–° token äº†
     * æ­¤æ—¶å¤–éƒ¨å°±å¯ä»¥å®ç°ä¸€ä¸ª BaseException çš„å­ç±» TokenInvalidException å¹¶åœ¨æ­¤å¤„è¿”å›
     * ä»è€Œåšåˆ°æ¥å£å¼‚å¸¸åŸå› å¼ºæé†’çš„æ•ˆæœï¼Œè€Œä¸ç”¨å»çº ç»“ httpCode åˆ°åº•æ˜¯å¤šå°‘
     */
    override fun generateBaseException(throwable: Throwable): BaseHttpException {
        return if (throwable is BaseHttpException) {
            throwable
        } else {
            LocalBadException(throwable)
        }
    }

    /**
     * ç”¨äºç”±å¤–éƒ¨ä¸­è½¬æ§åˆ¶å½“æŠ›å‡ºå¼‚å¸¸æ—¶æ˜¯å¦èµ° onFail å›è°ƒï¼Œå½“è¿”å› true æ—¶åˆ™å›è°ƒï¼Œå¦åˆ™ä¸å›è°ƒ
     * åŒæ—¶åœ¨è¿™é‡Œå°†ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸åé¦ˆç»™å¤–éƒ¨ï¼Œä»¥ä¾¿å¤–éƒ¨ä¸ŠæŠ¥å¼‚å¸¸
     * @param httpException
     */
    override fun exceptionHandle(httpException: BaseHttpException): Boolean {
        return true
    }

    /**
     * ç”¨äºå¯¹ BaseException è¿›è¡Œæ ¼å¼åŒ–ï¼Œä»¥ä¾¿åœ¨è¯·æ±‚å¤±è´¥æ—¶ Toast æç¤ºé”™è¯¯ä¿¡æ¯
     * @param httpException
     */
    override fun exceptionFormat(httpException: BaseHttpException): String {
        return when (httpException.realException) {
            null -> {
                httpException.errorMessage
            }
            is ConnectException, is SocketTimeoutException, is UnknownHostException -> {
                "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®"
            }
            else -> {
                "è¯·æ±‚è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸ï¼š" + httpException.errorMessage
            }
        }
    }

    override fun showToast(msg: String) {
        Toast.makeText(MainApplication.context, msg, Toast.LENGTH_SHORT).show()
    }

}
```

æ­¤å¤–ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨è‡ªå·±çš„ BaseViewModel ä¸­å£°æ˜ä¸€ä¸ª DataSource å˜é‡å®ä¾‹ï¼Œæ‰€æœ‰å­ ViewModel éƒ½å…¨å±€ç»Ÿä¸€ä½¿ç”¨åŒä¸€ä»½ DataSource é…ç½®ã€‚å¦‚æœæœ‰æŸäº›ç‰¹å®šæ¥å£éœ€è¦ä½¿ç”¨ä¸åŒçš„ BaseUrl çš„è¯ï¼Œä¹Ÿå¯ä»¥å†å¤šå£°æ˜ä¸€ä¸ª DataSource å¯¹è±¡

```kotlin
open class BaseViewModel : BaseReactiveViewModel() {

    /**
     * æ­£å¸¸æ¥è¯´å•ä¸ªé¡¹ç›®ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ª RemoteDataSource å®ç°ç±»ï¼Œå³å…¨å±€ä½¿ç”¨åŒä¸€ä»½é…ç½®
     * ä½†çˆ¶ç±»ä¹Ÿåº”è¯¥å…è®¸å­ç±»ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ RemoteDataSource
     */
    protected open val remoteDataSource by lazy {
        SelfRemoteDataSource(this)
    }

}
```

## 2ã€BaseHttpException

BaseHttpException æ˜¯ ReactiveHttp å¯¹ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿçš„å„ç±»å¼‚å¸¸æƒ…å†µçš„åŒ…è£…ç±»ï¼Œä»»ä½•é€ä¼ åˆ°å¤–éƒ¨çš„å¼‚å¸¸ä¿¡æ¯å‡ä¼šè¢«å°è£…ä¸º BaseHttpException ç±»å‹ã€‚BaseHttpException æœ‰ä¸¤ä¸ªé»˜è®¤å­ç±»ï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºæœåŠ¡å™¨å¼‚å¸¸å’Œæœ¬åœ°å¼‚å¸¸

```kotlin
/**
 * @param errorCode        æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ç  æˆ–è€…æ˜¯ HttpConfig ä¸­å®šä¹‰çš„æœ¬åœ°é”™è¯¯ç 
 * @param errorMessage     æœåŠ¡å™¨è¿”å›çš„å¼‚å¸¸ä¿¡æ¯ æˆ–è€…æ˜¯ è¯·æ±‚è¿‡ç¨‹ä¸­æŠ›å‡ºçš„ä¿¡æ¯ï¼Œæ˜¯æœ€åŸå§‹çš„å¼‚å¸¸ä¿¡æ¯
 * @param realException    ç”¨äºå½“ code æ˜¯æœ¬åœ°é”™è¯¯ç æ—¶ï¼Œå­˜å‚¨çœŸå®çš„è¿è¡Œæ—¶å¼‚å¸¸
 */
open class BaseHttpException(
    val errorCode: Int,
    val errorMessage: String,
    val realException: Throwable?
) : Exception(errorMessage) {

    companion object {

        /**
         * æ­¤å˜é‡ç”¨äºè¡¨ç¤ºåœ¨ç½‘ç»œè¯·æ±‚è¿‡ç¨‹è¿‡ç¨‹ä¸­æŠ›å‡ºäº†å¼‚å¸¸
         */
        const val CODE_ERROR_LOCAL_UNKNOWN = -1024520

    }

    /**
     * æ˜¯å¦æ˜¯ç”±äºæœåŠ¡å™¨è¿”å›çš„ code != successCode å¯¼è‡´çš„å¼‚å¸¸
     */
    val isServerCodeBadException: Boolean
        get() = this is ServerCodeBadException

    /**
     * æ˜¯å¦æ˜¯ç”±äºç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆä¾‹å¦‚ï¼šæœåŠ¡å™¨è¿”å›çš„ Json è§£æå¤±è´¥ï¼‰
     */
    val isLocalBadException: Boolean
        get() = this is LocalBadException

}

/**
 * API è¯·æ±‚æˆåŠŸäº†ï¼Œä½† code != successCode
 * @param errorCode
 * @param errorMessage
 */
class ServerCodeBadException(errorCode: Int, errorMessage: String) :
    BaseHttpException(errorCode, errorMessage, null) {

    constructor(mode: IHttpWrapMode<*>) : this(mode.httpCode, mode.httpMsg)

}

/**
 * è¯·æ±‚è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸
 * @param throwable
 */
class LocalBadException(throwable: Throwable) : BaseHttpException(
    CODE_ERROR_LOCAL_UNKNOWN, throwable.message
        ?: "", throwable
)
```

æœ‰æ—¶å€™å¼€å‘è€…éœ€è¦å¯¹æŸäº›å¼‚å¸¸æƒ…å†µè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œæ­¤æ—¶å°±å¯ä»¥æ¥å®ç°è‡ªå·±çš„ BaseHttpException å­ç±»ã€‚ä¾‹å¦‚ï¼Œåœ¨ token å¤±æ•ˆæ—¶æ¥å£ä¸€èˆ¬æ˜¯ä¼šè¿”å›ç‰¹å®šä¸€ä¸ª httpCode ç”¨äºè¡¨æ˜ç§»åŠ¨ç«¯éœ€è¦å»æ›´æ–° token äº†ï¼Œæ­¤æ—¶å¼€å‘è€…å°±å¯ä»¥å®ç°ä¸€ä¸ª BaseHttpException çš„å­ç±» TokenInvalidException å¹¶åœ¨ `generateBaseException` æ–¹æ³•ä¸­è¿”å›ï¼Œä»è€Œåšåˆ°æ¥å£å¼‚å¸¸åŸå› å¼ºæé†’çš„æ•ˆæœï¼Œè€Œä¸ç”¨å»çº ç»“ httpCode åˆ°åº•æ˜¯å¤šå°‘

```kotlin
class TokenInvalidException : BaseHttpException(CODE_TOKEN_INVALID, "token å·²å¤±æ•ˆ", null)

class SelfRemoteDataSource(iActionEvent: IUIActionEvent?) : RemoteExtendDataSource<ApiService>(
    iActionEvent = iActionEvent,
    httpBaseUrl = HttpConfig.BASE_URL_MAP,
    apiServiceClass = ApiService::class.java
) {

    /**
     * å¦‚æœå¤–éƒ¨æƒ³è¦å¯¹ Throwable è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œåˆ™å¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œç”¨äºæ”¹å˜ Exception ç±»å‹
     * ä¾‹å¦‚ï¼Œåœ¨ token å¤±æ•ˆæ—¶æ¥å£ä¸€èˆ¬æ˜¯ä¼šè¿”å›ç‰¹å®šä¸€ä¸ª httpCode ç”¨äºè¡¨æ˜ç§»åŠ¨ç«¯éœ€è¦å»æ›´æ–° token äº†
     * æ­¤æ—¶å¤–éƒ¨å°±å¯ä»¥å®ç°ä¸€ä¸ª BaseException çš„å­ç±» TokenInvalidException å¹¶åœ¨æ­¤å¤„è¿”å›
     * ä»è€Œåšåˆ°æ¥å£å¼‚å¸¸åŸå› å¼ºæé†’çš„æ•ˆæœï¼Œè€Œä¸ç”¨å»çº ç»“ httpCode åˆ°åº•æ˜¯å¤šå°‘
     */
    override fun generateBaseException(throwable: Throwable): BaseHttpException {
        if (throwable is ServerCodeBadException && throwable.errorCode == BaseHttpException.CODE_TOKEN_INVALID) {
            return TokenInvalidException()
        }
        return if (throwable is BaseHttpException) {
            throwable
        } else {
            LocalBadException(throwable)
        }
    }

}
```

# å…«ã€ç»“å°¾

ä»¥ä¸Šå·²ç»é˜è¿°äº† ReactiveHttp çš„å¤§éƒ¨åˆ†é‡ç‚¹å†…å®¹ï¼Œä½†ç”±äºæˆ‘çš„æ–‡ç¬”ä»¥åŠè¡¨è¾¾èƒ½åŠ›é—®é¢˜ï¼Œæœ‰äº›è¯»è€…å¯èƒ½è¿˜æ˜¯ä¼šçœ‹å¾—äº‘é‡Œé›¾é‡Œï¼Œå»ºè®®è¿˜æ˜¯å°†ä»£ç  clone ä¸‹æ¥å®é™…ä½“éªŒä¸‹ã€‚ReactiveHttp çš„ç¤ºä¾‹ä»£ç åŒ…å«äº†ä¸€ä¸ªå®Œæ•´çš„å¤©æ°”é¢„æŠ¥åŠŸèƒ½ï¼Œé€šè¿‡ç¤ºä¾‹ä»£ç å¯ä»¥å¸®åŠ©ä½ æ›´å¿«å…¥é—¨ ğŸ˜‡ğŸ˜‡

æ­¤å¤–å†è¡¥å……ä¸€ç‚¹ï¼ŒReactiveHttp çš„ GitHub æäº¤å†å²ç°åœ¨çœ‹æ˜¯ä» 2020 å¹´ 12 æœˆä»½å¼€å§‹çš„ï¼Œè€Œ 1.0 ç‰ˆæœ¬çš„æ–‡ç« æ˜¯æˆ‘åœ¨ 2019 å¹´ 2 æœˆä»½å‘å¸ƒçš„ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘è§‰å¾—æ—§ä»£ç ç•™æœ‰å¤ªå¤šå†—ä½™èµ„æºï¼Œå¯¼è‡´ clone å¤ªæ…¢ï¼Œæ‰€ä»¥ä»£ç è¢«æˆ‘é‡ç½®äº†ï¼Œä¸‰ä¸ªç‰ˆæœ¬åˆ†åˆ«å¯¹åº”ä¸‰æ¡åˆ†æ”¯ã€‚1.0 ç‰ˆæœ¬å’Œ 2.0 ç‰ˆæœ¬åªä¿ç•™äº†å½“æ—¶çš„æœ€åä¸€æ¬¡æäº¤ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚ç…§æˆ‘ä»¥å‰çš„ä¸¤ç¯‡æ–‡ç« 

ç‚¹å‡»è·³è½¬åˆ° GitHubï¼š[ReactiveHttp](https://github.com/leavesCZY/ReactiveHttp)