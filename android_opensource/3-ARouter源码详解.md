> å…¬ä¼—å·ï¼š[å­—èŠ‚æ•°ç»„](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image)
>
> å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

> å¯¹äº Android Developer æ¥è¯´ï¼Œå¾ˆå¤šå¼€æºåº“éƒ½æ˜¯å±äº**å¼€å‘å¿…å¤‡**çš„çŸ¥è¯†ç‚¹ï¼Œä»ä½¿ç”¨æ–¹å¼åˆ°å®ç°åŸç†å†åˆ°æºç è§£æï¼Œè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬æœ‰ä¸€å®šç¨‹åº¦çš„äº†è§£å’Œè¿ç”¨èƒ½åŠ›ã€‚æ‰€ä»¥æˆ‘æ‰“ç®—æ¥å†™ä¸€ç³»åˆ—å…³äºå¼€æºåº“**æºç è§£æ**å’Œ**å®æˆ˜æ¼”ç»ƒ**çš„æ–‡ç« ï¼Œåˆå®šçš„ç›®æ ‡æ˜¯ **EventBusã€ARouterã€LeakCanaryã€Retrofitã€Glideã€OkHttpã€Coil** ç­‰ä¸ƒä¸ªçŸ¥åå¼€æºåº“ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£

# ä¸€ã€ARouter

è·¯ç”±æ¡†æ¶åœ¨å¤§å‹é¡¹ç›®ä¸­æ¯”è¾ƒå¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ª module çš„æ—¶å€™ã€‚ä¸ºäº†å®ç°ç»„ä»¶åŒ–ï¼Œå¤šä¸ª module é—´çš„é€šä¿¡å°±ä¸èƒ½ç›´æ¥ä»¥æ¨¡å—é—´çš„å¼•ç”¨æ¥å®ç°ï¼Œæ­¤æ—¶å°±éœ€è¦ä¾èµ–è·¯ç”±æ¡†æ¶æ¥å®ç°æ¨¡å—é—´çš„é€šä¿¡å’Œè§£è€¦

è€Œ ARouter å°±æ˜¯ä¸€ä¸ªç”¨äºå¸®åŠ© Android App è¿›è¡Œç»„ä»¶åŒ–æ”¹é€ çš„æ¡†æ¶ï¼Œæ”¯æŒæ¨¡å—é—´çš„è·¯ç”±ã€é€šä¿¡ã€è§£è€¦

## æ”¯æŒçš„åŠŸèƒ½

1. æ”¯æŒç›´æ¥è§£ææ ‡å‡† URL è¿›è¡Œè·³è½¬ï¼Œå¹¶è‡ªåŠ¨æ³¨å…¥å‚æ•°åˆ°ç›®æ ‡é¡µé¢ä¸­
2. æ”¯æŒå¤šæ¨¡å—å·¥ç¨‹ä½¿ç”¨
3. æ”¯æŒæ·»åŠ å¤šä¸ªæ‹¦æˆªå™¨ï¼Œè‡ªå®šä¹‰æ‹¦æˆªé¡ºåº
4. æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œå¯å•ç‹¬ä½œä¸ºä¾èµ–æ³¨å…¥æ¡†æ¶ä½¿ç”¨
5. æ”¯æŒ InstantRun
6. æ”¯æŒ MultiDex (Google æ–¹æ¡ˆ)
7. æ˜ å°„å…³ç³»æŒ‰ç»„åˆ†ç±»ã€å¤šçº§ç®¡ç†ï¼ŒæŒ‰éœ€åˆå§‹åŒ–
8. æ”¯æŒç”¨æˆ·æŒ‡å®šå…¨å±€é™çº§ä¸å±€éƒ¨é™çº§ç­–ç•¥
9. é¡µé¢ã€æ‹¦æˆªå™¨ã€æœåŠ¡ç­‰ç»„ä»¶å‡è‡ªåŠ¨æ³¨å†Œåˆ°æ¡†æ¶
10. æ”¯æŒå¤šç§æ–¹å¼é…ç½®è½¬åœºåŠ¨ç”»
11. æ”¯æŒè·å– Fragment
12. å®Œå…¨æ”¯æŒ Kotlin ä»¥åŠæ··ç¼–(é…ç½®è§æ–‡æœ« å…¶ä»–#5)
13. æ”¯æŒç¬¬ä¸‰æ–¹ App åŠ å›º(ä½¿ç”¨ arouter-register å®ç°è‡ªåŠ¨æ³¨å†Œ)
14. æ”¯æŒç”Ÿæˆè·¯ç”±æ–‡æ¡£
15. æä¾› IDE æ’ä»¶ä¾¿æ·çš„å…³è”è·¯å¾„å’Œç›®æ ‡ç±»
16. æ”¯æŒå¢é‡ç¼–è¯‘(å¼€å¯æ–‡æ¡£ç”Ÿæˆåæ— æ³•å¢é‡ç¼–è¯‘)

## å…¸å‹åº”ç”¨

1. ä»å¤–éƒ¨ URL æ˜ å°„åˆ°å†…éƒ¨é¡µé¢ï¼Œä»¥åŠå‚æ•°ä¼ é€’ä¸è§£æ
2. è·¨æ¨¡å—é¡µé¢è·³è½¬ï¼Œæ¨¡å—é—´è§£è€¦
3. æ‹¦æˆªè·³è½¬è¿‡ç¨‹ï¼Œå¤„ç†ç™»é™†ã€åŸ‹ç‚¹ç­‰é€»è¾‘
4. è·¨æ¨¡å— API è°ƒç”¨ï¼Œé€šè¿‡æ§åˆ¶åè½¬æ¥åšç»„ä»¶è§£è€¦

ä»¥ä¸Šä»‹ç»æ¥è‡ªäº ARouter çš„ Github å®˜ç½‘ï¼š[README_CN](https://github.com/alibaba/ARouter/blob/master/README_CN.md)

æœ¬æ–‡å°±åŸºäºä»¥ä¸‹ç‰ˆæœ¬ï¼Œå¯¹ ARouter è¿›è¡Œä¸€æ¬¡å…¨é¢çš„æºç è§£æå’ŒåŸç†ä»‹ç»ï¼Œåšåˆ°çŸ¥å…¶ç„¶ä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ˜‚ğŸ˜‚

```groovy
dependencies {
    implementation 'com.alibaba:arouter-api:1.5.0'
    kapt 'com.alibaba:arouter-compiler:1.2.2'
}
```

# äºŒã€å‰è¨€

å‡è®¾å­˜åœ¨ä¸€ä¸ªåŒ…å«å¤šä¸ª module çš„é¡¹ç›®ï¼Œåœ¨åä¸º **user** çš„ module ä¸­å­˜åœ¨ä¸€ä¸ª `UserHomeActivity`ï¼Œå…¶å¯¹åº”çš„**è·¯ç”±è·¯å¾„**æ˜¯ `/account/userHome`ã€‚é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬è¦ä»å…¶å®ƒ module è·³è½¬åˆ°è¯¥é¡µé¢æ—¶ï¼Œåªéœ€è¦æŒ‡å®š path æ¥è·³è½¬å³å¯

```java
package github.leavesc.user

/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
@Route(path = RoutePath.USER_HOME)
class UserHomeActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_home)
    }

}

//å…¶å®ƒé¡µé¢ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥è·³è½¬åˆ° UserHomeActivity
ARouter.getInstance().build(RoutePath.USER_HOME).navigation()
```

åªæ ¹æ®ä¸€ä¸ª pathï¼ŒARouter æ˜¯å¦‚ä½•å®šä½åˆ°ç‰¹å®šçš„ Activity çš„å‘¢ï¼Ÿè¿™å°±éœ€è¦é€šè¿‡åœ¨**ç¼–è¯‘é˜¶æ®µ**ç”Ÿæˆè¾…åŠ©ä»£ç æ¥å®ç°äº†ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæƒ³è¦è·³è½¬åˆ°æŸä¸ª Activityï¼Œé‚£ä¹ˆå°±éœ€è¦æ‹¿åˆ°è¯¥ Activity çš„ Class å¯¹è±¡æ‰è¡Œã€‚åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒARouter ä¼šæ ¹æ®æˆ‘ä»¬è®¾å®šçš„è·¯ç”±è·³è½¬è§„åˆ™æ¥è‡ªåŠ¨ç”Ÿæˆæ˜ å°„æ–‡ä»¶ï¼Œæ˜ å°„æ–‡ä»¶ä¸­å°±åŒ…å«äº† path å’Œ ActivityClass ä¹‹é—´çš„å¯¹åº”å…³ç³»

ä¾‹å¦‚ï¼Œå¯¹äº `UserHomeActivity`ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹è¾…åŠ©æ–‡ä»¶ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ`ARouter$$Group$$account` ç±»ä¸­å°±å°† path å’Œ ActivityClass ä½œä¸ºé”®å€¼å¯¹ä¿å­˜åˆ°äº† Map ä¸­ã€‚ARouter å°±æ˜¯ä¾é æ­¤æ¥è¿›è¡Œè·³è½¬çš„

```java
package com.alibaba.android.arouter.routes;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Group$$account implements IRouteGroup {
  @Override
  public void loadInto(Map<String, RouteMeta> atlas) {
    atlas.put("/account/userHome", RouteMeta.build(RouteType.ACTIVITY, UserHomeActivity.class, "/account/userhome", "account", null, -1, -2147483648));
  }
}
```

è¿˜æœ‰ä¸€ä¸ªé‡ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯è¿™ç±»è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶çš„åŒ…åè·¯å¾„éƒ½æ˜¯ `com.alibaba.android.arouter.routes`ï¼Œä¸”ç±»åå‰ç¼€ä¹Ÿæ˜¯æœ‰ç‰¹å®šè§„åˆ™çš„ã€‚è™½ç„¶ `ARouter$$Group$$account` ç±»å®ç°äº†å°†å¯¹åº”å…³ç³»ä¿å­˜åˆ° Map çš„é€»è¾‘ï¼Œä½†æ˜¯ `loadInto` æ–¹æ³•è¿˜æ˜¯éœ€è¦ç”± ARouter åœ¨è¿è¡Œæ—¶æ¥è°ƒç”¨ï¼Œé‚£ä¹ˆ ARouter å°±éœ€è¦æ‹¿åˆ° `ARouter$$Group$$account` è¿™ä¸ªç±»æ‰è¡Œï¼Œè€Œ ARouter å°±æ˜¯é€šè¿‡æ‰«æ `com.alibaba.android.arouter.routes`è¿™ä¸ªåŒ…åè·¯å¾„æ¥è·å–æ‰€æœ‰è¾…åŠ©æ–‡ä»¶çš„

ARouter çš„åŸºæœ¬å®ç°æ€è·¯å°±æ˜¯ï¼š

1. å¼€å‘è€…è‡ªå·±ç»´æŠ¤**ç‰¹å®š path** å’Œ**ç‰¹å®šçš„ç›®æ ‡ç±»**ä¹‹é—´çš„å¯¹åº”ä¸šåŠ¡å…³ç³»ï¼ŒARouter åªè¦æ±‚å¼€å‘è€…ä½¿ç”¨åŒ…å«äº† path çš„ `@Route` æ³¨è§£ä¿®é¥°**ç›®æ ‡ç±»**
2. ARouter åœ¨**ç¼–è¯‘é˜¶æ®µ**é€šè¿‡**æ³¨è§£å¤„ç†å™¨**æ¥è‡ªåŠ¨ç”Ÿæˆ path å’Œç‰¹å®šçš„ç›®æ ‡ç±»ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œå³å°† path ä½œä¸º keyï¼Œå°†ç›®æ ‡ç±»çš„ Class å¯¹è±¡ä½œä¸º value ä¹‹ä¸€å­˜åˆ° Map ä¹‹ä¸­
3. åœ¨è¿è¡Œé˜¶æ®µï¼Œåº”ç”¨é€šè¿‡ path æ¥å‘èµ·è¯·æ±‚ï¼ŒARouter æ ¹æ® path ä» Map ä¸­å–å€¼ï¼Œä»è€Œæ‹¿åˆ°ç›®æ ‡ç±»ï¼Œä»¥æ­¤æ¥å®Œæˆè·³è½¬

# ä¸‰ã€åˆå§‹åŒ–

ARouter ä¸€èˆ¬æ˜¯é€šè¿‡åœ¨ Application ä¸­è°ƒç”¨ `init` æ–¹æ³•æ¥å®Œæˆåˆå§‹åŒ–çš„ï¼Œè¿™é‡Œå…ˆæ¥çœ‹ä¸‹å…¶åˆå§‹åŒ–æµç¨‹

```kotlin
/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
class MyApp : Application() {

    override fun onCreate() {
        super.onCreate()
        if (BuildConfig.DEBUG) {
            ARouter.openDebug()
            ARouter.openLog()
        }
        ARouter.init(this)
    }

}
```

ARouter ç±»ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼ŒARouter ç±»åªæ˜¯è´Ÿè´£å¯¹å¤–æš´éœ²å¯ä»¥ç”±å¤–éƒ¨è°ƒç”¨çš„ APIï¼Œå¤§éƒ¨åˆ†çš„å®ç°é€»è¾‘è¿˜æ˜¯è½¬äº¤ç”± `_ARouter` ç±»æ¥å®Œæˆ

```java
public final class ARouter {
    
    private volatile static ARouter instance = null;
    
    private ARouter() {
    }
    
    /**
     * Get instance of router. A
     * All feature U use, will be starts here.
     */
    public static ARouter getInstance() {
        if (!hasInit) {
            throw new InitException("ARouter::Init::Invoke init(context) first!");
        } else {
            if (instance == null) {
                synchronized (ARouter.class) {
                    if (instance == null) {
                        instance = new ARouter();
                    }
                }
            }
            return instance;
        }
    }

    /**
     * Init, it must be call before used router.
     */
    public static void init(Application application) {
        if (!hasInit) { //é˜²æ­¢é‡å¤åˆå§‹åŒ–
            logger = _ARouter.logger;
            _ARouter.logger.info(Consts.TAG, "ARouter init start.");
            //é€šè¿‡ _ARouter æ¥å®Œæˆåˆå§‹åŒ–
            hasInit = _ARouter.init(application);
            if (hasInit) {
                _ARouter.afterInit();
            }
            _ARouter.logger.info(Consts.TAG, "ARouter init over.");
        }
    }
    
    Â·Â·Â·
    
}
```

`_ARouter` ç±»æ˜¯**åŒ…ç§æœ‰æƒé™**ï¼Œä¹Ÿä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œå…¶ `init(Application)` æ–¹æ³•çš„é‡ç‚¹å°±åœ¨äº `LogisticsCenter.init(mContext, executor)`

```java
final class _ARouter {
    
    private volatile static _ARouter instance = null;
    
    private _ARouter() {
    }

    protected static _ARouter getInstance() {
        if (!hasInit) {
            throw new InitException("ARouterCore::Init::Invoke init(context) first!");
        } else {
            if (instance == null) {
                synchronized (_ARouter.class) {
                    if (instance == null) {
                        instance = new _ARouter();
                    }
                }
            }
            return instance;
        }
    }

    protected static synchronized boolean init(Application application) {
        mContext = application;
        //é‡ç‚¹
        LogisticsCenter.init(mContext, executor);
        logger.info(Consts.TAG, "ARouter init success!");
        hasInit = true;
        mHandler = new Handler(Looper.getMainLooper());
        return true;
    }
    
    Â·Â·Â·
    
}
```

`LogisticsCenter` å°±å®ç°äº†å‰æ–‡è¯´çš„**æ‰«æç‰¹å®šåŒ…åè·¯å¾„æ‹¿åˆ°æ‰€æœ‰è‡ªåŠ¨ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶**çš„é€»è¾‘ï¼Œå³åœ¨è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ è½½åˆ°å½“å‰é¡¹ç›®ä¸€å…±åŒ…å«çš„æ‰€æœ‰ groupï¼Œä»¥åŠæ¯ä¸ª group å¯¹åº”çš„è·¯ç”±ä¿¡æ¯è¡¨ï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š

1. å¦‚æœå½“å‰å¼€å¯äº† debug æ¨¡å¼æˆ–è€…é€šè¿‡æœ¬åœ° SP ç¼“å­˜åˆ¤æ–­å‡º app çš„ç‰ˆæœ¬å‰åå‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆå°±é‡æ–°è·å–å…¨å±€è·¯ç”±ä¿¡æ¯ï¼Œå¦åˆ™å°±è¿˜æ˜¯ä½¿ç”¨ä¹‹å‰ç¼“å­˜åˆ° SP ä¸­çš„æ•°æ®
2. è·å–å…¨å±€è·¯ç”±ä¿¡æ¯æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œæ‰€ä»¥ ARouter å°±é€šè¿‡å°†å…¨å±€è·¯ç”±ä¿¡æ¯ç¼“å­˜åˆ° SP ä¸­æ¥å®ç°å¤ç”¨ã€‚ä½†ç”±äºåœ¨å¼€å‘é˜¶æ®µå¼€å‘è€…å¯èƒ½éšæ—¶å°±ä¼šæ·»åŠ æ–°çš„è·¯ç”±è¡¨ï¼Œè€Œæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ­£å¸¸æ¥è¯´éƒ½æ˜¯ä¼šåŠ å¤§åº”ç”¨çš„ç‰ˆæœ¬å·çš„ï¼Œæ‰€ä»¥ ARouter å°±åªåœ¨å¼€å¯äº† debug æ¨¡å¼æˆ–è€…æ˜¯ç‰ˆæœ¬å·å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™æ‰ä¼šé‡æ–°è·å–è·¯ç”±ä¿¡æ¯
3. è·å–åˆ°çš„è·¯ç”±ä¿¡æ¯ä¸­åŒ…å«äº†åœ¨ `com.alibaba.android.arouter.routes` è¿™ä¸ªåŒ…ä¸‹è‡ªåŠ¨ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶çš„å…¨è·¯å¾„ï¼Œé€šè¿‡åˆ¤æ–­è·¯å¾„åçš„å‰ç¼€å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥çŸ¥é“è¯¥ç±»æ–‡ä»¶å¯¹åº”ä»€ä¹ˆç±»å‹ï¼Œç„¶åé€šè¿‡åå°„æ„å»ºä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•å°†è·¯ç”±ä¿¡æ¯å­˜åˆ° `Warehouse` çš„ Map ä¸­ã€‚è‡³æ­¤ï¼Œæ•´ä¸ªåˆå§‹åŒ–æµç¨‹å°±ç»“æŸäº†

```java
public class LogisticsCenter {
    
    /**
     * LogisticsCenter init, load all metas in memory. Demand initialization
     */
    public synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {
        mContext = context;
        executor = tpe;

        try {
            long startInit = System.currentTimeMillis();
            //billy.qi modified at 2017-12-06
            //load by plugin first
            loadRouterMap();
            if (registerByPlugin) {
                logger.info(TAG, "Load router map by arouter-auto-register plugin.");
            } else {
                Set<String> routerMap;

                //å¦‚æœå½“å‰å¼€å¯äº† debug æ¨¡å¼æˆ–è€…é€šè¿‡æœ¬åœ° SP ç¼“å­˜åˆ¤æ–­å‡º app çš„ç‰ˆæœ¬å‰åå‘ç”Ÿäº†å˜åŒ–
                //é‚£ä¹ˆå°±é‡æ–°è·å–è·¯ç”±ä¿¡æ¯ï¼Œå¦åˆ™å°±ä»ä½¿ç”¨ä¹‹å‰ç¼“å­˜åˆ° SP ä¸­çš„æ•°æ®
                // It will rebuild router map every times when debuggable.
                if (ARouter.debuggable() || PackageUtils.isNewVersion(context)) {
                    logger.info(TAG, "Run with debug mode or new install, rebuild router map.");
                    // These class was generated by arouter-compiler.
                    //è·å– ROUTE_ROOT_PAKCAGE åŒ…åè·¯å¾„ä¸‹åŒ…å«çš„æ‰€æœ‰çš„ ClassName
                    routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);
                    if (!routerMap.isEmpty()) {
                        //ç¼“å­˜åˆ° SP ä¸­
                        context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();
                    }
                    //æ›´æ–° App çš„ç‰ˆæœ¬ä¿¡æ¯
                    PackageUtils.updateVersion(context);    // Save new version name when router map update finishes.
                } else {
                    logger.info(TAG, "Load router map from cache.");
                    routerMap = new HashSet<>(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, new HashSet<String>()));
                }

                logger.info(TAG, "Find router map finished, map size = " + routerMap.size() + ", cost " + (System.currentTimeMillis() - startInit) + " ms.");
                startInit = System.currentTimeMillis();

                for (String className : routerMap) {
                    //é€šè¿‡ className çš„å‰ç¼€æ¥åˆ¤æ–­è¯¥ class å¯¹åº”çš„ä»€ä¹ˆç±»å‹ï¼Œå¹¶åŒæ—¶ç¼“å­˜åˆ° Warehouse ä¸­
                    //1.IRouteRoot
                    //2.IInterceptorGroup
                    //3.IProviderGroup
                    if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) {
                        // This one of root elements, load root.
                        ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);
                    } else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) {
                        // Load interceptorMeta
                        ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);
                    } else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) {
                        // Load providerIndex
                        ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);
                    }
                }
            }

           Â·Â·Â·
               
        } catch (Exception e) {
            throw new HandlerException(TAG + "ARouter init logistics center exception! [" + e.getMessage() + "]");
        }
    }
    
}
```

å¯¹äºç¬¬ä¸‰æ­¥ï¼Œå¯ä»¥ä¸¾ä¸ªä¾‹å­æ¥åŠ å¼ºç†è§£

å¯¹äºä¸Šæ–‡æ‰€è®²çš„ UserHomeActivityï¼Œæ”¾åœ¨åä¸º `user` çš„ module ä¸­ï¼ŒæŒ‰ç…§ ARouter çš„è¦æ±‚ï¼Œåœ¨ gradle æ–‡ä»¶ä¸­ä¸ºè¯¥ module å£°æ˜äº†ä»¥ä¸‹é…ç½®ï¼Œå°† projectName ä½œä¸ºå‚æ•°å€¼ã€‚UserHomeActivity å¯¹åº”çš„ path æ˜¯ `/account/userHome`ï¼ŒARouter é»˜è®¤ä¼šå°† path çš„ç¬¬ä¸€ä¸ªå•è¯å³ `account` ä½œä¸ºå…¶ `group`

```groovy
javaCompileOptions {
    kapt {
        arguments {
            arg("AROUTER_MODULE_NAME", project.getName())
        }
    }
}
```

ARouter åœ¨é€šè¿‡æ³¨è§£å¤„ç†å™¨ç”Ÿæˆè¾…åŠ©æ–‡ä»¶çš„æ—¶å€™ï¼Œç±»åå°±ä¼šæ ¹æ®ä»¥ä¸Šä¿¡æ¯æ¥ç”Ÿæˆï¼Œæ‰€ä»¥æœ€ç»ˆå°±ä¼šç”Ÿæˆä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š

```java
package com.alibaba.android.arouter.routes;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Root$$user implements IRouteRoot {
  @Override
  public void loadInto(Map<String, Class<? extends IRouteGroup>> routes) {
    routes.put("account", ARouter$$Group$$account.class);
  }
}

package com.alibaba.android.arouter.routes;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Group$$account implements IRouteGroup {
  @Override
  public void loadInto(Map<String, RouteMeta> atlas) {
    atlas.put("/account/userHome", RouteMeta.build(RouteType.ACTIVITY, UserHomeActivity.class, "/account/userhome", "account", null, -1, -2147483648));
  }
}
```

LogisticsCenter çš„ `init` æ–¹æ³•å°±ä¼šæ ¹æ®æ–‡ä»¶åçš„å›ºå®šå‰ç¼€ `ARouter$$Root$$` æ‰«æåˆ° `ARouter$$Root$$user` è¿™ä¸ªç±»ï¼Œç„¶åé€šè¿‡åå°„æ„å»ºå‡ºè¯¥å¯¹è±¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨å…¶ `loadInto` æ–¹æ³•å°†é”®å€¼å¯¹ä¿å­˜åˆ° `Warehouse.groupsIndex` ä¸­ã€‚ç­‰åˆ°åç»­éœ€è¦è·³è½¬åˆ° `group` ä¸º `account` çš„é¡µé¢æ—¶ï¼Œå°±ä¼šå†æ¥åå°„è°ƒç”¨ `ARouter$$Group$$account` çš„ `loadInto` æ–¹æ³•ï¼Œå³æŒ‰éœ€åŠ è½½ï¼Œç­‰åˆ°éœ€è¦ç”¨åˆ°çš„æ—¶å€™å†æ¥è·å–è¯¦ç»†çš„è·¯ç”±å¯¹åº”ä¿¡æ¯

å› ä¸ºå¯¹äºä¸€ä¸ªå¤§å‹çš„ App æ¥è¯´ï¼Œå¯èƒ½åŒ…å«å‡ åç”šè‡³å‡ ç™¾ä¸ªé¡µé¢ï¼Œå¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰è·¯ç”±ä¿¡æ¯éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯¹äºå†…å­˜çš„å‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œè€Œç”¨æˆ·æ¯æ¬¡ä½¿ç”¨å¯èƒ½ä¹Ÿåªä¼šæ‰“å¼€åå‡ ä¸ªé¡µé¢ï¼Œæ‰€ä»¥è¿™æ˜¯å°±å®ç°äº†æŒ‰éœ€åŠ è½½

# å››ã€è·³è½¬åˆ° Activity

è®²å®Œåˆå§‹åŒ–æµç¨‹ï¼Œå†æ¥çœ‹ä¸‹ ARouter å®ç° Activity è·³è½¬çš„æµç¨‹

è·³è½¬åˆ° Activity æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åªæŒ‡å®š pathï¼š

```kotlin
ARouter.getInstance().build(RoutePath.USER_HOME).navigation()
```

`build()` æ–¹æ³•ä¼šé€šè¿‡ `ARouter` ä¸­è½¬è°ƒç”¨åˆ° `_ARouter` çš„ `build()` æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ª Postcard å¯¹è±¡

```java
/**
 * Build postcard by path and default group
 */
protected Postcard build(String path) {
    if (TextUtils.isEmpty(path)) {
        throw new HandlerException(Consts.TAG + "Parameter is invalid!");
    } else {
        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);
        if (null != pService) {
            //ç”¨äºè·¯å¾„æ›¿æ¢ï¼Œè¿™å¯¹äºæŸäº›éœ€è¦æ§åˆ¶é¡µé¢è·³è½¬æµç¨‹çš„åœºæ™¯æ¯”è¾ƒæœ‰ç”¨
            //ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªé¡µé¢éœ€è¦ç™»å½•æ‰å¯ä»¥å±•ç¤ºçš„è¯
            //å°±å¯ä»¥é€šè¿‡ PathReplaceService å°† path æ›¿æ¢ loginPagePath
            path = pService.forString(path);
        }
        //ä½¿ç”¨å­—ç¬¦ä¸² path åŒ…å«çš„ç¬¬ä¸€ä¸ªå•è¯ä½œä¸º group
        return build(path, extractGroup(path));
    }
}

/**
 * Build postcard by path and group
 */
protected Postcard build(String path, String group) {
    if (TextUtils.isEmpty(path) || TextUtils.isEmpty(group)) {
        throw new HandlerException(Consts.TAG + "Parameter is invalid!");
    } else {
        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);
        if (null != pService) {
            path = pService.forString(path);
        }
        return new Postcard(path, group);
    }
}
```

è¿”å›çš„ Postcard å¯¹è±¡å¯ä»¥ç”¨äºä¼ å…¥ä¸€äº›è·³è½¬é…ç½®å‚æ•°ï¼Œä¾‹å¦‚ï¼šæºå¸¦å‚æ•° `mBundle`ã€å¼€å¯ç»¿è‰²é€šé“ `greenChannel` ã€è·³è½¬åŠ¨ç”» `optionsCompat` ç­‰

```java
public final class Postcard extends RouteMeta {
    // Base
    private Uri uri;
    private Object tag;             // A tag prepare for some thing wrong.
    private Bundle mBundle;         // Data to transform
    private int flags = -1;         // Flags of route
    private int timeout = 300;      // Navigation timeout, TimeUnit.Second
    private IProvider provider;     // It will be set value, if this postcard was provider.
    private boolean greenChannel;
    private SerializationService serializationService;
    
}
```

Postcard çš„ `navigation()` æ–¹æ³•åˆä¼šè°ƒç”¨åˆ° `_ARouter` çš„ä»¥ä¸‹æ–¹æ³•æ¥å®Œæˆ Activity çš„è·³è½¬ã€‚è¯¥æ–¹æ³•é€»è¾‘ä¸Šå¹¶ä¸å¤æ‚ï¼Œæ³¨é‡Šä¹Ÿå†™å¾—å¾ˆæ¸…æ¥šäº†

```java
final class _ARouter {

    /**
     * Use router navigation.
     *
     * @param context     Activity or null.
     * @param postcard    Route metas
     * @param requestCode RequestCode
     * @param callback    cb
     */
    protected Object navigation(final Context context, final Postcard postcard, final int requestCode, final NavigationCallback callback) {
        PretreatmentService pretreatmentService = ARouter.getInstance().navigation(PretreatmentService.class);
        if (null != pretreatmentService && !pretreatmentService.onPretreatment(context, postcard)) {
            // Pretreatment failed, navigation canceled.
            //ç”¨äºæ‰§è¡Œè·³è½¬å‰çš„é¢„å¤„ç†æ“ä½œï¼Œå¯ä»¥é€šè¿‡ onPretreatment æ–¹æ³•çš„è¿”å›å€¼å†³å®šæ˜¯å¦å–æ¶ˆè·³è½¬
            return null;
        }

        try {
            LogisticsCenter.completion(postcard);
        } catch (NoRouteFoundException ex) {
            //æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç›®æ ‡ç±»
            //ä¸‹é¢å°±æ‰§è¡Œä¸€äº›æç¤ºæ“ä½œå’Œäº‹ä»¶å›è°ƒé€šçŸ¥
            
            logger.warning(Consts.TAG, ex.getMessage());
            if (debuggable()) {
                // Show friendly tips for user.
                runInMainThread(new Runnable() {
                    @Override
                    public void run() {
                        Toast.makeText(mContext, "There's no route matched!\n" +
                                " Path = [" + postcard.getPath() + "]\n" +
                                " Group = [" + postcard.getGroup() + "]", Toast.LENGTH_LONG).show();
                    }
                });
            }
            if (null != callback) {
                callback.onLost(postcard);
            } else {
                // No callback for this invoke, then we use the global degrade service.
                DegradeService degradeService = ARouter.getInstance().navigation(DegradeService.class);
                if (null != degradeService) {
                    degradeService.onLost(context, postcard);
                }
            }
            return null;
        }

        if (null != callback) {
            //æ‰¾åˆ°äº†åŒ¹é…çš„ç›®æ ‡ç±»
            callback.onFound(postcard);
        }

        if (!postcard.isGreenChannel()) {   // It must be run in async thread, maybe interceptor cost too mush time made ANR.
            //æ²¡æœ‰å¼€å¯ç»¿è‰²é€šé“ï¼Œé‚£ä¹ˆå°±è¿˜éœ€è¦æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨
            //å¤–éƒ¨å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨å®ç°ï¼šæ§åˆ¶æ˜¯å¦å…è®¸è·³è½¬ã€æ›´æ”¹è·³è½¬å‚æ•°ç­‰é€»è¾‘
            
            interceptorService.doInterceptions(postcard, new InterceptorCallback() {
                /**
                 * Continue process
                 *
                 * @param postcard route meta
                 */
                @Override
                public void onContinue(Postcard postcard) {
                    //æ‹¦æˆªå™¨å…è®¸è·³è½¬
                    _navigation(context, postcard, requestCode, callback);
                }

                /**
                 * Interrupt process, pipeline will be destory when this method called.
                 *
                 * @param exception Reson of interrupt.
                 */
                @Override
                public void onInterrupt(Throwable exception) {
                    if (null != callback) {
                        callback.onInterrupt(postcard);
                    }

                    logger.info(Consts.TAG, "Navigation failed, termination by interceptor : " + exception.getMessage());
                }
            });
        } else {
            //å¼€å¯äº†ç»¿è‰²é€šé“ï¼Œç›´æ¥è·³è½¬ï¼Œä¸éœ€è¦éå†æ‹¦æˆªå™¨
            return _navigation(context, postcard, requestCode, callback);
        }

        return null;
    }
    
    //ç”±äºæœ¬ä¾‹å­çš„ç›®æ ‡é¡µé¢æ˜¯ Activityï¼Œæ‰€ä»¥åªçœ‹ ACTIVITY å³å¯
    private Object _navigation(final Context context, final Postcard postcard, final int requestCode, final NavigationCallback callback) {
        final Context currentContext = null == context ? mContext : context;
        switch (postcard.getType()) {
            case ACTIVITY:
                // Build intent
                //Destination å°±æ˜¯æŒ‡å‘ç›®æ ‡ Activity çš„ class å¯¹è±¡
                final Intent intent = new Intent(currentContext, postcard.getDestination());
                //å¡å…¥æºå¸¦çš„å‚æ•°
                intent.putExtras(postcard.getExtras());

                // Set flags.
                int flags = postcard.getFlags();
                if (-1 != flags) {
                    intent.setFlags(flags);
                } else if (!(currentContext instanceof Activity)) {    // Non activity, need less one flag.
                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                }

                // Set Actions
                String action = postcard.getAction();
                if (!TextUtils.isEmpty(action)) {
                    intent.setAction(action);
                }

                // Navigation in main looper.
                //æœ€ç»ˆåœ¨ä¸»çº¿ç¨‹å®Œæˆè·³è½¬
                runInMainThread(new Runnable() {
                    @Override
                    public void run() {
                        startActivity(requestCode, currentContext, intent, postcard, callback);
                    }
                });

                break;
            Â·Â·Â· //çœç•¥å…¶å®ƒç±»å‹åˆ¤æ–­
        }

        return null;
    }

}
```

`navigation` æ–¹æ³•çš„é‡ç‚¹åœ¨äº `LogisticsCenter.completion(postcard)` è¿™ä¸€å¥ä»£ç ã€‚åœ¨è®² ARouter åˆå§‹åŒ–æµç¨‹çš„æ—¶å€™æœ‰è®²åˆ°ï¼šç­‰åˆ°åç»­éœ€è¦è·³è½¬åˆ° `group` ä¸º `account` çš„é¡µé¢æ—¶ï¼Œå°±ä¼šå†æ¥åå°„è°ƒç”¨ `ARouter$$Group$$account` çš„ `loadInto` æ–¹æ³•ï¼Œå³æŒ‰éœ€åŠ è½½ï¼Œç­‰åˆ°éœ€è¦çš„æ—¶å€™å†æ¥è·å–è¯¦ç»†çš„è·¯ç”±å¯¹åº”ä¿¡æ¯

`completion` æ–¹æ³•å°±æ˜¯ç”¨æ¥è·å–è¯¦ç»†çš„è·¯ç”±å¯¹åº”ä¿¡æ¯çš„ã€‚è¯¥æ–¹æ³•ä¼šé€šè¿‡ `postcard` æºå¸¦çš„ path å’Œ group ä¿¡æ¯ä» `Warehouse` å–å€¼ï¼Œå¦‚æœå€¼ä¸ä¸º null çš„è¯å°±å°†ä¿¡æ¯ä¿å­˜åˆ° `postcard` ä¸­ï¼Œå¦‚æœå€¼ä¸º null çš„è¯å°±æŠ›å‡º `NoRouteFoundException`

```java
/**
 * Completion the postcard by route metas
 *
 * @param postcard Incomplete postcard, should complete by this method.
 */
public synchronized static void completion(Postcard postcard) {
    if (null == postcard) {
        throw new NoRouteFoundException(TAG + "No postcard!");
    }

    RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());
    if (null == routeMeta) {    //ä¸º null è¯´æ˜ç›®æ ‡ç±»ä¸å­˜åœ¨æˆ–è€…æ˜¯è¯¥ group è¿˜æœªåŠ è½½è¿‡
        Class<? extends IRouteGroup> groupMeta = Warehouse.groupsIndex.get(postcard.getGroup());  // Load route meta.
        if (null == groupMeta) {
            //groupMeta ä¸º nullï¼Œè¯´æ˜ postcard çš„ path å¯¹åº”çš„ group ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
            throw new NoRouteFoundException(TAG + "There is no route match the path [" + postcard.getPath() + "], in group [" + postcard.getGroup() + "]");
        } else {
            // Load route and cache it into memory, then delete from metas.
            try {
                if (ARouter.debuggable()) {
                    logger.debug(TAG, String.format(Locale.getDefault(), "The group [%s] starts loading, trigger by [%s]", postcard.getGroup(), postcard.getPath()));
                }
              //ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ­¤ group è¿˜æœªåŠ è½½è¿‡ï¼Œé‚£ä¹ˆå°±æ¥åå°„åŠ è½½ group å¯¹åº”çš„æ‰€æœ‰ path ä¿¡æ¯
               //è·å–åå°±ä¿å­˜åˆ° Warehouse.routes
                IRouteGroup iGroupInstance = groupMeta.getConstructor().newInstance();
                iGroupInstance.loadInto(Warehouse.routes);

                //ç§»é™¤æ­¤ group
                Warehouse.groupsIndex.remove(postcard.getGroup());

                if (ARouter.debuggable()) {
                    logger.debug(TAG, String.format(Locale.getDefault(), "The group [%s] has already been loaded, trigger by [%s]", postcard.getGroup(), postcard.getPath()));
                }
            } catch (Exception e) {
                throw new HandlerException(TAG + "Fatal exception when loading group meta. [" + e.getMessage() + "]");
            }

            //é‡æ–°æ‰§è¡Œä¸€é
            completion(postcard);   // Reload
        }
    } else {
        //æ‹¿åˆ°è¯¦ç»†çš„è·¯ç”±ä¿¡æ¯äº†ï¼Œå°†è¿™äº›ä¿¡æ¯å­˜åˆ° postcard ä¸­

        postcard.setDestination(routeMeta.getDestination());
        postcard.setType(routeMeta.getType());
        postcard.setPriority(routeMeta.getPriority());
        postcard.setExtra(routeMeta.getExtra());

        //çœç•¥ä¸€äº›å’Œæœ¬ä¾‹å­æ— å…³çš„ä»£ç 
        Â·Â·Â·
    }
}
```

# äº”ã€è·³è½¬åˆ° Activity å¹¶æ³¨å…¥å‚æ•°

ARouter ä¹Ÿæ”¯æŒåœ¨è·³è½¬åˆ° Activity çš„åŒæ—¶å‘ç›®æ ‡é¡µé¢è‡ªåŠ¨æ³¨å…¥å‚æ•°

åœ¨è·³è½¬çš„æ—¶å€™æŒ‡å®šè¦æºå¸¦çš„é”®å€¼å¯¹å‚æ•°ï¼š

```kotlin
ARouter.getInstance().build(RoutePath.USER_HOME)
        .withLong(RoutePath.USER_HOME_PARAMETER_ID, 20)
        .withString(RoutePath.USER_HOME_PARAMETER_NAME, "leavesC")
        .navigation()

object RoutePath {

    const val USER_HOME = "/account/userHome"

    const val USER_HOME_PARAMETER_ID = "userHomeId"

    const val USER_HOME_PARAMETER_NAME = "userName"

}
```

åœ¨ç›®æ ‡é¡µé¢é€šè¿‡ `@Autowired` æ³¨è§£ä¿®é¥°å˜é‡ã€‚æ³¨è§£å¯ä»¥åŒæ—¶å£°æ˜å…¶ `name` å‚æ•°ï¼Œç”¨äºå’Œä¼ é€’çš„é”®å€¼å¯¹ä¸­çš„ key å¯¹åº”ä¸Šï¼Œè¿™æ · ARouter æ‰çŸ¥é“åº”è¯¥å‘å“ªä¸ªå˜é‡èµ‹å€¼ã€‚å¦‚æœæ²¡æœ‰å£°æ˜ `name` å‚æ•°ï¼Œé‚£ä¹ˆ `name` å‚æ•°å°±é»˜è®¤å’Œ**å˜é‡å**ç›¸ç­‰

è¿™æ ·ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨ `ARouter.getInstance().inject(this)` åï¼ŒARouter å°±ä¼šè‡ªåŠ¨å®Œæˆå‚æ•°çš„èµ‹å€¼

```kotlin
package github.leavesc.user

/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
@Route(path = RoutePath.USER_HOME)
class UserHomeActivity : AppCompatActivity() {

    @Autowired(name = RoutePath.USER_HOME_PARAMETER_ID)
    @JvmField
    var userId: Long = 0

    @Autowired
    @JvmField
    var userName = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_home)
        ARouter.getInstance().inject(this)
        tv_hint.text = "$userId $userName"
    }

}
```

ARouter å®ç°å‚æ•°è‡ªåŠ¨æ³¨å…¥ä¹Ÿéœ€è¦ä¾é æ³¨è§£å¤„ç†å™¨ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶æ¥å®ç°ï¼Œå³ä¼šç”Ÿæˆä»¥ä¸‹çš„è¾…åŠ©ä»£ç ï¼š

```java
package github.leavesc.user;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class UserHomeActivity$$ARouter$$Autowired implements ISyringe {
    
  //ç”¨äºå®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  private SerializationService serializationService;

  @Override
  public void inject(Object target) {
    serializationService = ARouter.getInstance().navigation(SerializationService.class);
    UserHomeActivity substitute = (UserHomeActivity)target;
    substitute.userId = substitute.getIntent().getLongExtra("userHomeId", substitute.userId);
    substitute.userName = substitute.getIntent().getStringExtra("userName");
  }
}

```

å› ä¸ºåœ¨è·³è½¬åˆ° Activity æ—¶æºå¸¦çš„å‚æ•°ä¹Ÿæ˜¯éœ€è¦æ”¾åˆ° Intent é‡Œçš„ï¼Œæ‰€ä»¥ `inject` æ–¹æ³•ä¹Ÿåªæ˜¯å¸®æˆ‘ä»¬å®ç°äº†ä» Intent å–å€¼ç„¶åå‘å˜é‡èµ‹å€¼çš„é€»è¾‘è€Œå·²ï¼Œè¿™å°±è¦æ±‚ç›¸åº”çš„å˜é‡å¿…é¡»æ˜¯ `public` çš„ï¼Œè¿™å°±æ˜¯åœ¨ Kotlin ä»£ç ä¸­éœ€è¦åŒæ—¶å‘å˜é‡åŠ ä¸Š `@JvmField`æ³¨è§£çš„åŸå› 

ç°åœ¨æ¥çœ‹ä¸‹ ARouter æ˜¯å¦‚ä½•å®ç°**å‚æ•°è‡ªåŠ¨æ³¨å…¥**çš„ï¼Œå…¶èµ·å§‹æ–¹æ³•å°±æ˜¯ï¼š`ARouter.getInstance().inject(this)`ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ°ä»¥ä¸‹æ–¹æ³•

```java
final class _ARouter {
   
    static void inject(Object thiz) {
        AutowiredService autowiredService = ((AutowiredService) ARouter.getInstance().build("/arouter/service/autowired").navigation());
        if (null != autowiredService) {
            autowiredService.autowire(thiz);
        }
    }
    
}
```

ARouter é€šè¿‡æ§åˆ¶åè½¬çš„æ–¹å¼æ‹¿åˆ° AutowiredService å¯¹åº”çš„å®ç°ç±» AutowiredServiceImpl çš„å®ä¾‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ `autowire` æ–¹æ³•å®Œæˆå‚æ•°æ³¨å…¥

ç”±äºç”Ÿæˆçš„**å‚æ•°æ³¨å…¥è¾…åŠ©ç±»**çš„ç±»åå…·æœ‰**å›ºå®šçš„åŒ…åå’Œç±»å**ï¼Œå³åŒ…åå’Œç›®æ ‡ç±»æ‰€åœ¨åŒ…åä¸€è‡´ï¼Œç±»åæ˜¯**ç›®æ ‡ç±»ç±»å**+ `$$ARouter$$Autowired`ï¼Œæ‰€ä»¥åœ¨ AutowiredServiceImpl ä¸­å°±å¯ä»¥æ ¹æ®ä¼ å…¥çš„ `instance` å‚æ•°å’Œåå°„æ¥ç”Ÿæˆè¾…åŠ©ç±»å¯¹è±¡ï¼Œæœ€ç»ˆè°ƒç”¨å…¶ `inject` æ–¹æ³•å®Œæˆå‚æ•°æ³¨å…¥

```java
@Route(path = "/arouter/service/autowired")
public class AutowiredServiceImpl implements AutowiredService {
    private LruCache<String, ISyringe> classCache;
    private List<String> blackList;

    @Override
    public void init(Context context) {
        classCache = new LruCache<>(66);
        blackList = new ArrayList<>();
    }

    @Override
    public void autowire(Object instance) {
        String className = instance.getClass().getName();
        try {
            //å¦‚æœåœ¨ç™½åå•ä¸­äº†çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸å†æ‰§è¡Œå‚æ•°æ³¨å…¥
            if (!blackList.contains(className)) {
                ISyringe autowiredHelper = classCache.get(className);
                if (null == autowiredHelper) {  // No cache.
                    autowiredHelper = (ISyringe) Class.forName(instance.getClass().getName() + SUFFIX_AUTOWIRED).getConstructor().newInstance();
                }
                //å®Œæˆå‚æ•°æ³¨å…¥
                autowiredHelper.inject(instance);
                //ç¼“å­˜èµ·æ¥ï¼Œé¿å…é‡å¤åå°„
                classCache.put(className, autowiredHelper);
            }
        } catch (Exception ex) {
            //å¦‚æœå‚æ•°æ³¨å…¥è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±å°†å…¶åŠ å…¥ç™½åå•ä¸­
            blackList.add(className);    // This instance need not autowired.
        }
    }
}
```

# å…­ã€æ§åˆ¶åè½¬

ä¸Šä¸€èŠ‚æ‰€è®²çš„**è·³è½¬åˆ° Activity å¹¶è‡ªåŠ¨æ³¨å…¥å‚æ•°**å±äº**ä¾èµ–æ³¨å…¥**çš„ä¸€ç§ï¼ŒARouter åŒæ—¶ä¹Ÿæ”¯æŒ**æ§åˆ¶åè½¬**ï¼šé€šè¿‡æ¥å£æ¥è·å–å…¶å®ç°ç±»å®ä¾‹

ä¾‹å¦‚ï¼Œå‡è®¾å­˜åœ¨ä¸€ä¸ª ISayHelloService æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°å…¶å®ç°ç±»å®ä¾‹ï¼Œä½†æ˜¯ä¸å¸Œæœ›åœ¨ä½¿ç”¨çš„æ—¶å€™å’Œç‰¹å®šçš„å®ç°ç±» SayHelloService ç»‘å®šåœ¨ä¸€èµ·ä»è€Œé€ æˆå¼ºè€¦åˆï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ ARouter çš„æ§åˆ¶åè½¬åŠŸèƒ½ï¼Œä½†è¿™ä¹Ÿè¦æ±‚ ISayHelloService æ¥å£ç»§æ‰¿äº† `IProvider` æ¥å£æ‰è¡Œ

```kotlin
/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
interface ISayHelloService : IProvider {

    fun sayHello()

}

@Route(path = RoutePath.SERVICE_SAY_HELLO)
class SayHelloService : ISayHelloService {

    override fun init(context: Context) {

    }

    override fun sayHello() {
        Log.e("SayHelloService", "$this sayHello")
    }

}
```

åœ¨ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä¼ é€’ ISayHelloService çš„ Class å¯¹è±¡å³å¯ï¼ŒARouter ä¼šå°† SayHelloService ä»¥å•ä¾‹æ¨¡å¼çš„å½¢å¼è¿”å›ï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨å»æ„å»º SayHelloService å¯¹è±¡ï¼Œä»è€Œè¾¾åˆ°è§£è€¦çš„ç›®çš„

```kotlin
ARouter.getInstance().navigation(ISayHelloService::class.java).sayHello()
```

å’Œå®ç° Activity è·³è½¬çš„æ—¶å€™ä¸€æ ·ï¼ŒARouter ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«äº†è·¯ç”±è¡¨çš„æ˜ å°„å…³ç³»

```java
package com.alibaba.android.arouter.routes;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Group$$account implements IRouteGroup {
  @Override
  public void loadInto(Map<String, RouteMeta> atlas) {
    atlas.put("/account/sayHelloService", RouteMeta.build(RouteType.PROVIDER, SayHelloService.class, "/account/sayhelloservice", "account", null, -1, -2147483648));
  }
}

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Providers$$user implements IProviderGroup {
  @Override
  public void loadInto(Map<String, RouteMeta> providers) {
    providers.put("github.leavesc.user.ISayHelloService", RouteMeta.build(RouteType.PROVIDER, SayHelloService.class, "/account/sayHelloService", "account", null, -1, -2147483648));
  }
}

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Root$$user implements IRouteRoot {
  @Override
  public void loadInto(Map<String, Class<? extends IRouteGroup>> routes) {
    routes.put("account", ARouter$$Group$$account.class);
  }
}
```

è¿™é‡Œå†æ¥çœ‹ä¸‹å…¶å…·ä½“çš„å®ç°åŸç†

åœ¨è®²åˆå§‹åŒ–æµç¨‹çš„æ—¶å€™æœ‰è®²åˆ°ï¼ŒLogisticsCenter å®ç°äº†**æ‰«æç‰¹å®šåŒ…åè·¯å¾„æ‹¿åˆ°æ‰€æœ‰è‡ªåŠ¨ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶**çš„é€»è¾‘ã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆ Warehouse ä¸­å°±ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™æ‹¿åˆ°ä»¥ä¸‹æ•°æ®

Warehouse.groupsIndexï¼š

- `account` -> `class com.alibaba.android.arouter.routes.ARouter$$Group$$account`

Warehouse.providersIndexï¼š

- `github.leavesc.user.ISayHelloService` -> `RouteMeta.build(RouteType.PROVIDER, SayHelloService.class, "/account/sayHelloService", "account", null, -1, -2147483648)`

`ARouter.getInstance().navigation(ISayHelloService::class.java)` æœ€ç»ˆä¼šä¸­è½¬è°ƒç”¨åˆ° `_ARouter` çš„ä»¥ä¸‹æ–¹æ³•

```java
protected <T> T navigation(Class<? extends T> service) {
    try {
        //ä» Warehouse.providersIndex å–å€¼æ‹¿åˆ° RouteMeta ä¸­å­˜å‚¨çš„ path å’Œ group
        Postcard postcard = LogisticsCenter.buildProvider(service.getName());

        // Compatible 1.0.5 compiler sdk.
        // Earlier versions did not use the fully qualified name to get the service
        if (null == postcard) {
            // No service, or this service in old version.
            postcard = LogisticsCenter.buildProvider(service.getSimpleName());
        }

        if (null == postcard) {
            return null;
        }
       //é‡ç‚¹
        LogisticsCenter.completion(postcard);
        return (T) postcard.getProvider();
    } catch (NoRouteFoundException ex) {
        logger.warning(Consts.TAG, ex.getMessage());
        return null;
    }
}
```

`LogisticsCenter.completion(postcard)` æ–¹æ³•çš„æµç¨‹å’Œä¹‹å‰è®²è§£çš„å·®ä¸å¤šï¼Œåªæ˜¯åœ¨è·å–å¯¹è±¡å®ä¾‹çš„æ—¶å€™åŒæ—¶å°†å®ä¾‹ç¼“å­˜èµ·æ¥ï¼Œç•™å¾…ä¹‹åå¤ç”¨ï¼Œè‡³æ­¤å°±å®Œæˆäº†æ§åˆ¶åè½¬çš„æµç¨‹äº†

```java
/**
 * Completion the postcard by route metas
 *
 * @param postcard Incomplete postcard, should complete by this method.
 */
public synchronized static void completion(Postcard postcard) {
   ... //çœç•¥ä¹‹å‰å·²ç»è®²è§£è¿‡çš„ä»£ç 	

   RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());

    switch (routeMeta.getType()) {
            case PROVIDER:  // if the route is provider, should find its instance
                // Its provider, so it must implement IProvider
                //æ‹¿åˆ° SayHelloService Class å¯¹è±¡
                Class<? extends IProvider> providerMeta = (Class<? extends IProvider>) routeMeta.getDestination();
                IProvider instance = Warehouse.providers.get(providerMeta);
                if (null == instance) { // There's no instance of this provider
                    //instance ç­‰äº null è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡å–å€¼
                    //é‚£ä¹ˆå°±é€šè¿‡åå°„æ„å»º SayHelloService å¯¹è±¡ï¼Œç„¶åå°†ä¹‹ç¼“å­˜åˆ° Warehouse.providers ä¸­
                    //æ‰€ä»¥é€šè¿‡æ§åˆ¶åè½¬è·å–çš„å¯¹è±¡åœ¨åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹
                    IProvider provider;
                    try {
                        provider = providerMeta.getConstructor().newInstance();
                        provider.init(mContext);
                        Warehouse.providers.put(providerMeta, provider);
                        instance = provider;
                    } catch (Exception e) {
                        throw new HandlerException("Init provider failed! " + e.getMessage());
                    }
                }
                //å°†è·å–åˆ°çš„å®ä¾‹å­˜èµ·æ¥
                postcard.setProvider(instance);
                postcard.greenChannel();    // Provider should skip all of interceptors
                break;
            case FRAGMENT:
                postcard.greenChannel();    // Fragment needn't interceptors
            default:
                break;
        }

}
```

# ä¸ƒã€æ‹¦æˆªå™¨

ARouter çš„æ‹¦æˆªå™¨å¯¹äºæŸäº›éœ€è¦æ§åˆ¶é¡µé¢è·³è½¬æµç¨‹çš„ä¸šåŠ¡é€»è¾‘æ¥è¯´æ˜¯ååˆ†æœ‰ç”¨çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¦‚æœè¦è·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µé¢æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¤„äºå·²ç™»å½•çŠ¶æ€ï¼Œè¿˜æœªç™»å½•çš„è¯å°±å¯ä»¥æ‹¦æˆªè¯¥è¯·æ±‚ï¼Œç„¶åè‡ªåŠ¨ä¸ºç”¨æˆ·æ‰“å¼€ç™»å½•é¡µé¢

æˆ‘ä»¬å¯ä»¥åŒæ—¶è®¾å®šå¤šä¸ªæ‹¦æˆªå™¨ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨è®¾å®šä¸åŒçš„ä¼˜å…ˆçº§

```kotlin
/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
@Interceptor(priority = 100, name = "å•¥ä¹Ÿä¸åšçš„æ‹¦æˆªå™¨")
class NothingInterceptor : IInterceptor {

    override fun init(context: Context) {

    }

    override fun process(postcard: Postcard, callback: InterceptorCallback) {
        //ä¸æ‹¦æˆªï¼Œä»»å…¶è·³è½¬
        callback.onContinue(postcard)
    }

}

@Interceptor(priority = 200, name = "ç™»é™†æ‹¦æˆªå™¨")
class LoginInterceptor : IInterceptor {

    override fun init(context: Context) {

    }

    override fun process(postcard: Postcard, callback: InterceptorCallback) {
        if (postcard.path == RoutePath.USER_HOME) {
            //æ‹¦æˆª
            callback.onInterrupt(null)
            //è·³è½¬åˆ°ç™»é™†é¡µ
            ARouter.getInstance().build(RoutePath.USER_LOGIN).navigation()
        } else {
            //ä¸æ‹¦æˆªï¼Œä»»å…¶è·³è½¬
            callback.onContinue(postcard)
        }
    }

}
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ `ARouter.getInstance().build(RoutePath.USER_HOME).navigation()` æƒ³è¦è·³è½¬çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°æ‰“å¼€çš„å…¶å®æ˜¯ç™»å½•é¡µ `RoutePath.USER_LOGIN`

æ¥çœ‹ä¸‹æ‹¦æˆªå™¨æ˜¯å¦‚ä½•å®ç°çš„

å¯¹äºä»¥ä¸Šçš„ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œä¼šç”Ÿæˆä»¥ä¸‹çš„è¾…åŠ©æ–‡ä»¶ã€‚è¾…åŠ©æ–‡ä»¶ä¼šæ‹¿åˆ°æ‰€æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å®ç°ç±»å¹¶æ ¹æ®ä¼˜å…ˆçº§é«˜ä½å­˜åˆ° Map ä¸­

```java
package com.alibaba.android.arouter.routes;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Interceptors$$user implements IInterceptorGroup {
  @Override
  public void loadInto(Map<Integer, Class<? extends IInterceptor>> interceptors) {
    interceptors.put(100, NothingInterceptor.class);
    interceptors.put(200, LoginInterceptor.class);
  }
}
```

è€Œè¿™äº›æ‹¦æˆªå™¨ä¸€æ ·æ˜¯ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡`LogisticsCenter.init`æ–¹æ³•å­˜åˆ° `Warehouse.interceptorsIndex`ä¸­

```java
/**
 * LogisticsCenter init, load all metas in memory. Demand initialization
 */
public synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {

    Â·Â·Â·

    for (String className : routerMap) {
        if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) {
            // This one of root elements, load root.
            ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);
        } else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) {
            // Load interceptorMeta
            //æ‹¿åˆ°è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å®ç°ç±»
            ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);
        } else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) {
            // Load providerIndex
            ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);
        }
    }

    Â·Â·Â·

}
```

ç„¶åï¼Œåœ¨ `_ARouter` çš„ `navigation` æ–¹æ³•ä¸­ï¼Œå¦‚ä½•åˆ¤æ–­åˆ°æ­¤æ¬¡è·¯ç”±è¯·æ±‚æ²¡æœ‰å¼€å¯ç»¿è‰²é€šé“æ¨¡å¼çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå°†æ­¤æ¬¡è¯·æ±‚è½¬äº¤ç»™ `interceptorService`ï¼Œè®©å…¶å»éå†æ¯ä¸ªæ‹¦æˆªå™¨

```java
final class _ARouter {
 
    /**
     * Use router navigation.
     *
     * @param context     Activity or null.
     * @param postcard    Route metas
     * @param requestCode RequestCode
     * @param callback    cb
     */
    protected Object navigation(final Context context, final Postcard postcard, final int requestCode, final NavigationCallback callback) {
        
        Â·Â·Â·
            
        if (!postcard.isGreenChannel()) {   // It must be run in async thread, maybe interceptor cost too mush time made ANR.
            
            //éå†æ‹¦æˆªå™¨
            interceptorService.doInterceptions(postcard, new InterceptorCallback() {
                /**
                 * Continue process
                 *
                 * @param postcard route meta
                 */
                @Override
                public void onContinue(Postcard postcard) {
                    _navigation(context, postcard, requestCode, callback);
                }

                /**
                 * Interrupt process, pipeline will be destory when this method called.
                 *
                 * @param exception Reson of interrupt.
                 */
                @Override
                public void onInterrupt(Throwable exception) {
                    if (null != callback) {
                        callback.onInterrupt(postcard);
                    }

                    logger.info(Consts.TAG, "Navigation failed, termination by interceptor : " + exception.getMessage());
                }
            });
        } else {
            return _navigation(context, postcard, requestCode, callback);
        }

        return null;
    }
    
}
```

`interceptorService` å˜é‡å±äº `InterceptorService` æ¥å£ç±»å‹ï¼Œè¯¥æ¥å£çš„å®ç°ç±»æ˜¯ `InterceptorServiceImpl`ï¼ŒARouterå†…éƒ¨åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯æ ¹æ®æ§åˆ¶åè½¬çš„æ–¹å¼æ¥æ‹¿åˆ° `interceptorService` è¿™ä¸ªå®ä¾‹çš„

`InterceptorServiceImpl` çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š

1. åœ¨ç¬¬ä¸€æ¬¡è·å– `InterceptorServiceImpl` å®ä¾‹çš„æ—¶å€™ï¼Œå…¶ `init` æ–¹æ³•ä¼šé©¬ä¸Šè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šäº¤ç”±çº¿ç¨‹æ± æ¥æ‰§è¡Œï¼Œé€šè¿‡åå°„ç”Ÿæˆæ¯ä¸ªæ‹¦æˆªå™¨å¯¹è±¡ï¼Œå¹¶è°ƒç”¨æ¯ä¸ªæ‹¦æˆªå™¨çš„ `init` æ–¹æ³•æ¥å®Œæˆæ‹¦æˆªå™¨çš„åˆå§‹åŒ–ï¼Œå¹¶å°†æ¯ä¸ªæ‹¦æˆªå™¨å¯¹è±¡éƒ½å­˜åˆ° `Warehouse.interceptors` ä¸­ã€‚å¦‚æœåˆå§‹åŒ–å®Œæˆäº†ï¼Œåˆ™å”¤é†’ç­‰å¾…åœ¨ `interceptorInitLock` ä¸Šçš„çº¿ç¨‹
2. å½“æ‹¦æˆªå™¨é€»è¾‘è¢«è§¦å‘ï¼Œå³ `doInterceptions` æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå¦‚æœæ­¤æ—¶ç¬¬ä¸€ä¸ªæ­¥éª¤è¿˜æœªæ‰§è¡Œå®Œçš„è¯ï¼Œåˆ™ä¼šé€šè¿‡ `checkInterceptorsInitStatus()`æ–¹æ³•ç­‰å¾…ç¬¬ä¸€ä¸ªæ­¥éª¤æ‰§è¡Œå®Œæˆã€‚å¦‚æœåç§’å†…éƒ½æœªå®Œæˆçš„è¯ï¼Œåˆ™èµ°å¤±è´¥æµç¨‹ç›´æ¥è¿”å›
3. åœ¨çº¿ç¨‹æ± ä¸­éå†æ‹¦æˆªå™¨åˆ—è¡¨ï¼Œå¦‚æœæœ‰æŸä¸ªæ‹¦æˆªå™¨æ‹¦æˆªäº†è¯·æ±‚çš„è¯åˆ™è°ƒç”¨ `callback.onInterrupt`æ–¹æ³•é€šçŸ¥å¤–éƒ¨ï¼Œå¦åˆ™çš„è¯åˆ™è°ƒç”¨ `callback.onContinue()` æ–¹æ³•ç»§ç»­è·³è½¬é€»è¾‘

```java
@Route(path = "/arouter/service/interceptor")
public class InterceptorServiceImpl implements InterceptorService {
    private static boolean interceptorHasInit;
    private static final Object interceptorInitLock = new Object();
    
    @Override
    public void init(final Context context) {
        LogisticsCenter.executor.execute(new Runnable() {
            @Override
            public void run() {
                if (MapUtils.isNotEmpty(Warehouse.interceptorsIndex)) {
                    //éå†æ‹¦æˆªå™¨åˆ—è¡¨ï¼Œé€šè¿‡åå°„æ„å»ºå¯¹è±¡å¹¶åˆå§‹åŒ–
                    for (Map.Entry<Integer, Class<? extends IInterceptor>> entry : Warehouse.interceptorsIndex.entrySet()) {
                        Class<? extends IInterceptor> interceptorClass = entry.getValue();
                        try {
                            IInterceptor iInterceptor = interceptorClass.getConstructor().newInstance();
                            iInterceptor.init(context);
                            //å­˜èµ·æ¥
                            Warehouse.interceptors.add(iInterceptor);
                        } catch (Exception ex) {
                            throw new HandlerException(TAG + "ARouter init interceptor error! name = [" + interceptorClass.getName() + "], reason = [" + ex.getMessage() + "]");
                        }
                    }

                    interceptorHasInit = true;

                    logger.info(TAG, "ARouter interceptors init over.");

                    synchronized (interceptorInitLock) {
                        interceptorInitLock.notifyAll();
                    }
                }
            }
        });
    }


    @Override
    public void doInterceptions(final Postcard postcard, final InterceptorCallback callback) {
        if (null != Warehouse.interceptors && Warehouse.interceptors.size() > 0) {

            checkInterceptorsInitStatus();

            if (!interceptorHasInit) {
                //åˆå§‹åŒ–å¤ªä¹…ï¼Œä¸ç­‰äº†ï¼Œç›´æ¥èµ°å¤±è´¥æµç¨‹
                callback.onInterrupt(new HandlerException("Interceptors initialization takes too much time."));
                return;
            }

            LogisticsCenter.executor.execute(new Runnable() {
                @Override
                public void run() {
                    CancelableCountDownLatch interceptorCounter = new CancelableCountDownLatch(Warehouse.interceptors.size());
                    try {
                        _excute(0, interceptorCounter, postcard);
                        interceptorCounter.await(postcard.getTimeout(), TimeUnit.SECONDS);
                        if (interceptorCounter.getCount() > 0) {    // Cancel the navigation this time, if it hasn't return anythings.
                            //å¤§äº 0 è¯´æ˜æ­¤æ¬¡è¯·æ±‚è¢«æŸä¸ªæ‹¦æˆªå™¨æ‹¦æˆªäº†ï¼Œèµ°å¤±è´¥æµç¨‹
                            callback.onInterrupt(new HandlerException("The interceptor processing timed out."));
                        } else if (null != postcard.getTag()) {    // Maybe some exception in the tag.
                            callback.onInterrupt(new HandlerException(postcard.getTag().toString()));
                        } else {
                            callback.onContinue(postcard);
                        }
                    } catch (Exception e) {
                        callback.onInterrupt(e);
                    }
                }
            });
        } else {
            callback.onContinue(postcard);
        }
    }

    /**
     * Excute interceptor
     *
     * @param index    current interceptor index
     * @param counter  interceptor counter
     * @param postcard routeMeta
     */
    private static void _excute(final int index, final CancelableCountDownLatch counter, final Postcard postcard) {
        if (index < Warehouse.interceptors.size()) {
            IInterceptor iInterceptor = Warehouse.interceptors.get(index);
            iInterceptor.process(postcard, new InterceptorCallback() {
                @Override
                public void onContinue(Postcard postcard) {
                    // Last interceptor excute over with no exception.
                    counter.countDown();
                    _excute(index + 1, counter, postcard);  // When counter is down, it will be execute continue ,but index bigger than interceptors size, then U know.
                }

                @Override
                public void onInterrupt(Throwable exception) {
                    // Last interceptor excute over with fatal exception.

                    postcard.setTag(null == exception ? new HandlerException("No message.") : exception.getMessage());    // save the exception message for backup.
                    counter.cancel();
                    // Be attention, maybe the thread in callback has been changed,
                    // then the catch block(L207) will be invalid.
                    // The worst is the thread changed to main thread, then the app will be crash, if you throw this exception!
//                    if (!Looper.getMainLooper().equals(Looper.myLooper())) {    // You shouldn't throw the exception if the thread is main thread.
//                        throw new HandlerException(exception.getMessage());
//                    }
                }
            });
        }
    }

    private static void checkInterceptorsInitStatus() {
        synchronized (interceptorInitLock) {
            while (!interceptorHasInit) {
                try {
                    interceptorInitLock.wait(10 * 1000);
                } catch (InterruptedException e) {
                    throw new HandlerException(TAG + "Interceptor init cost too much time error! reason = [" + e.getMessage() + "]");
                }
            }
        }
    }
    
}
```

# å…«ã€æ³¨è§£å¤„ç†å™¨

é€šç¯‡è¯»ä¸‹æ¥ï¼Œè¯»è€…åº”è¯¥èƒ½å¤Ÿæ„Ÿå—åˆ°æ³¨è§£å¤„ç†å™¨åœ¨ ARouter ä¸­èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ï¼Œä¾é æ³¨è§£å¤„ç†å™¨ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶ï¼ŒARouter æ‰èƒ½å®Œæˆ**å‚æ•°è‡ªåŠ¨æ³¨å…¥**ç­‰åŠŸèƒ½ã€‚è¿™é‡Œå°±å†æ¥ä»‹ç»ä¸‹ ARouter å…³äºæ³¨è§£å¤„ç†å™¨çš„å®ç°åŸç†

æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processing Toolï¼‰æ˜¯ä¸€ç§æ³¨è§£å¤„ç†å·¥å…·ï¼Œç”¨æ¥åœ¨ç¼–è¯‘æœŸæ‰«æå’Œå¤„ç†æ³¨è§£ï¼Œé€šè¿‡æ³¨è§£æ¥ç”Ÿæˆ Java æ–‡ä»¶ã€‚å³ä»¥æ³¨è§£ä½œä¸ºæ¡¥æ¢ï¼Œé€šè¿‡é¢„å…ˆè§„å®šå¥½çš„ä»£ç ç”Ÿæˆè§„åˆ™æ¥è‡ªåŠ¨ç”Ÿæˆ Java æ–‡ä»¶ã€‚æ­¤ç±»æ³¨è§£æ¡†æ¶çš„ä»£è¡¨æœ‰ ButterKnifeã€Dragger2ã€EventBus ç­‰

Java API å·²ç»æä¾›äº†æ‰«ææºç å¹¶è§£ææ³¨è§£çš„æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿ AbstractProcessor ç±»æ¥å®ç°è‡ªå·±çš„æ³¨è§£è§£æé€»è¾‘ã€‚APT çš„åŸç†å°±æ˜¯åœ¨æ³¨è§£äº†æŸäº›ä»£ç å…ƒç´ ï¼ˆå¦‚å­—æ®µã€å‡½æ•°ã€ç±»ç­‰ï¼‰åï¼Œåœ¨ç¼–è¯‘æ—¶ç¼–è¯‘å™¨ä¼šæ£€æŸ¥ AbstractProcessor çš„å­ç±»ï¼Œå¹¶ä¸”è‡ªåŠ¨è°ƒç”¨å…¶ `process()` æ–¹æ³•ï¼Œç„¶åå°†æ·»åŠ äº†æŒ‡å®šæ³¨è§£çš„æ‰€æœ‰ä»£ç å…ƒç´ ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œå¼€å‘è€…å†æ ¹æ®æ³¨è§£å…ƒç´ åœ¨ç¼–è¯‘æœŸè¾“å‡ºå¯¹åº”çš„ Java ä»£ç 

å…³äº APT æŠ€æœ¯çš„åŸç†å’Œåº”ç”¨å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Android APT å®ä¾‹è®²è§£](https://juejin.im/post/6844903753108160525)

ARouter æºç ä¸­å’Œæ³¨è§£å¤„ç†å™¨ç›¸å…³çš„ module æœ‰ä¸¤ä¸ªï¼š

- arouter-annotationã€‚Java Moduleï¼ŒåŒ…å«äº†åƒ Autowiredã€Interceptor è¿™äº›æ³¨è§£ä»¥åŠ RouteMeta ç­‰ JavaBean
- arouter-compilerã€‚Android Moduleï¼ŒåŒ…å«äº†å¤šä¸ª AbstractProcessor çš„å®ç°ç±»ç”¨äºç”Ÿæˆä»£ç 

è¿™é‡Œä¸»è¦æ¥çœ‹ `arouter-compiler`ï¼Œè¿™é‡Œä»¥è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ `NothingInterceptor` ä½œä¸ºä¾‹å­

```kotlin
package github.leavesc.user

/**
 * @Author: leavesCZY
 * @Githubï¼šhttps://github.com/leavesCZY
 */
@Interceptor(priority = 100, name = "å•¥ä¹Ÿä¸åšçš„æ‹¦æˆªå™¨")
class NothingInterceptor : IInterceptor {

    override fun init(context: Context) {

    }

    override fun process(postcard: Postcard, callback: InterceptorCallback) {
        //ä¸æ‹¦æˆªï¼Œä»»å…¶è·³è½¬
        callback.onContinue(postcard)
    }

}
```

ç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶ï¼š

```java
package com.alibaba.android.arouter.routes;

import com.alibaba.android.arouter.facade.template.IInterceptor;
import com.alibaba.android.arouter.facade.template.IInterceptorGroup;
import github.leavesc.user.NothingInterceptor;
import java.lang.Class;
import java.lang.Integer;
import java.lang.Override;
import java.util.Map;

/**
 * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */
public class ARouter$$Interceptors$$user implements IInterceptorGroup {
  @Override
  public void loadInto(Map<Integer, Class<? extends IInterceptor>> interceptors) {
    interceptors.put(100, NothingInterceptor.class);
  }
}
```

é‚£ä¹ˆï¼Œç”Ÿæˆçš„è¾…åŠ©æ–‡ä»¶æˆ‘ä»¬å°±è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…ƒç´ ï¼š

1. åŒ…å
2. å¯¼åŒ…
3. æ³¨é‡Š
4. å®ç°ç±»åŠç»§æ‰¿çš„æ¥å£
5. åŒ…å«çš„æ–¹æ³•åŠæ–¹æ³•å‚æ•°
6. æ–¹æ³•ä½“
7. ä¿®é¥°ç¬¦

å¦‚æœé€šè¿‡ç¡¬ç¼–ç çš„å½¢å¼ï¼Œå³é€šè¿‡æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼æ¥ç”Ÿæˆä»¥ä¸Šä»£ç ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™æ ·ä¼šä½¿å¾—ä»£ç ä¸å¥½ç»´æŠ¤ä¸”å¯è¯»æ€§å¾ˆä½ï¼Œæ‰€ä»¥ ARouter æ˜¯é€šè¿‡ `JavaPoet` è¿™ä¸ªå¼€æºåº“æ¥ç”Ÿæˆä»£ç çš„ã€‚`JavaPoet` æ˜¯ square å…¬å¸å¼€æºçš„ Java ä»£ç ç”Ÿæˆæ¡†æ¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡å…¶æä¾›çš„ API æ¥ç”ŸæˆæŒ‡å®šæ ¼å¼ï¼ˆä¿®é¥°ç¬¦ã€è¿”å›å€¼ã€å‚æ•°ã€å‡½æ•°ä½“ç­‰ï¼‰çš„ä»£ç 

æ‹¦æˆªå™¨å¯¹åº”çš„ `AbstractProcessor` å­ç±»å°±æ˜¯ `InterceptorProcessor`ï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š

1. åœ¨ process æ–¹æ³•ä¸­é€šè¿‡ RoundEnvironment æ‹¿åˆ°æ‰€æœ‰ä½¿ç”¨äº† @Interceptor æ³¨è§£è¿›è¡Œä¿®é¥°çš„ä»£ç å…ƒç´  elementsï¼Œç„¶åéå†æ‰€æœ‰ item
2. åˆ¤æ–­æ¯ä¸ª item æ˜¯å¦ç»§æ‰¿äº† IInterceptor æ¥å£ï¼Œæ˜¯çš„è¯åˆ™è¯´æ˜è¯¥ item å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æ‹¦æˆªå™¨å®ç°ç±»
3. è·å–æ¯ä¸ª item åŒ…å«çš„ @Interceptor æ³¨è§£å¯¹è±¡ï¼Œæ ¹æ®æˆ‘ä»¬ä¸ºä¹‹è®¾å®šçš„ä¼˜å…ˆçº§ priorityï¼Œå°†æ¯ä¸ª item æŒ‰é¡ºåºå­˜åˆ° interceptors ä¸­
4. å¦‚æœå­˜åœ¨ä¸¤ä¸ªæ‹¦æˆªå™¨çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸
5. å°†æ‰€æœ‰æ‹¦æˆªå™¨æŒ‰é¡ºåºå­˜å…¥ interceptors åï¼Œé€šè¿‡ JavaPoet æä¾›çš„ API æ¥ç”Ÿæˆ**åŒ…åã€å¯¼åŒ…ã€æ³¨é‡Šã€å®ç°ç±»**ç­‰å¤šä¸ªä»£ç å…ƒç´ ï¼Œå¹¶æœ€ç»ˆç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ç±»æ–‡ä»¶

```java
@AutoService(Processor.class)
@SupportedAnnotationTypes(ANNOTATION_TYPE_INTECEPTOR)
public class InterceptorProcessor extends BaseProcessor {

    //ç”¨äºä¿å­˜æ‹¦æˆªå™¨ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é«˜ä½è¿›è¡Œæ’åº
    private Map<Integer, Element> interceptors = new TreeMap<>();

    private TypeMirror iInterceptor = null;

    @Override
    public synchronized void init(ProcessingEnvironment processingEnv) {
        super.init(processingEnv);

        iInterceptor = elementUtils.getTypeElement(Consts.IINTERCEPTOR).asType();

        logger.info(">>> InterceptorProcessor init. <<<");
    }

    /**
     * {@inheritDoc}
     *
     * @param annotations
     * @param roundEnv
     */
    @Override
    public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {
        if (CollectionUtils.isNotEmpty(annotations)) {
            //æ‹¿åˆ°æ‰€æœ‰ä½¿ç”¨äº† @Interceptor è¿›è¡Œä¿®é¥°çš„ä»£ç å…ƒç´ 
            Set<? extends Element> elements = roundEnv.getElementsAnnotatedWith(Interceptor.class);
            try {
                parseInterceptors(elements);
            } catch (Exception e) {
                logger.error(e);
            }
            return true;
        }

        return false;
    }

    /**
     * Parse tollgate.
     *
     * @param elements elements of tollgate.
     */
    private void parseInterceptors(Set<? extends Element> elements) throws IOException {
        if (CollectionUtils.isNotEmpty(elements)) {
            logger.info(">>> Found interceptors, size is " + elements.size() + " <<<");

            // Verify and cache, sort incidentally.
            for (Element element : elements) {
                //åˆ¤æ–­ä½¿ç”¨äº† @Interceptor è¿›è¡Œä¿®é¥°çš„ä»£ç å…ƒç´ æ˜¯å¦åŒæ—¶å®ç°äº† com.alibaba.android.arouter.facade.template.IInterceptor è¿™ä¸ªæ¥å£
                //ä¸¤è€…ç¼ºä¸€ä¸å¯
                if (verify(element)) {  // Check the interceptor meta
                    logger.info("A interceptor verify over, its " + element.asType());
                    Interceptor interceptor = element.getAnnotation(Interceptor.class);

                    Element lastInterceptor = interceptors.get(interceptor.priority());
                    if (null != lastInterceptor) { // Added, throw exceptions
                        //ä¸ä¸º null è¯´æ˜å­˜åœ¨ä¸¤ä¸ªæ‹¦æˆªå™¨å…¶ä¼˜å…ˆçº§ç›¸ç­‰ï¼Œè¿™æ˜¯ä¸å…è®¸çš„ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
                        throw new IllegalArgumentException(
                                String.format(Locale.getDefault(), "More than one interceptors use same priority [%d], They are [%s] and [%s].",
                                        interceptor.priority(),
                                        lastInterceptor.getSimpleName(),
                                        element.getSimpleName())
                        );
                    }
                    //å°†æ‹¦æˆªå™¨æŒ‰ç…§ä¼˜å…ˆçº§é«˜ä½è¿›è¡Œæ’åºä¿å­˜
                    interceptors.put(interceptor.priority(), element);
                } else {
                    logger.error("A interceptor verify failed, its " + element.asType());
                }
            }

            // Interface of ARouter.
            //æ‹¿åˆ° com.alibaba.android.arouter.facade.template.IInterceptor è¿™ä¸ªæ¥å£çš„ç±»å‹æŠ½è±¡
            TypeElement type_ITollgate = elementUtils.getTypeElement(IINTERCEPTOR);
            //æ‹¿åˆ° com.alibaba.android.arouter.facade.template.IInterceptorGroup è¿™ä¸ªæ¥å£çš„ç±»å‹æŠ½è±¡
            TypeElement type_ITollgateGroup = elementUtils.getTypeElement(IINTERCEPTOR_GROUP);

            /**
             *  Build input type, format as :
             *
             *  ```Map<Integer, Class<? extends ITollgate>>```
             */
            //ç”Ÿæˆå¯¹ Map<Integer, Class<? extends IInterceptor>> è¿™æ®µä»£ç çš„æŠ½è±¡å°è£…
            ParameterizedTypeName inputMapTypeOfTollgate = ParameterizedTypeName.get(
                    ClassName.get(Map.class),
                    ClassName.get(Integer.class),
                    ParameterizedTypeName.get(
                            ClassName.get(Class.class),
                            WildcardTypeName.subtypeOf(ClassName.get(type_ITollgate))
                    )
            );

            // Build input param name.
            //ç”Ÿæˆ loadInto æ–¹æ³•çš„å…¥å‚å‚æ•° interceptors
            ParameterSpec tollgateParamSpec = ParameterSpec.builder(inputMapTypeOfTollgate, "interceptors").build();

            // Build method : 'loadInto'
            //ç”Ÿæˆ loadInto æ–¹æ³•
            MethodSpec.Builder loadIntoMethodOfTollgateBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)
                    .addAnnotation(Override.class)
                    .addModifiers(PUBLIC)
                    .addParameter(tollgateParamSpec);

            // Generate
            if (null != interceptors && interceptors.size() > 0) {
                // Build method body
                for (Map.Entry<Integer, Element> entry : interceptors.entrySet()) {
                    //éå†æ¯ä¸ªæ‹¦æˆªå™¨ï¼Œç”Ÿæˆ interceptors.put(100, NothingInterceptor.class); è¿™ç±»å‹çš„ä»£ç 
                    loadIntoMethodOfTollgateBuilder.addStatement("interceptors.put(" + entry.getKey() + ", $T.class)", ClassName.get((TypeElement) entry.getValue()));
                }
            }

            // Write to disk(Write file even interceptors is empty.)
            //åŒ…åå›ºå®šæ˜¯ PACKAGE_OF_GENERATE_FILEï¼Œå³ com.alibaba.android.arouter.routes
            JavaFile.builder(PACKAGE_OF_GENERATE_FILE,
                    TypeSpec.classBuilder(NAME_OF_INTERCEPTOR + SEPARATOR + moduleName) //è®¾ç½®ç±»å
                            .addModifiers(PUBLIC) //æ·»åŠ  public ä¿®é¥°ç¬¦
                            .addJavadoc(WARNING_TIPS) //æ·»åŠ æ³¨é‡Š
                            .addMethod(loadIntoMethodOfTollgateBuilder.build()) //æ·»åŠ  loadInto æ–¹æ³•
                            .addSuperinterface(ClassName.get(type_ITollgateGroup)) //æœ€åç”Ÿæˆçš„ç±»åŒæ—¶å®ç°äº† IInterceptorGroup æ¥å£
                            .build()
            ).build().writeTo(mFiler);

            logger.info(">>> Interceptor group write over. <<<");
        }
    }

    /**
     * Verify inteceptor meta
     *
     * @param element Interceptor taw type
     * @return verify result
     */
    private boolean verify(Element element) {
        Interceptor interceptor = element.getAnnotation(Interceptor.class);
        // It must be implement the interface IInterceptor and marked with annotation Interceptor.
        return null != interceptor && ((TypeElement) element).getInterfaces().contains(iInterceptor);
    }
}
```

# ä¹ã€ç»“å°¾

ARouter çš„å®ç°åŸç†å’Œæºç è§£æéƒ½è®²å¾—å·®ä¸å¤šäº†ï¼Œè‡ªè®¤è¿˜æ˜¯è®²å¾—æŒºå…¨é¢çš„ï¼Œé‚£ä¹ˆä¸‹ä¸€ç¯‡å°±å†æ¥è¿›å…¥å®æˆ˜ç¯‡å§ï¼Œè‡ªå·±æ¥åŠ¨æ‰‹å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ ARouter ğŸ˜‚ğŸ˜‚