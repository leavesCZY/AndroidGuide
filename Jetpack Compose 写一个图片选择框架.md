> å…¬ä¼—å·ï¼š[å­—èŠ‚æ•°ç»„](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image)
>  
> å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£


çŸ¥ä¹çš„ [Matisse](https://github.com/zhihu/Matisse) åº”è¯¥æœ‰è›®å¤šçš„ Android å¼€å‘è€…æœ‰äº†è§£è¿‡æˆ–è€…æ˜¯æ›¾ç»ä½¿ç”¨è¿‡ï¼Œè¿™æ˜¯çŸ¥ä¹åœ¨ 2017 å¹´å¼€æºçš„ä¸€ä¸ª Android ç«¯å›¾ç‰‡é€‰æ‹©æ¡†æ¶ï¼Œå…¶é¢œå€¼åœ¨ç°åœ¨çœ‹æ¥ä¹Ÿè¿˜æ˜¯æŒºä¸é”™çš„

![](https://upload-images.jianshu.io/upload_images/2552605-9504d5d974f9c21e.png#id=FnSsV&originHeight=507&originWidth=826&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

å¯æƒœè¿‘å‡ å¹´çŸ¥ä¹å®˜æ–¹å·²ç»ä¸å†å¯¹ Matisse è¿›è¡Œç»´æŠ¤æ›´æ–°äº†ï¼Œä¸Šä¸€æ¬¡æäº¤è®°å½•è¿˜åœç•™åœ¨ 2019 å¹´ï¼Œç´¯ç§¯äº†å››ç™¾å¤šä¸ª issues ä¸€ç›´æ²¡äººè§£ç­”ï¼Œå¾ˆå¤šé«˜ç‰ˆæœ¬ç³»ç»Ÿçš„å…¼å®¹æ€§é—®é¢˜å’Œå†…éƒ¨ bug ä¹Ÿä¸€ç›´å¾—ä¸åˆ°è§£å†³ã€‚æˆ‘åç¼–è¯‘äº†çŸ¥ä¹ Appï¼Œå‘ç°å…¶å†…éƒ¨è¿˜ä¿ç•™ç€ Matisse çš„ç›¸å…³ä»£ç ï¼Œæ‰€ä»¥çŸ¥ä¹åº”è¯¥ä¸æ˜¯å®Œå…¨åºŸå¼ƒäº† Matisseï¼Œè€Œåªæ˜¯ä¸å†å¼€æºåç»­æ›´æ–°äº†

æˆ‘å…¬å¸çš„é¡¹ç›®ä¹Ÿä½¿ç”¨åˆ°äº† Matisseï¼Œéšç€ Android ç³»ç»Ÿçš„æ›´æ–°ï¼Œæ—¶ä¸æ—¶åœ°å°±ä¼šæœ‰ç”¨æˆ·æ¥åé¦ˆé—®é¢˜ï¼Œæ— å¥ˆæˆ‘ä¹Ÿåªèƒ½ fork äº†æºç è‡ªå·±æ¥ç»´æŠ¤ã€‚ä¸€ç›´è¿™ä¹ˆå°ä¿®å°è¡¥ç»ˆç©¶ä¸å¤ªåˆé€‚ï¼Œè€Œä¸”å¦‚æœä¸è¿›è¡Œå®Œå…¨é‡å†™çš„è¯ï¼ŒMatisse çš„ä¸€äº›äº¤äº’ä½“éªŒé—®é¢˜ä¹Ÿæ²¡æ³•å¾—åˆ°å½»åº•è§£å†³ï¼Œè€Œè¿™äº›é—®é¢˜åœ¨ç›®å‰çš„çŸ¥ä¹ App ä¸Šä¹Ÿä¸€æ ·å­˜åœ¨ï¼Œä»¥ä¿®æ”¹ä¸ªäººå¤´åƒæ—¶æ‰“å¼€çš„å›¾ç‰‡é€‰æ‹©é¡µé¢ä¸ºä¾‹ï¼š

![](https://upload-images.jianshu.io/upload_images/2552605-69332d4499ae215b.gif#id=GMNgn&originHeight=893&originWidth=427&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

æˆ‘å‘ç°çš„é—®é¢˜æœ‰ä¸‰ä¸ªï¼š

- çŸ¥ä¹çš„ç”¨æˆ·å¤´åƒä¸æ”¯æŒ Gif æ ¼å¼ï¼Œå½“ç”¨æˆ·ç‚¹å‡» Gif å›¾ç‰‡æ—¶ä¼šæç¤º â€œä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹â€ã€‚æŒ‰æˆ‘çš„æƒ³æ³•ï¼Œæ—¢ç„¶ä¸æ”¯æŒ Gif æ ¼å¼ï¼Œé‚£ä¹ˆä¸€å¼€å§‹å±•ç¤ºçš„æ—¶å€™å°±åº”è¯¥è¿‡æ»¤æ‰æ‰å¯¹ï¼Œè€ŒçŸ¥ä¹ç›®å‰çš„ç­›é€‰é€»è¾‘åº”è¯¥å°±æ˜¯æ¥æºè‡ª Matisse ï¼Œå› ä¸º Matisse ä¹Ÿä¸æ”¯æŒ **åªå±•ç¤ºé™æ€å›¾**ï¼Œä½†åˆå¯ä»¥ **åªå±•ç¤º Gif**ï¼Œè¿™ç­›é€‰é€»è¾‘æˆ‘è§‰å¾—ååˆ†å¥‡æ€ª
- å½“å–æ¶ˆå‹¾é€‰é™æ€å›¾æ—¶ï¼Œå¯ä»¥çœ‹åˆ° Gif å›¾ç‰‡ä¼šå¾ˆæ˜æ˜¾åœ°é—ªçƒäº†ä¸€ä¸‹ï¼Œæ­¤é—®é¢˜åœ¨ Matisse ä¸­ä¹Ÿå­˜åœ¨ã€‚è€Œå¦‚æœä»çŸ¥ä¹çš„ç¼–è¾‘å™¨è¿›å…¥å›¾ç‰‡é€‰æ‹©é¡µé¢çš„è¯ï¼Œå°±ä¸å•å•æ˜¯ Gif å›¾ç‰‡ä¼šé—ªçƒäº†ï¼Œè€Œæ˜¯æ•´ä¸ªé¡µé¢éƒ½ä¼šé—ªçƒä¸€ä¸‹â€¦
- å½“ç‚¹å‡»ä¸‹æ‹‰èœå•æ—¶ï¼Œå¯ä»¥çœ‹åˆ° Pictures ç›®å½•ä¸­æœ‰ä¸‰å¼ å›¾ç‰‡ï¼Œä½†æ‰“å¼€ç›®å½•åˆå‘ç°æ˜¯ç©ºçš„ã€‚è¿™æ˜¯ç”±äºçŸ¥ä¹æ²¡æœ‰è¿‡æ»¤æ‰ä¸€äº›è„æ•°æ®å¯¼è‡´çš„ï¼Œåé¢ä¼šè®²åˆ°å…·ä½“åŸå› 

ç”±äºä»¥ä¸Šé—®é¢˜ï¼Œä¹Ÿè®©æˆ‘æœ‰äº†å½»åº•æ”¾å¼ƒ Matisseï¼Œè‡ªå·±æ¥å®ç°ä¸€ä¸ªæ–°çš„å›¾ç‰‡é€‰æ‹©æ¡†æ¶çš„æ‰“ç®—ï¼Œä¹Ÿå®ç°å¾—å·®ä¸å¤šäº†ï¼Œæœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤º

![](https://upload-images.jianshu.io/upload_images/2552605-8772ec10193468d5.png#id=oM7Nh&originHeight=598&originWidth=882&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

æ­¤æ¡†æ¶çš„ç‰¹ç‚¹ & ä¼˜åŠ¿æœ‰ï¼š

- é€‚é…åˆ° Android 13
- è§£å†³äº†å¤šä¸ªç³»ç»Ÿå…¼å®¹æ€§é—®é¢˜ï¼Œä¸‹æ–‡ä¼šæåˆ°
- å®Œå…¨ç”¨ Kotlin & Jetpack Compose å®ç°
- æ”¯æŒç²¾å‡†ç­›é€‰å›¾ç‰‡ç±»å‹å¹¶è·å–å›¾ç‰‡çš„è¯¦ç»†ä¿¡æ¯
- æ”¯æŒç²¾ç»†è‡ªå®šä¹‰ä¸»é¢˜ï¼Œé»˜è®¤æä¾›æ—¥å¤œé—´ä¸¤å¥—ä¸»é¢˜
- æ”¯æŒç›´æ¥å¯åŠ¨æ‹ç…§æµç¨‹ï¼Œä¸€å…±åŒ…å«å››ç§æ‹ç…§ç­–ç•¥ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©æ˜¯å¦è¦ç”³è¯·æƒé™

æ­¤æ¡†æ¶ä¹Ÿæœ‰ä¸€äº›åŠ£åŠ¿ï¼š

- é¢„è§ˆå›¾ç‰‡æ—¶ä¸æ”¯æŒæ‰‹åŠ¿ç¼©æ”¾ã€‚ä¸€å¼€å§‹æˆ‘æœ‰å°è¯•ç”¨ Jetpack Compose æ¥å®ç°å›¾ç‰‡æ‰‹åŠ¿ç¼©æ”¾ï¼Œä½†æ•ˆæœä¸å¤ªç†æƒ³ï¼Œè€Œæˆ‘åˆä¸æƒ³å¼•å…¥ View ä½“ç³»ä¸­çš„ä¸‰æ–¹åº“ï¼Œæ‰€ä»¥æ­¤ç‰ˆæœ¬æš‚ä¸æ”¯æŒå›¾ç‰‡æ‰‹åŠ¿ç¼©æ”¾
- æ¡†æ¶å†…éƒ¨é‡‡ç”¨çš„å›¾ç‰‡åŠ è½½åº“æ˜¯ Coilï¼Œä¸”ä¸æ”¯æŒæ›¿æ¢ã€‚ç”±äºç›®å‰æ”¯æŒ Jetpack Compose çš„å›¾ç‰‡åŠ è½½åº“åŸºæœ¬åªèƒ½é€‰æ‹© Coil äº†ï¼Œå› æ­¤æ²¡æœ‰æä¾›æ›¿æ¢å›¾ç‰‡åŠ è½½åº“çš„å…¥å£
- å›¾ç‰‡åˆ—è¡¨çš„æ»‘åŠ¨æ€§èƒ½è¦ä½äºåŸç”Ÿçš„ RecyclerViewï¼Œdebug ç‰ˆæœ¬å°¤ä¸ºæ˜æ˜¾ã€‚æ­¤é—®é¢˜ç›®å‰æ— è§£ï¼Œåªèƒ½ç­‰ Google å®˜æ–¹åç»­çš„ä¼˜åŒ–äº†

ä»£ç æˆ‘ä¹Ÿå¼€æºåˆ°äº† Githubï¼Œæ‡’å¾—æƒ³åå­—ï¼Œå†åŠ ä¸Šä¸€å¼€å§‹çš„è®¾è®¡æ€è·¯ä¹Ÿæ¥è‡ªäº Matisseï¼Œå› æ­¤å°±å–äº†ä¸€æ ·çš„åå­—ï¼Œä¹Ÿå« [Matisse](https://github.com/leavesCZY/Matisse)ã€‚ä¸‹æ–‡å¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼ŒMatisse æŒ‡çš„å°±æ˜¯æ­¤ Jetpack Compose ç‰ˆæœ¬çš„å›¾ç‰‡é€‰æ‹©æ¡†æ¶äº†

åœ¨ UI å±‚é¢ä¸Šï¼Œç”¨ Jetpack Compose æ¥å®ç°ç›¸æ¯”åŸç”Ÿçš„ View ä½“ç³»å®åœ¨è¦ç®€å•å¾ˆå¤šï¼Œåœ¨è¿™ä¸€å—é™¤äº†æ»‘åŠ¨æ€§èƒ½ä¹‹å¤–æˆ‘ä¹Ÿæ²¡é‡åˆ°å…¶å®ƒé—®é¢˜ã€‚å› æ­¤ï¼Œæœ¬æ–‡çš„å†…å®¹å’Œ Jetpack Compose æ— å…³ï¼Œä¸»è¦æ˜¯è®² Matisse çš„ä¸€äº›å®ç°ç»†èŠ‚å’Œé‡åˆ°çš„ç³»ç»Ÿå…¼å®¹æ€§é—®é¢˜

# è·å–å›¾ç‰‡

å®ç°ä¸€ä¸ªå›¾ç‰‡é€‰æ‹©æ¡†æ¶çš„ç¬¬ä¸€æ­¥è‡ªç„¶å°±æ˜¯è¦è·å–åˆ°ç›¸å†Œå†…çš„æ‰€æœ‰å›¾ç‰‡äº†ï¼Œå› æ­¤éœ€è¦ç”³è¯· READ_EXTERNAL_STORAGE æˆ–è€… READ_MEDIA_IMAGES æƒé™ï¼Œæ­¤å¤–è¿˜éœ€è¦ä¾èµ–ç³»ç»Ÿçš„ MediaStore API

MediaStore ç›¸å½“äºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ•°æ®åº“ï¼Œè®°å½•äº†å½“å‰è®¾å¤‡ä¸­æ‰€æœ‰æ–‡ä»¶çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥å¿«é€ŸæŸ¥æ‰¾è®¾å¤‡ä¸­ç‰¹å®šç±»å‹çš„æ–‡ä»¶ã€‚Matisse ä½¿ç”¨çš„æ˜¯ MediaStore.Imageï¼Œåœ¨æ“ä½œä¸Šå°±ç±»ä¼¼äºæŸ¥è¯¢æ•°æ®åº“ï¼Œé€šè¿‡å£°æ˜éœ€è¦çš„æ•°æ®åº“å­—æ®µ projection å’Œæ’åºè§„åˆ™ sortOrderï¼Œå¾—åˆ°ç›¸åº”çš„æ•°æ®åº“æ¸¸æ ‡ cursorï¼Œé€šè¿‡ cursor éå†æŸ¥è¯¢å‡ºæ¯ä¸€ä¸ªå­—æ®µå€¼

```kotlin
val projection = arrayOf(
    MediaStore.Images.Media._ID,
    MediaStore.Images.Media.DISPLAY_NAME,
    MediaStore.Images.Media.MIME_TYPE,
    MediaStore.Images.Media.WIDTH,
    MediaStore.Images.Media.HEIGHT,
    MediaStore.Images.Media.SIZE,
    MediaStore.Images.Media.ORIENTATION,
    MediaStore.Images.Media.DATA,
    MediaStore.Images.Media.BUCKET_ID,
    MediaStore.Images.Media.BUCKET_DISPLAY_NAME,
)
val sortOrder = "${MediaStore.Images.Media.DATE_MODIFIED} DESC"
val mediaResourceList = mutableListOf<MediaResource>()
try {
    val mediaCursor = context.contentResolver.query(
        MediaStore.Images.Media.EXTERNAL_CONTENT_URI,
        projection,
        selection,
        selectionArgs,
        sortOrder,
    ) ?: return@withContext null
    mediaCursor.use { cursor ->
        while (cursor.moveToNext()) {
            val data = cursor.getString(MediaStore.Images.Media.DATA)
            if (data.isBlank() || !File(data).exists()) {
                continue
            }
            val id = cursor.getLong(MediaStore.Images.Media._ID)
            val displayName = cursor.getString(MediaStore.Images.Media.DISPLAY_NAME)
            val mimeType = cursor.getString(MediaStore.Images.Media.MIME_TYPE)
            val width = cursor.getInt(MediaStore.Images.Media.WIDTH)
            val height = cursor.getInt(MediaStore.Images.Media.HEIGHT)
            val size = cursor.getLong(MediaStore.Images.Media.SIZE)
            val orientation = cursor.getInt(MediaStore.Images.Media.ORIENTATION)
            val bucketId = cursor.getString(MediaStore.Images.Media.BUCKET_ID)
            val bucketDisplayName =
                cursor.getString(MediaStore.Images.Media.BUCKET_DISPLAY_NAME)
            val contentUri = ContentUris.withAppendedId(
                MediaStore.Images.Media.EXTERNAL_CONTENT_URI,
                id
            )
            val mediaResource = MediaResource(
                id = id,
                uri = contentUri,
                displayName = displayName,
                mimeType = mimeType,
                width = width,
                height = height,
                orientation = orientation,
                path = data,
                size = size,
                bucketId = bucketId,
                bucketDisplayName = bucketDisplayName,
            )
            mediaResourceList.add(mediaResource)
        }
    }
} catch (e: Throwable) {
    e.printStackTrace()
}
return@withContext mediaResourceList
```

æ¯ä¸€å¼ å›¾ç‰‡éƒ½å­˜æ”¾äºç‰¹å®šçš„ç›¸å†Œæ–‡ä»¶å¤¹å†…ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ bucketId æ¥å¯¹æ¯ä¸€å¼ å›¾ç‰‡è¿›è¡Œå½’ç±»ï¼Œä»è€Œå¾—åˆ° Matisse ä¸­çš„ä¸‹æ‹‰èœå•

```kotlin
suspend fun groupByBucket(resources: List<MediaResource>): List<MediaBucket> {
    return withContext(context = Dispatchers.IO) {
        val resourcesMap = linkedMapOf<String, MutableList<MediaResource>>()
        resources.forEach { res ->
            val bucketId = res.bucketId
            val list = resourcesMap[bucketId]
            if (list == null) {
                resourcesMap[bucketId] = mutableListOf(res)
            } else {
                list.add(res)
            }
        }
        val allMediaBucketResource = mutableListOf<MediaBucket>()
        resourcesMap.forEach {
            val resourcesList = it.value
            if (resourcesList.isNotEmpty()) {
                val bucketId = it.key
                val bucketDisplayName = resourcesList[0].bucketDisplayName
                allMediaBucketResource.add(
                    MediaBucket(
                        id = bucketId,
                        displayName = bucketDisplayName,
                        displayIcon = resourcesList[0].uri,
                        resources = resourcesList,
                        supportCapture = false
                    )
                )
            }
        }
        return@withContext allMediaBucketResource
    }
}
```

# æ‹ç…§ç­–ç•¥

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯¹äºæ‹ç…§åŠŸèƒ½éƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„è‡ªå®šä¹‰éœ€æ±‚ï¼Œå› æ­¤å¤§å¤šæ˜¯é€šè¿‡ç›´æ¥è°ƒèµ·ç³»ç»Ÿç›¸æœºæ¥å®ç°æ‹ç…§ï¼Œä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œä¸”ä¸ç”¨ç”³è¯· CAMERA æƒé™

å®ç°ä»£ç å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼Œæœ€ç»ˆå›¾ç‰‡å°±ä¼šä¿å­˜åœ¨ imageUri æŒ‡å‘çš„æ–‡ä»¶ä¸­

```kotlin
class MatisseActivity : ComponentActivity() {

    private var tempImageUri: Uri? = null

    private fun takePicture(imageUri: Uri) {
        tempImageUri = imageUri
        val intent = Intent(MediaStore.ACTION_IMAGE_CAPTURE)
        intent.putExtra(MediaStore.EXTRA_OUTPUT, imageUri)
        startActivityForResult(intent, 1)
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if (requestCode == 1 && resultCode == Activity.RESULT_OK) {
            val mTempImageUri = tempImageUri
            if (mTempImageUri != null) {
                //TODO
            }
        }
    }

}
```

ä»¥ä¸Šä»£ç å±äºé€šç”¨æµç¨‹ï¼Œå½“åˆ¤æ–­åˆ°å®Œæˆæ‹ç…§åï¼Œå°†ä»¥ä¸Šçš„ imageUri è¿”å›å³å¯

ä½†ç”Ÿæˆ imageUri å´æœ‰ç€å¾ˆå¤šå­¦é—®ï¼šä¸åŒçš„ç”Ÿæˆè§„åˆ™å¯¹åº”ç€ä¸åŒçš„æƒé™ï¼Œç”šè‡³åŒç§æ–¹å¼åœ¨ä¸åŒç³»ç»Ÿç‰ˆæœ¬ä¸Šå¯¹æƒé™çš„è¦æ±‚ä¹Ÿä¸ä¸€æ ·ï¼Œå¯¹ç”¨æˆ·çš„æ„ŸçŸ¥ä¹Ÿä¸ä¸€æ ·ã€‚æ­¤å¤–ï¼Œå¦‚æœç”¨æˆ·åˆå–æ¶ˆäº†æ‹ç…§çš„è¯ï¼Œæ­¤æ—¶ imageUri æŒ‡å‘çš„å›¾ç‰‡æ–‡ä»¶å°±æ²¡æœ‰ç”¨äº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸»åŠ¨åˆ é™¤è¯¥æ–‡ä»¶

Matisse é€šè¿‡ CaptureStrategy æ¥å£æ¥æŠ½è±¡ä»¥ä¸Šé€»è¾‘

```kotlin
/**
 * æ‹ç…§ç­–ç•¥
 */
interface CaptureStrategy : Parcelable {

    /**
     * æ˜¯å¦å¯ç”¨æ‹ç…§åŠŸèƒ½
     */
    fun isEnabled(): Boolean

    /**
     * æ˜¯å¦éœ€è¦ç”³è¯·è¯»å–å­˜å‚¨å¡çš„æƒé™
     */
    fun shouldRequestWriteExternalStoragePermission(context: Context): Boolean

    /**
     * è·å–ç”¨äºå­˜å‚¨æ‹ç…§ç»“æœçš„ Uri
     */
    suspend fun createImageUri(context: Context): Uri?

    /**
     * è·å–æ‹ç…§ç»“æœ
     */
    suspend fun loadResource(context: Context, imageUri: Uri): MediaResource?

    /**
     * å½“ç”¨æˆ·å–æ¶ˆæ‹ç…§æ—¶è°ƒç”¨
     */
    suspend fun onTakePictureCanceled(context: Context, imageUri: Uri)

    /**
     * ç”Ÿæˆå›¾ç‰‡æ–‡ä»¶å
     */
    fun createImageName(): String {
        val uuid = UUID.randomUUID().toString()
        val randomName = uuid.substring(0, 8)
        return "$randomName.jpg"
    }

}
```

Matisse å®ç°äº†å››ç§æ‹ç…§ç­–ç•¥ä¾›å¼•ç”¨æ–¹ä½¿ç”¨ï¼š

- NothingCaptureStrategy
- FileProviderCaptureStrategy
- MediaStoreCaptureStrategy
- SmartCaptureStrategy

## NothingCaptureStrategy

NothingCaptureStrategy ä»£è¡¨çš„æ˜¯ä¸å¼€å¯æ‹ç…§åŠŸèƒ½ï¼Œä¹Ÿæ˜¯ Matisse çš„é»˜è®¤ç­–ç•¥

```kotlin
/**
 *  ä¸å¼€å¯æ‹ç…§åŠŸèƒ½
 */
@Parcelize
object NothingCaptureStrategy : CaptureStrategy {

    override fun isEnabled(): Boolean {
        return false
    }

    override fun shouldRequestWriteExternalStoragePermission(context: Context): Boolean {
        return false
    }

    override suspend fun createImageUri(context: Context): Uri? {
        return null
    }

    override suspend fun loadResource(context: Context, imageUri: Uri): MediaResource? {
        return null
    }

    override suspend fun onTakePictureCanceled(context: Context, imageUri: Uri) {

    }

}
```

## FileProviderCaptureStrategy

é¡¾åæ€ä¹‰ï¼Œæ­¤ç­–ç•¥é€šè¿‡ FileProvider æ¥ç”Ÿæˆæ‰€éœ€è¦çš„ imageUri

ä» Android 7.0 å¼€å§‹ï¼Œç³»ç»Ÿç¦æ­¢åº”ç”¨é€šè¿‡ Â `file://URI` æ¥è®¿é—®å…¶ä»–åº”ç”¨çš„ç§æœ‰ç›®å½•æ–‡ä»¶ï¼Œè¦åœ¨åº”ç”¨é—´å…±äº«ç§æœ‰æ–‡ä»¶ï¼Œå¿…é¡»é€šè¿‡ `content://URI` å¹¶æˆäºˆ URI ä¸´æ—¶è®¿é—®æƒé™æ¥å®ç°ï¼Œå¦åˆ™å°†ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚è€Œå°† File è½¬æ¢ä¸º `content://URI` çš„æ“ä½œå°±éœ€è¦ä¾é  FileProvider æ¥å®ç°äº†ã€‚Matisse ä¼ é€’ç»™ç³»ç»Ÿç›¸æœºçš„ imageUri ä¹Ÿéœ€è¦æ»¡è¶³æ­¤è¦æ±‚

FileProviderCaptureStrategy é‡‡ç”¨çš„ç­–ç•¥å°±æ˜¯ï¼š

- åœ¨ ExternalFilesDir çš„ Pictures ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå›¾ç‰‡ä¸´æ—¶æ–‡ä»¶ç”¨äºå­˜å‚¨æ‹ç…§ç»“æœï¼Œé€šè¿‡ FileProvider å¾—åˆ°è¯¥æ–‡ä»¶å¯¹åº”çš„ `content://URI` ï¼Œä»è€Œå¾—åˆ°å¾…å†™å…¥çš„ imageUri
- å‡å¦‚ç”¨æˆ·æœ€ç»ˆå®Œæˆæ‹ç…§ï¼Œåˆ™é€šè¿‡ BitmapFactory è·å–å›¾ç‰‡çš„è¯¦ç»†ä¿¡æ¯
- å‡å¦‚ç”¨æˆ·æœ€ç»ˆå–æ¶ˆæ‹ç…§ï¼Œåˆ™ç›´æ¥åˆ é™¤åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶
- ç”±äºå›¾ç‰‡æ˜¯ä¿å­˜åœ¨åº”ç”¨è‡ªèº«çš„ç§æœ‰ç›®å½•ä¸­ï¼Œå› æ­¤ä¸éœ€è¦ç”³è¯·ä»»ä½•æƒé™ï¼Œä¹Ÿæ­£å› ä¸ºæ˜¯ç§æœ‰ç›®å½•ï¼Œæ‰€ä»¥å›¾ç‰‡ä¸ä¼šå‡ºç°åœ¨ç³»ç»Ÿç›¸å†Œä¸­

```kotlin
/**
 *  é€šè¿‡ FileProvider æ¥ç”Ÿæˆæ‹ç…§æ‰€éœ€è¦çš„ ImageUri
 *  æ— éœ€ç”³è¯·æƒé™ï¼Œæ‰€æ‹çš„ç…§ç‰‡ä¸ä¼šä¿å­˜åœ¨ç³»ç»Ÿç›¸å†Œé‡Œ
 *  å¤–éƒ¨å¿…é¡»é…ç½® FileProviderï¼Œå¹¶åœ¨æ­¤å¤„ä¼ å…¥ authority
 */
@Parcelize
class FileProviderCaptureStrategy(private val authority: String) : CaptureStrategy {

    @IgnoredOnParcel
    private val uriFileMap = mutableMapOf<Uri, File>()

    override fun isEnabled(): Boolean {
        return true
    }

    override fun shouldRequestWriteExternalStoragePermission(context: Context): Boolean {
        return false
    }

    override suspend fun createImageUri(context: Context): Uri? {
        return withContext(context = Dispatchers.IO) {
            try {
                val tempFile = createTempFile(context = context)
                if (tempFile != null) {
                    val uri = FileProvider.getUriForFile(context, authority, tempFile)
                    uriFileMap[uri] = tempFile
                    return@withContext uri
                }
            } catch (e: Throwable) {
                e.printStackTrace()
            }
            return@withContext null
        }
    }

    private fun createTempFile(context: Context): File? {
        val storageDir = context.getExternalFilesDir(Environment.DIRECTORY_PICTURES)
        val file = File(storageDir, createImageName())
        if (file.createNewFile()) {
            return file
        }
        return null
    }

    override suspend fun loadResource(context: Context, imageUri: Uri): MediaResource {
        return withContext(context = Dispatchers.IO) {
            val imageFile = uriFileMap[imageUri]!!
            uriFileMap.remove(key = imageUri)
            val imageFilePath = imageFile.absolutePath
            val option = BitmapFactory.Options()
            option.inJustDecodeBounds = true
            BitmapFactory.decodeFile(imageFilePath, option)
            return@withContext MediaResource(
                id = 0,
                uri = imageUri,
                displayName = imageFile.name,
                mimeType = option.outMimeType ?: "",
                width = max(option.outWidth, 0),
                height = max(option.outHeight, 0),
                orientation = 0,
                size = imageFile.length(),
                path = imageFile.absolutePath,
                bucketId = "",
                bucketDisplayName = ""
            )
        }
    }

    override suspend fun onTakePictureCanceled(context: Context, imageUri: Uri) {
        withContext(context = Dispatchers.IO) {
            val imageFile = uriFileMap[imageUri]
            if (imageFile != null && imageFile.exists()) {
                imageFile.delete()
            }
            uriFileMap.remove(key = imageUri)
        }
    }

}
```

å¤–éƒ¨éœ€è¦åœ¨è‡ªèº«é¡¹ç›®ä¸­å£°æ˜ FileProviderï¼Œauthorities è§†è‡ªèº«æƒ…å†µè€Œå®šï¼Œé€šè¿‡ authorities æ¥å®ä¾‹åŒ– FileProviderCaptureStrategy

```kotlin
<provider
    android:name="androidx.core.content.FileProvider"
    android:authorities="github.leavesczy.matisse.samples.FileProvider"
    android:exported="false"
    android:grantUriPermissions="true">
    <meta-data
        android:name="android.support.FILE_PROVIDER_PATHS"
        android:resource="@xml/file_paths" />
</provider>
```

`file_paths.xml` ä¸­éœ€è¦é…ç½® `external-files-path` è·¯å¾„çš„ Pictures æ–‡ä»¶å¤¹ï¼Œname å¯ä»¥éšæ„å‘½å

```kotlin
<?xml version="1.0" encoding="utf-8"?>
<paths>
    <external-files-path
        name="Capture"
        path="Pictures" />
</paths>
```

## MediaStoreCaptureStrategy

é¡¾åæ€ä¹‰ï¼Œæ­¤ç­–ç•¥é€šè¿‡ MediaStore æ¥ç”Ÿæˆæ‰€éœ€è¦çš„ imageUri

åœ¨ Android 10 ç³»ç»Ÿä¹‹å‰ï¼Œåº”ç”¨éœ€è¦è·å–åˆ° WRITE_EXTERNAL_STORAGE æƒé™åæ‰å¯ä»¥å‘å…±äº«å­˜å‚¨ç©ºé—´ä¸­å†™å…¥æ–‡ä»¶ã€‚ä» Android 10 å¼€å§‹ï¼Œåº”ç”¨é€šè¿‡ MediaStore å‘å…±äº«å­˜å‚¨ç©ºé—´ä¸­å†™å…¥æ–‡ä»¶æ— éœ€ä»»ä½•æƒé™ï¼Œä¸”å¯¹äºåº”ç”¨è‡ªèº«åˆ›å»ºçš„æ–‡ä»¶ï¼Œæ— éœ€ READ_EXTERNAL_STORAGE æƒé™å°±å¯ä»¥ç›´æ¥è®¿é—®å’Œåˆ é™¤

MediaStoreCaptureStrategy é‡‡ç”¨çš„ç­–ç•¥å°±æ˜¯ï¼š

- åœ¨å¤§äºç­‰äº 10 çš„ç³»ç»Ÿç‰ˆæœ¬ä¸­ï¼Œä¸ç”³è¯· WRITE_EXTERNAL_STORAGE æƒé™ï¼Œå…¶å®ƒç³»ç»Ÿç‰ˆæœ¬åˆ™è¿›è¡Œç”³è¯·
- é€šè¿‡ MediaStore åœ¨ç³»ç»Ÿç›¸å†Œä¸­é¢„åˆ›å»ºä¸€å¼ å›¾ç‰‡ï¼Œä»è€Œå¾—åˆ°å¾…å†™å…¥çš„ imageUri
- å‡å¦‚ç”¨æˆ·æœ€ç»ˆå®Œæˆæ‹ç…§ï¼Œåˆ™é€šè¿‡ MediaStore å»æŸ¥è¯¢ imageUri å¯¹åº”å›¾ç‰‡çš„è¯¦ç»†ä¿¡æ¯
- å‡å¦‚ç”¨æˆ·æœ€ç»ˆå–æ¶ˆæ‹ç…§ï¼Œåˆ™é€šè¿‡ MediaStore åˆ é™¤ imageUri æŒ‡å‘çš„è„æ•°æ®
- ç”±äºå›¾ç‰‡ä¸€å¼€å§‹å°±ä¿å­˜åœ¨ MediaStore ä¸­ï¼Œå› æ­¤å›¾ç‰‡ä¼šæ˜¾ç¤ºåœ¨ç³»ç»Ÿç›¸å†Œä¸­

```kotlin
/**
 *  é€šè¿‡ MediaStore æ¥ç”Ÿæˆæ‹ç…§æ‰€éœ€è¦çš„ ImageUri
 *  æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬å†³å®šæ˜¯å¦éœ€è¦ç”³è¯· WRITE_EXTERNAL_STORAGE æƒé™
 *  æ‰€æ‹çš„ç…§ç‰‡ä¼šä¿å­˜åœ¨ç³»ç»Ÿç›¸å†Œé‡Œ
 */
@Parcelize
class MediaStoreCaptureStrategy : CaptureStrategy {

    override fun isEnabled(): Boolean {
        return true
    }

    override fun shouldRequestWriteExternalStoragePermission(context: Context): Boolean {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            return false
        }
        return ActivityCompat.checkSelfPermission(
            context,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
        ) == PackageManager.PERMISSION_DENIED
    }

    override suspend fun createImageUri(context: Context): Uri? {
        return MediaProvider.createImage(context = context, fileName = createImageName())
    }

    override suspend fun loadResource(context: Context, imageUri: Uri): MediaResource? {
        return MediaProvider.loadResources(context = context, uri = imageUri)
    }

    override suspend fun onTakePictureCanceled(context: Context, imageUri: Uri) {
        MediaProvider.deleteImage(context = context, imageUri = imageUri)
    }

}
```

## SmartCaptureStrategy

æ­¤ç­–ç•¥åŒæ—¶åŒ…å« FileProviderCaptureStrategy å’Œ MediaStoreCaptureStrategyï¼Œå› æ­¤å¤–éƒ¨ä¹Ÿéœ€è¦åƒ FileProviderCaptureStrategy ä¸€æ ·é…ç½® FileProviderï¼Œé€šè¿‡ authorities æ¥å®ä¾‹åŒ– SmartCaptureStrategy

- å½“ç³»ç»Ÿç‰ˆæœ¬å°äº Android 10 æ—¶ï¼Œæ‰§è¡Œ FileProviderCaptureStrategy ç­–ç•¥
- å½“ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äº Android 10 æ—¶ï¼Œæ‰§è¡Œ MediaStoreCaptureStrategy ç­–ç•¥

æ­¤ç­–ç•¥æ—¢æ— éœ€ç”³è¯·æƒé™ï¼Œåˆå¯ä»¥åœ¨ Android 10 å¼€å§‹ä¹‹åçš„ç³»ç»Ÿç‰ˆæœ¬å°†æ‹ç…§æ‰€å¾—ç…§ç‰‡å­˜å…¥åˆ°ç›¸å†Œä¸­ï¼ŒåŒæ—¶å¹³è¡¡äº† â€œæƒé™â€ å’Œ â€œç”¨æˆ·ä½“éªŒâ€

```kotlin
/**
 * æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬æ™ºèƒ½é€‰æ‹©æ‹ç…§ç­–ç•¥
 * æ—¢é¿å…éœ€è¦ç”³è¯·æƒé™ï¼Œåˆå¯ä»¥åœ¨ç³»ç»Ÿå…è®¸çš„æƒ…å†µä¸‹å°†æ‹ç…§æ‰€å¾—ç…§ç‰‡å­˜å…¥åˆ°ç³»ç»Ÿç›¸å†Œä¸­
 * å½“ç³»ç»Ÿç‰ˆæœ¬å°äº Android 10 æ—¶ï¼Œæ‰§è¡Œ FileProviderCaptureStrategy ç­–ç•¥
 * å½“ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äº Android 10 æ—¶ï¼Œæ‰§è¡Œ MediaStoreCaptureStrategy ç­–ç•¥
 */
@Parcelize
@Suppress("CanBeParameter")
class SmartCaptureStrategy(private val authority: String) : CaptureStrategy {

    @IgnoredOnParcel
    private val proxy = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
        MediaStoreCaptureStrategy()
    } else {
        FileProviderCaptureStrategy(authority = authority)
    }

    override fun isEnabled(): Boolean {
        return proxy.isEnabled()
    }

    override fun shouldRequestWriteExternalStoragePermission(context: Context): Boolean {
        return proxy.shouldRequestWriteExternalStoragePermission(context = context)
    }

    override suspend fun createImageUri(context: Context): Uri? {
        return proxy.createImageUri(context = context)
    }

    override suspend fun loadResource(context: Context, imageUri: Uri): MediaResource? {
        return proxy.loadResource(context = context, imageUri = imageUri)
    }

    override suspend fun onTakePictureCanceled(context: Context, imageUri: Uri) {
        proxy.onTakePictureCanceled(context = context, imageUri = imageUri)
    }

}
```

## æ€»ç»“

æ‰€ä»¥è¯´ï¼Œé™¤äº† NothingCaptureStrategy ä»£è¡¨ä¸å¼€å¯æ‹ç…§åŠŸèƒ½å¤–ï¼Œå…¶ä»–ä¸‰ç§ç­–ç•¥æ‰€éœ€è¦çš„æƒé™å’Œå›¾ç‰‡å­˜å‚¨çš„ä½ç½®éƒ½ä¸ä¸€æ ·ï¼Œå¯¹ç”¨æˆ·çš„æ„ŸçŸ¥ä¹Ÿä¸ä¸€æ ·

| æ‹ç…§ç­–ç•¥ | éœ€è¦çš„æƒé™ | é…ç½®é¡¹ | å›¾ç‰‡å¯¹ç”¨æˆ·æ˜¯å¦å¯è§ |
| --- | --- | --- | --- |
| NothingCaptureStrategy |  |  |  |
| FileProviderCaptureStrategy | æ—  | éœ€è¦é…ç½® FileProvider | å¦ï¼Œå›¾ç‰‡å­˜å‚¨åœ¨åº”ç”¨ç§æœ‰ç›®å½•å†…ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ |
| MediaStoreCaptureStrategy | Android 10 ä¹‹å‰éœ€è¦ WRITE_EXTERNAL_STORAGE æƒé™ï¼ŒAndroid 10 å¼€å§‹ä¸éœ€è¦æƒé™ | æ—  | æ˜¯ï¼Œå›¾ç‰‡å­˜å‚¨åœ¨ç³»ç»Ÿç›¸å†Œå†…ï¼Œå¯¹ç”¨æˆ·å¯è§ |
| SmartCaptureStrategy | æ—  | éœ€è¦é…ç½® FileProvider | åœ¨ Android 10 ä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬ä¸å¯è§ï¼Œå’Œ FileProviderCaptureStrategy ä¸€æ ·ã€‚åœ¨ Android 10 å¼€å§‹ä¹‹åçš„ç³»ç»Ÿç‰ˆæœ¬å¯è§ï¼Œå’Œ MediaStoreCaptureStrategy ä¸€æ · |


å¼€å‘è€…æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µæ¥é€‰æ‹©æ‹ç…§ç­–ç•¥ï¼š

- å¦‚æœåº”ç”¨æœ¬èº«å°±éœ€è¦ç”³è¯· WRITE_EXTERNAL_STORAGE æƒé™çš„è¯ï¼Œé€‰ MediaStoreCaptureStrategyï¼Œæ‹æ‘„çš„å›¾ç‰‡ä¼šä¿å­˜åœ¨ç³»ç»Ÿç›¸å†Œä¸­ä¹Ÿæ¯”è¾ƒç¬¦åˆç”¨æˆ·çš„è®¤çŸ¥
- å¦‚æœåº”ç”¨æœ¬èº«å°±ä¸éœ€è¦ç”³è¯· WRITE_EXTERNAL_STORAGE æƒé™çš„è¯ï¼Œé€‰ FileProviderCaptureStrategy æˆ–è€… SmartCaptureStrategyï¼Œä¸ºäº†ç›¸å†Œé—®é¢˜è€Œå¤šç”³è¯·ä¸€ä¸ªæ•æ„Ÿæƒé™å¾—ä¸å¿å¤±

# æ‹ç…§æƒé™

Android ç³»ç»Ÿçš„ CAMERA æƒé™ç”¨äºè‡ªå®šä¹‰å®ç°ç›¸æœºåŠŸèƒ½çš„ä¸šåŠ¡åœºæ™¯ï¼Œä¹Ÿå³å¦‚æœä½¿ç”¨åˆ°äº† Camera API çš„è¯ï¼Œåº”ç”¨å°±å¿…é¡»å£°æ˜å’Œç”³è¯· CAMERA æƒé™

è€Œè°ƒèµ·ç³»ç»Ÿç›¸æœºè¿›è¡Œæ‹ç…§ä¸å±äºè‡ªå®šä¹‰å®ç°ï¼Œå› æ­¤è¯¥æ“ä½œæœ¬èº«æ˜¯ä¸è¦æ±‚ CAMERA æƒé™çš„ï¼Œä½†æ˜¯å¦çœŸçš„ä¸éœ€è¦ç”³è¯·æƒé™è¦æ ¹æ®å®é™…æƒ…å†µè€Œå®š

Android ç³»ç»Ÿå¯¹äº CAMERA æƒé™æœ‰ç€æ¯”è¾ƒå¥‡æ€ªçš„è¦æ±‚ï¼š

- åº”ç”¨å¦‚æœæ²¡æœ‰å£°æ˜ CAMERA æƒé™ï¼Œæ­¤æ—¶è°ƒèµ·ç³»ç»Ÿç›¸æœºä¸éœ€è¦ç”³è¯·ä»»ä½•æƒé™
- åº”ç”¨å¦‚æœæœ‰å£°æ˜ CAMERA æƒé™ï¼Œå°±å¿…é¡»ç­‰åˆ°ç”¨æˆ·åŒæ„äº† CAMERA æƒé™åæ‰èƒ½è°ƒèµ·ç³»ç»Ÿç›¸æœºï¼Œå¦åˆ™å°†ç›´æ¥æŠ›å‡º SecurityException

å› æ­¤ï¼Œè™½ç„¶ Matisse æœ¬èº«æ˜¯é€šè¿‡è°ƒèµ·ç³»ç»Ÿç›¸æœºæ¥å®ç°æ‹ç…§çš„ï¼Œä½†å¦‚æœå¼•ç”¨æ–¹å£°æ˜äº† CAMERA æƒé™çš„è¯ï¼Œå°†è¿é”å¯¼è‡´ Matisse ä¹Ÿå¿…é¡»ç”³è¯· CAMERA æƒé™

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒMatisse é€šè¿‡æ£€æŸ¥åº”ç”¨çš„ Manifest æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å« CAMERA æƒé™æ¥å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œç”³è¯·ï¼Œé¿å…ç”±äºæ„å¤–è€Œå¥”æºƒ

```kotlin
private fun requestCameraPermissionIfNeed() {
    val cameraPermission = Manifest.permission.CAMERA
    if (PermissionUtils.containsPermission(
            context = this,
            permission = cameraPermission
        ) && !PermissionUtils.checkSelfPermission(context = this, permission = cameraPermission)
    ) {
        requestCameraPermissionLauncher.launch(cameraPermission)
    } else {
        takePicture()
    }
}

internal object PermissionUtils {

    /**
     * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™
     */
    fun checkSelfPermission(context: Context, permission: String): Boolean {
        return ActivityCompat.checkSelfPermission(
            context,
            permission
        ) == PackageManager.PERMISSION_GRANTED
    }

    /**
     * æ£€æŸ¥åº”ç”¨æ˜¯å¦å£°æ˜äº†æŒ‡å®šæƒé™
     */
    fun containsPermission(context: Context, permission: String): Boolean {
        try {
            val packageManager: PackageManager = context.packageManager
            val packageInfo = packageManager.getPackageInfo(
                context.packageName,
                PackageManager.GET_PERMISSIONS
            )
            val permissions = packageInfo.requestedPermissions
            if (!permissions.isNullOrEmpty()) {
                return permissions.contains(permission)
            }
        } catch (e: Throwable) {
            e.printStackTrace()
        }
        return false
    }

}
```

# å–æ¶ˆæ‹ç…§å¯¼è‡´çš„è„æ•°æ®

åœ¨æ–‡ç« å¼€å¤´ç»™å‡ºæ¥çš„çŸ¥ä¹ App ç¤ºä¾‹å›¾ç‰‡ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒPictures ç›®å½•æ˜æ˜æ˜¾ç¤ºæœ‰ä¸‰å¼ å›¾ç‰‡ï¼Œä½†ç‚¹å‡»è¿›å»åˆå‘ç°ç›®å½•æ˜¯ç©ºçš„ã€‚è¿™æ˜¯ç”±äº MediaStore ä¸­å­˜åœ¨è„æ•°æ®å¯¼è‡´çš„

å½“åº”ç”¨é€šè¿‡ MediaStoreCaptureStrategy æ¥å¯åŠ¨ç›¸æœºæ—¶ï¼Œå·²ç»å…ˆå‘ MediaStore æ’å…¥ä¸€æ¡å›¾ç‰‡æ•°æ®äº†ï¼Œä½†å¦‚æœç”¨æˆ·æ­¤æ—¶åˆå–æ¶ˆäº†æ‹ç…§ï¼Œå°±ä¼šå¯¼è‡´ MediaStore ä¸­å­˜åœ¨ä¸€æ¡è„æ•°æ®ï¼šè¯¥æ•°æ®æœ‰ idã€uriã€pathã€displayName ç­‰ä¿¡æ¯ï¼Œä½†å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶å®é™…ä¸Šå¹¶ä¸å­˜åœ¨ã€‚çŸ¥ä¹ App åº”è¯¥æ˜¯ä¸€å¼€å§‹åœ¨å½’ç±»å›¾ç‰‡ç›®å½•çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥å›¾ç‰‡æ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œç­‰åˆ°è¦åŠ è½½å›¾ç‰‡çš„æ—¶å€™æ‰å‘ç°å›¾ç‰‡ä¸å¯ç”¨

è™½ç„¶ MediaStoreCaptureStrategy ä¼šä¸»åŠ¨åˆ é™¤è‡ªå·±ç”Ÿæˆçš„è„æ•°æ®ï¼Œä½†æˆ‘ä»¬æ²¡æ³•ç¡®ä¿å…¶å®ƒåº”ç”¨å°±ä¸ä¼šå‘ MediaStore æ’å…¥è„æ•°æ®ã€‚å› æ­¤ï¼ŒMatisse ä¼šåœ¨éå†æŸ¥è¯¢æ‰€æœ‰å›¾ç‰‡çš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶åˆ¤æ–­è¯¥å›¾ç‰‡æŒ‡å‘çš„æ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œæœ‰çš„è¯æ‰è¿›è¡Œå±•ç¤º

```kotlin
mediaCursor.use { cursor ->
    while (cursor.moveToNext()) {
        val data = cursor.getString(MediaStore.Images.Media.DATA)
        if (data.isBlank() || !File(data).exists()) {
            continue
        }
        //TODO
    }
}
```

# resolveActivity API çš„å…¼å®¹æ€§

å½“æˆ‘ä»¬è¦éšå¼å¯åŠ¨ä¸€ä¸ª Activity çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…ç”±äºç›®æ ‡ Activity ä¸å­˜åœ¨è€Œå¯¼è‡´åº”ç”¨å´©æºƒï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ startActivity å‰å…ˆåˆ¤æ–­è¯¥éšå¼å¯åŠ¨æ˜¯å¦æœ‰æ¥æ”¶è€…ï¼Œæœ‰çš„è¯æ‰å»è°ƒç”¨ startActivity

Matisse åœ¨å¯åŠ¨ç³»ç»Ÿç›¸æœºçš„æ—¶å€™ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¼šå…ˆé€šè¿‡ `resolveActivity` æ–¹æ³•æŸ¥è¯¢ç³»ç»Ÿä¸­æ˜¯å¦æœ‰åº”ç”¨å¯ä»¥å¤„ç†æ‹ç…§è¯·æ±‚ï¼Œæœ‰çš„è¯æ‰å»å¯åŠ¨ç›¸æœºï¼Œé¿å…ç”±äºè®¾å¤‡æ²¡æœ‰æ‘„åƒå¤´è€Œå¯¼è‡´åº”ç”¨å´©æºƒ

```kotlin
private fun takePicture() {
    lifecycleScope.launch(context = Dispatchers.Main.immediate) {
        tempImageUriForTakePicture = null
        val captureIntent = Intent(MediaStore.ACTION_IMAGE_CAPTURE)
        if (captureIntent.resolveActivity(packageManager) != null) {
            val imageUri = captureStrategy.createImageUri(context = applicationContext)
            if (imageUri != null) {
                tempImageUriForTakePicture = imageUri
                takePictureLauncher.launch(imageUri)
                return@launch
            }
        }
        canceled()
    }
}
```

ä½† `resolveActivity` æ–¹æ³•åœ¨ Android 11 å’Œæ›´é«˜çš„ç³»ç»Ÿä¸Šä¹Ÿæœ‰ç€ä¸€ä¸ªå…¼å®¹æ€§é—®é¢˜ï¼šè½¯ä»¶åŒ…å¯è§æ€§è¿‡æ»¤

å¦‚æœåº”ç”¨çš„ç›®æ ‡å¹³å°æ˜¯ Android 11 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå½“åº”ç”¨é€šè¿‡ `queryIntentActivities()ã€getPackageInfo()ã€getInstalledApplications()` ç­‰æ–¹æ³•æŸ¥è¯¢è®¾å¤‡ä¸Šå·²å®‰è£…çš„å…¶å®ƒåº”ç”¨ç›¸å…³ä¿¡æ¯æ—¶ï¼Œç³»ç»Ÿä¼šé»˜è®¤å¯¹è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡è¿™äº›æ–¹æ³•æŸ¥è¯¢åˆ°çš„åº”ç”¨ä¿¡æ¯ä¼šå°‘äºè®¾å¤‡ä¸ŠçœŸå®å®‰è£…çš„åº”ç”¨æ•°ã€‚`resolveActivity` æ–¹æ³•ä¹Ÿå—åˆ°æ­¤å½±å“ï¼Œç»æµ‹è¯•ï¼Œåœ¨ Android 11 å’Œ Android 12 çš„æ¨¡æ‹Ÿå™¨ä¸Šï¼ŒresolveActivity æ–¹æ³•å‡ä¼šè¿”å› nullï¼Œä½†åœ¨ä¸€å° Android 12 çš„çœŸæœºä¸Šè¿”å›å€¼åˆ™ä¸ä¸º nullï¼Œå› ä¸ºä¸åŒè®¾å¤‡ä¼šæ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µæ¥å†³å®šå“ªäº›å®ç° Android æ ¸å¿ƒåŠŸèƒ½çš„ç³»ç»ŸæœåŠ¡å¯¹æ‰€æœ‰åº”ç”¨å‡å¯è§

Matisse çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šåœ¨ Manifest æ–‡ä»¶ä¸­é€šè¿‡ `queries` ä¸»åŠ¨å£°æ˜ IMAGE_CAPTUREï¼Œä»è€Œæé«˜å¯¹æ­¤ action çš„å¯è§æ€§

```kotlin
<queries>
    <intent>
        <action android:name="android.media.action.IMAGE_CAPTURE" />
    </intent>
</queries>
```

# File API çš„å…¼å®¹æ€§

ä¸¥æ ¼æ¥è¯´ï¼ŒFile API çš„å…¼å®¹æ€§å¹¶ä¸å±äº Matisse é‡åˆ°çš„é—®é¢˜ï¼Œè€Œæ˜¯å¤–éƒ¨ä½¿ç”¨è€…ä¼šé‡åˆ°çš„é—®é¢˜

ä» Android 10 å¼€å§‹ï¼Œç³»ç»Ÿæ¨å‡ºäº†åˆ†åŒºå­˜å‚¨çš„ç‰¹æ€§ï¼Œé™åˆ¶äº†åº”ç”¨è¯»å†™å…±äº«æ–‡ä»¶çš„æ–¹å¼ã€‚å½“åº”ç”¨å¼€å¯åˆ†åŒºå­˜å‚¨ç‰¹æ€§åï¼Œå¯¹å…±äº«æ–‡ä»¶çš„è¯»å†™éœ€è¦é€šè¿‡ MediaStore æ¥å®ç°ï¼Œè€Œä¸èƒ½ä½¿ç”¨ä»¥å‰å¸¸ç”¨çš„ File APIï¼Œå¦åˆ™å°†ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼š`FileNotFoundException open failed: EACCES (Permission denied)`

ä¾‹å¦‚ï¼Œåƒ Glideã€Coil ç­‰å›¾ç‰‡æ¡†æ¶å‡æ”¯æŒé€šè¿‡ ByteArray æ¥åŠ è½½å›¾ç‰‡ï¼Œå¯¹äºå¼€å¯äº†åˆ†åŒºå­˜å‚¨ç‰¹æ€§çš„åº”ç”¨ï¼Œåœ¨ Android 10 ç³»ç»Ÿä¹‹å‰ï¼Œä»¥ä¸‹æ–¹å¼æ˜¯å®Œå…¨å¯ç”¨çš„ï¼Œä½†åœ¨ Android 10 ç³»ç»Ÿä¸Šå°±ä¼šç›´æ¥å´©æºƒ

```kotlin
val filePath: String = xxx
imageView.load(File(filePath).readBytes())
```

è€Œåˆ°äº† Android 11 åï¼ŒGoogle å¯èƒ½è§‰å¾—è¿™ç§é™åˆ¶å¯¹äºåº”ç”¨æ¥è¯´è¿‡äºä¸¥æ ¼ï¼Œå› æ­¤åˆå–æ¶ˆäº†é™åˆ¶ï¼Œå…è®¸åº”ç”¨ç»§ç»­é€šè¿‡ File API æ¥è¯»å†™å…±äº«æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°† File API é‡å®šå‘ä¸º MediaStore APIï¼Œç¨ç¨æœ‰ç‚¹æ— è¯­â€¦â€¦

å› æ­¤ï¼Œè™½ç„¶ Matisse çš„è¿”å›å€¼ä¸­åŒ…å«äº†å›¾ç‰‡çš„ç»å¯¹è·¯å¾„ pathï¼Œä½†å¦‚æœå¤–éƒ¨å¼€å¯äº†åˆ†åŒºå­˜å‚¨ç‰¹æ€§çš„è¯ï¼Œåœ¨ Android 10 è®¾å¤‡ä¸Šæ˜¯ä¸èƒ½ç›´æ¥é€šè¿‡ File API æ¥è¯»å†™å…±äº«æ–‡ä»¶çš„ï¼Œåœ¨å…¶å®ƒç³»ç»Ÿç‰ˆæœ¬ä¸Šåˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨

# Github

ä»¥ä¸Šå°±æ˜¯ Matisse çš„ä¸€äº›å®ç°ç»†èŠ‚å’Œé‡åˆ°çš„ç³»ç»Ÿå…¼å®¹æ€§é—®é¢˜ï¼Œæ›´å¤šå®ç°ç»†èŠ‚è¯·çœ‹ Githubï¼š[Matisse](https://github.com/leavesCZY/Matisse)

Matisse åŒæ—¶ä¹Ÿå‘å¸ƒåˆ°äº† Jitpackï¼Œæ–¹ä¾¿å¼€å‘è€…ç›´æ¥è¿œç¨‹ä¾èµ–ä½¿ç”¨ï¼š

```kotlin
allprojects {
    repositories {
        maven { url "https://jitpack.io" }
    }
}

dependencies {
    implementation 'com.github.leavesCZY:Matisse:latestVersion'
}
```
